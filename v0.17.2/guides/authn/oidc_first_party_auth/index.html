<!doctype html><html lang=en><head><title>First-Party Authentication with OpenID Connect</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="An open source Identity Aware Proxy and an Access Control Decision service for cloud native applications"><meta name=dc.relation content="https://dadrus.github.io/"><meta name=theme-color content="#1A94D2"><link rel=stylesheet href=../../../css/styles.min.css media=screen><link rel='shortcut icon' type=image/x-icon href=../../../favicon.ico></head><body><header class="navbar navbar-expand-md navbar-dark bg-dark sticky-top"><nav class="container-xxl flex-wrap flex-lg-nowrap px-0" aria-label="Main navigation"><button class="btn btn-outline-dark d-lg-none navbar-toggler border-0 shadow-none ps-3" type=button data-bs-toggle=offcanvas data-bs-target=#docsMenuContent aria-controls=docsMenuContent aria-expanded=false aria-label="Open docs menu">
<svg width="36" height="36" fill="currentColor" class="bi bi-list" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.5 12a.5.5.0 01.5-.5h10a.5.5.0 010 1H3a.5.5.0 01-.5-.5m0-4a.5.5.0 01.5-.5h10a.5.5.0 010 1H3A.5.5.0 012.5 8m0-4a.5.5.0 01.5-.5h10a.5.5.0 010 1H3A.5.5.0 012.5 4"/></svg></button><nav class="offcanvas offcanvas-start d-md-none text-bg-light" tabindex=-1 id=docsMenuContent aria-labelledby=docsMenuContentLabel><div class=offcanvas-header><h5 class=offcanvas-title id=docsMenuContentLabel>Browse guides</h5><button type=button class=btn-close data-bs-dismiss=offcanvas aria-label="Close docs menu"></button></div><div class="offcanvas-body docs-sidebar"><div class=docs-search-button><button type=button class="btn btn-outline-secondary mb-3 d-none d-md-block w-100 text-start" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search">
<svg width="20" height="20" fill="currentColor" class="bi bi-search me-2" viewBox="0 0 20 20"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg>
<span>Quick search...</span></button></div><nav id=SideBarToc><ul><li><span>API Gateways & Proxies</span><ul><li><a href=../../../guides/proxies/caddy/>Caddy Integration</a></li><li><a href=../../../guides/proxies/contour/>Contour Integration</a></li><li><a href=../../../guides/proxies/emissary/>Emissary Ingress Integration</a></li><li><a href=../../../guides/proxies/envoy/>Envoy Integration</a></li><li><a href=../../../guides/proxies/envoy_gateway/>Envoy Gateway Integration</a></li><li><a href=../../../guides/proxies/haproxy/>HAProxy Integration</a></li><li><a href=../../../guides/proxies/istio/>Istio Service Mesh Integration</a></li><li><a href=../../../guides/proxies/nginx/>NGINX Integration</a></li><li><a href=../../../guides/proxies/traefik/>Traefik Proxy Integration</a></li></ul></li><li><span>Authorization Services</span><ul><li><a href=../../../guides/authz/opa/>Integration with OPA</a></li><li><a href=../../../guides/authz/openfga/>Integration with OpenFGA</a></li></ul></li><li><span>Authentication Protocols & Services</span><ul><li><a class=active href=../../../guides/authn/oidc_first_party_auth/>First-Party Authentication with OpenID Connect</a></li></ul></li></ul></nav></div></nav><div class="d-flex align-items-center px-4"><a class="navbar-brand navbar-brand-highlight text-white me-0" href=../../../ style=font-weight:500;font-size:1.5rem>Heimdall</a><ul class="navbar-nav d-none d-md-flex ms-3"><li class=nav-item><a class='nav-link text-white' href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=nav-item><a class='nav-link text-white active' href=../../../guides/>Guides</a></li><li class=nav-item><a class='nav-link text-white' href=../../../openapi/>API</a></li></ul></div><div class=d-flex><button type=button class="btn btn-outline-dark navbar-toggler border-0 shadow-none" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search">
<span class="bi bi-search"></span>
</button>
<button class="btn btn-outline-dark navbar-toggler border-0 shadow-none pe-3" type=button data-bs-toggle=offcanvas data-bs-target=#mainMenuContent aria-controls=mainMenuContent aria-expanded=false aria-label="Open main menu">
<svg width="24" height="24" fill="currentColor" class="bi bi-three-dots" viewBox="0 0 16 16"><path d="M3 9.5a1.5 1.5.0 110-3 1.5 1.5.0 010 3m5 0a1.5 1.5.0 110-3 1.5 1.5.0 010 3m5 0a1.5 1.5.0 110-3 1.5 1.5.0 010 3"/></svg></button><div class="offcanvas offcanvas-end text-bg-dark" tabindex=-1 id=mainMenuContent aria-labelledby=mainMenuContentLabel><div class=offcanvas-header><h5 class="offcanvas-title text-white" id=mainMenuContentLabel>Heimdall</h5><button type=button class="btn-close btn-close-white" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class=offcanvas-body><ul class="navbar-nav flex-column d-md-none d-lg-none d-xl-none"><li class=nav-item><a class='nav-link text-white' href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=nav-item><a class='nav-link text-white active' href=../../../guides/>Guides</a></li><li class=nav-item><a class='nav-link text-white' href=../../../openapi/>API</a></li></ul><hr class="text-white-50 d-md-none"><ul class="navbar-nav flex-column ms-auto"><doc-version-select class="nav-item dropdown" version-file=/heimdall/data.json current-version=v0.17.2 current-page=/guides/authn/oidc_first_party_auth/><button class="btn btn-dark dropdown-toggle me-4" data-bs-toggle=dropdown aria-expanded=false>
v0.17.2</button></doc-version-select></ul><ul class="navbar-nav flex-column"><li class="nav-item mb-1 pe-4"><a class="nav-link text-white" style=align-self:center href=https://github.com/dadrus/heimdall><svg role="img" width="20" height="20" fill="currentColor" class="bi bi-github text-white" viewBox="0 0 16 16"><title>GitHub</title><path d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.012 8.012.0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
<small class="ms-2 d-md-none">GitHub</small></a></li></ul></div></div></div></nav></header><div class=modal id=docSearch tabindex=-1 aria-labelledby=docSearchLabel aria-hidden=true><doc-search class="col-auto me-auto mw-75" index-file=/heimdall/v0.17.2/index.json path-prefix=/heimdall/v0.17.2><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class=modal-content><div class="modal-header p-2"><div class=input-group><div class="input-group-text bg-body border-0 fs-4"><svg width="16" height="16" fill="currentColor" class="bi bi-search text-secondary my-0" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg></div><input id=search-input class="form-control search-bar border-0" type=search placeholder="Search documentation " aria-label="Search docs..." autocomplete=off autofocus><div class="input-group-text bg-body border-0"><a class="btn input-group-text text-muted border p-1 bg-light-subtle fs-7 fw-bold font-monospace" data-bs-dismiss=modal aria-label=Close>ESC</a></div></div></div><div class=modal-body><div class=search-results><p class="text-center mt-5">No recent searches</p></div></div><div class=modal-footer></div></div></div></doc-search></div><div class="container-xxl docs-layout px-4"><aside class="d-none pe-3 docs-sidebar"><div class=docs-search-button><button type=button class="btn btn-outline-secondary mb-3 d-none d-md-block w-100 text-start" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search">
<svg width="20" height="20" fill="currentColor" class="bi bi-search me-2" viewBox="0 0 20 20"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg>
<span>Quick search...</span></button></div><nav id=SideBarToc><ul><li><span>API Gateways & Proxies</span><ul><li><a href=../../../guides/proxies/caddy/>Caddy Integration</a></li><li><a href=../../../guides/proxies/contour/>Contour Integration</a></li><li><a href=../../../guides/proxies/emissary/>Emissary Ingress Integration</a></li><li><a href=../../../guides/proxies/envoy/>Envoy Integration</a></li><li><a href=../../../guides/proxies/envoy_gateway/>Envoy Gateway Integration</a></li><li><a href=../../../guides/proxies/haproxy/>HAProxy Integration</a></li><li><a href=../../../guides/proxies/istio/>Istio Service Mesh Integration</a></li><li><a href=../../../guides/proxies/nginx/>NGINX Integration</a></li><li><a href=../../../guides/proxies/traefik/>Traefik Proxy Integration</a></li></ul></li><li><span>Authorization Services</span><ul><li><a href=../../../guides/authz/opa/>Integration with OPA</a></li><li><a href=../../../guides/authz/openfga/>Integration with OpenFGA</a></li></ul></li><li><span>Authentication Protocols & Services</span><ul><li><a class=active href=../../../guides/authn/oidc_first_party_auth/>First-Party Authentication with OpenID Connect</a></li></ul></li></ul></nav></aside><main class=docs-main><div class="d-md-none docs-location bg-body"><nav style="--bs-breadcrumb-divider:'>'" aria-label=breadcrumb><ol class="breadcrumb mb-0"><li class="breadcrumb-item fw-bold">Authentication Protocols & Services</li><li class="breadcrumb-item active" aria-current=page>First-Party Authentication with OpenID Connect</li></ol></nav></div><div class="docs-intro pt-3 pe-3"><h1>First-Party Authentication with OpenID Connect</h1><p>This guide will walk you through the process of integrating heimdall with an OpenID Connect provider to implement first-party authentication.</p></div><aside class="text-muted docs-toc"><strong class="d-md-block h6 pb-2 my-2 ms-2 border-bottom d-none d-md-none d-lg-block">On this page</strong><div id=page-content-toc class="mt-1 mb-3 text-muted d-none d-md-none d-lg-block docs-toc-content"><nav id=TableOfContents><ul><li><a href=#_overview>Overview</a></li><li><a href=#_prerequisites>Prerequisites</a></li><li><a href=#_configure_the_base_setup>Configure the Base Setup</a></li><li><a href=#_create_a_realm_and_a_client_in_keycloak>Create a Realm and a Client in Keycloak</a></li><li><a href=#_update_oauth2_proxy_configuration>Update OAuth2-Proxy Configuration</a></li><li><a href=#_use_the_setup>Use the Setup</a></li><li><a href=#_cleanup>Cleanup</a></li></ul></nav></div><button class="btn btn-outline-secondary text-decoration-none d-lg-none collapsed" type=button data-bs-toggle=collapse data-bs-target=#page-content-toc-collapsible aria-expanded=false aria-controls=page-content-toc-collapsible>
On this page
<svg width="16" height="16" fill="currentColor" class="bi bi-chevron-expand" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M3.646 9.146a.5.5.0 01.708.0L8 12.793l3.646-3.647a.5.5.0 01.708.708l-4 4a.5.5.0 01-.708.0l-4-4a.5.5.0 010-.708m0-2.292a.5.5.0 00.708.0L8 3.207l3.646 3.647a.5.5.0 00.708-.708l-4-4a.5.5.0 00-.708.0l-4 4a.5.5.0 000 .708"/></svg></button><div id=page-content-toc-collapsible class="mt-1 mb-3 text-muted d-lg-none collapse docs-toc-content"><div class="card card-body"><nav id=TableOfContents><ul><li><a href=#_overview>Overview</a></li><li><a href=#_prerequisites>Prerequisites</a></li><li><a href=#_configure_the_base_setup>Configure the Base Setup</a></li><li><a href=#_create_a_realm_and_a_client_in_keycloak>Create a Realm and a Client in Keycloak</a></li><li><a href=#_update_oauth2_proxy_configuration>Update OAuth2-Proxy Configuration</a></li><li><a href=#_use_the_setup>Use the Setup</a></li><li><a href=#_cleanup>Cleanup</a></li></ul></nav></div></div></aside><div class="docs-content pe-3"><div data-bs-spy=scroll data-bs-target=#page-content-toc class=mt-3><linkable-headline-area><div class=paragraph><p>By the end of this guide, you’ll have a functional setup where heimdall uses <a href=https://www.keycloak.org/>Keycloak</a> to authenticate users and route requests based on their authentication status and roles for role-based access control.</p></div><div class=paragraph><p>Although this guide uses Keycloak as identity provider (IDP), you can achieve the same results with <a href=https://zitadel.com>Zitadel</a>, <a href=https://github.com/malach-it/boruta-server>Boruta</a>, or any other OpenID Connect compatible IDP.</p></div><div class=sect1><h2 id=_overview>Overview</h2><div class=sectionbody><div class=paragraph><p>In this guide, we’ll set up a Docker Compose environment where heimdall secures services and controls access for specific endpoints:</p></div><div class=ulist><ul><li><p><code>/</code> - This endpoint is open to everyone.</p></li><li><p><code>/user</code> - Accessible only to authenticated users.</p></li><li><p><code>/admin</code> - Accessible only to users with the <code>admin</code> role.</p></li></ul></div><div class=paragraph><p>There are also some further endpoints, which you’ll learn about during the setup.</p></div><div class=paragraph><p>Technically, the setup includes:</p></div><div class=ulist><ul><li><p><a href=https://hub.docker.com/r/traefik/whoami/>traefik/whoami</a> - A service that echoes back everything it receives, simulating our main service, which exposes the endpoints defined above.</p></li><li><p><a href=https://www.keycloak.org/>Keycloak</a> - Our identity provider.</p></li><li><p><a href=https://oauth2-proxy.github.io/oauth2-proxy/>OAuth2-Proxy</a> - Handles the <a href=https://tools.ietf.org/html/rfc6749#section-4.1>Authorization Code Grant flow</a> for the actual user login.</p></li><li><p>heimdall - Enforces all the requirements outlined above.</p></li></ul></div></div></div><div class=sect1><h2 id=_prerequisites>Prerequisites</h2><div class=sectionbody><div class=paragraph><p>To be able to follow this guide you need the following tools installed locally:</p></div><div class=ulist><ul><li><p><a href=https://docs.docker.com/install/>Docker</a>,</p></li><li><p><a href=https://docs.docker.com/compose/install/>docker-compose</a></p></li></ul></div></div></div><div class=sect1><h2 id=_configure_the_base_setup>Configure the Base Setup</h2><div class=sectionbody><div class="olist arabic"><ol class=arabic><li><p>Create a directory for the configuration files (referred to as the root directory in this guide). Inside this root directory, create two additional directories named <code>rules</code> and <code>initdb</code>. The former will be used for heimdall rules and the latter for DB initialization scripts.</p></li><li><p>Create a config file for heimdall named <code>heimdall-config.yaml</code> with the following contents in the root directory:</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>log</span><span class=pi>:</span> <i class=conum data-value=1></i><b>(1)</b>
  <span class=na>level</span><span class=pi>:</span> <span class=s>debug</span>

<span class=na>tracing</span><span class=pi>:</span>
  <span class=na>enabled</span><span class=pi>:</span> <span class=kc>false</span>

<span class=na>metrics</span><span class=pi>:</span>
  <span class=na>enabled</span><span class=pi>:</span> <span class=kc>false</span>

<span class=na>mechanisms</span><span class=pi>:</span> <i class=conum data-value=2></i><b>(2)</b>
  <span class=na>authenticators</span><span class=pi>:</span>
  <span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>deny_all</span> <i class=conum data-value=3></i><b>(3)</b>
    <span class=na>type</span><span class=pi>:</span> <span class=s>unauthorized</span>
  <span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>anon</span> <i class=conum data-value=4></i><b>(4)</b>
    <span class=na>type</span><span class=pi>:</span> <span class=s>anonymous</span>
  <span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>auth</span> <i class=conum data-value=5></i><b>(5)</b>
    <span class=na>type</span><span class=pi>:</span> <span class=s>generic</span>
    <span class=na>config</span><span class=pi>:</span>
      <span class=na>identity_info_endpoint</span><span class=pi>:</span> <span class=s>http://oauth2-proxy:4180/oauth2/userinfo</span>
      <span class=na>authentication_data_source</span><span class=pi>:</span>
        <span class=pi>-</span> <span class=na>cookie</span><span class=pi>:</span> <span class=s>SESSION</span>
      <span class=na>forward_cookies</span><span class=pi>:</span>
        <span class=pi>-</span> <span class=s>SESSION</span>
      <span class=na>subject</span><span class=pi>:</span>
        <span class=na>id</span><span class=pi>:</span> <span class=s2>&#34;</span><span class=s>user&#34;</span>

  <span class=na>authorizers</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>cel</span> <i class=conum data-value=6></i><b>(6)</b>
      <span class=na>type</span><span class=pi>:</span> <span class=s>cel</span>
      <span class=na>config</span><span class=pi>:</span>
        <span class=na>expressions</span><span class=pi>:</span>
          <span class=pi>-</span> <span class=na>expression</span><span class=pi>:</span> <span class=s2>&#34;</span><span class=s>true</span><span class=nv> </span><span class=s>==</span><span class=nv> </span><span class=s>false&#34;</span>

  <span class=na>finalizers</span><span class=pi>:</span>
  <span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>create_jwt</span> <i class=conum data-value=7></i><b>(7)</b>
    <span class=na>type</span><span class=pi>:</span> <span class=s>jwt</span>
    <span class=na>config</span><span class=pi>:</span>
      <span class=na>signer</span><span class=pi>:</span>
        <span class=na>key_store</span><span class=pi>:</span>
          <span class=na>path</span><span class=pi>:</span> <span class=s>/etc/heimdall/signer.pem</span>
      <span class=na>claims</span><span class=pi>:</span> <span class=pi>|</span>
        <span class=s>{{- dict &#34;attrs&#34; .Subject.Attributes | toJson -}}</span>
  <span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>noop</span> <i class=conum data-value=8></i><b>(8)</b>
    <span class=na>type</span><span class=pi>:</span> <span class=s>noop</span>

  <span class=na>error_handlers</span><span class=pi>:</span> <i class=conum data-value=9></i><b>(9)</b>
    <span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>redirect_to_idp</span>
      <span class=na>type</span><span class=pi>:</span> <span class=s>redirect</span>
      <span class=na>config</span><span class=pi>:</span>
        <span class=na>to</span><span class=pi>:</span> <span class=s>http://127.0.0.1:9090/oauth2/start?rd={{ .Request.URL | urlenc }}</span>
    <span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>redirect_to_error_page</span>
      <span class=na>type</span><span class=pi>:</span> <span class=s>redirect</span>
      <span class=na>config</span><span class=pi>:</span>
        <span class=na>to</span><span class=pi>:</span> <span class=s>https://www.google.com/search?q=access+denied&amp;udm=2</span>

<span class=na>default_rule</span><span class=pi>:</span> <i class=conum data-value=10></i><b>(10)</b>
  <span class=na>execute</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>authenticator</span><span class=pi>:</span> <span class=s>deny_all</span>
    <span class=pi>-</span> <span class=na>finalizer</span><span class=pi>:</span> <span class=s>create_jwt</span>
  <span class=na>on_error</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>error_handler</span><span class=pi>:</span> <span class=s>redirect_to_error_page</span>
      <span class=na>if</span><span class=pi>:</span> <span class=pi>|</span>
        <span class=s>type(Error) in [authorization_error, authentication_error] &amp;&amp;</span>
        <span class=s>Request.Header(&#34;Accept&#34;).contains(&#34;text/html&#34;)</span>

<span class=na>providers</span><span class=pi>:</span> <i class=conum data-value=11></i><b>(11)</b>
  <span class=na>file_system</span><span class=pi>:</span>
    <span class=na>src</span><span class=pi>:</span> <span class=s>/etc/heimdall/rules</span>
    <span class=na>watch</span><span class=pi>:</span> <span class=kc>true</span></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>By default, heimdall emits logs on <code>error</code> level, but to better understand its operations, we’re setting the log level to <code>debug</code>. This way, you’ll see not only the results of rule executions (which is what you would see if we set the log level to <code>info</code>), but also detailed information about what’s happening within each rule. We’re also disabling tracing and metrics collection to avoid errors related to the missing OTEL agent, which is used by default. For more details on logging and other observability options, see the <a href=../../../docs/operations/observability/#_logging>Observability</a> chapter.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>We define our <a href=../../../docs/mechanisms/catalogue/>catalogue of mechanisms</a> for use in our <a href=../../../docs/rules/default_rule/>default rule</a> and <a href=../../../docs/rules/regular_rule/>upstream service-specific rules</a>.</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>These lines define the <code>unauthorized</code> authenticator, named <code>deny_all</code>, which rejects all requests.</td></tr><tr><td><i class=conum data-value=4></i><b>4</b></td><td>These lines define the <code>anonymous</code> authenticator, named <code>anon</code>, which allows all requests and creates a subject with the ID set to <code>anonymous</code>. More information about subjects and other objects can be found <a href=../../../docs/mechanisms/evaluation_objects/#_subject>here</a>.</td></tr><tr><td><i class=conum data-value=5></i><b>5</b></td><td>These and the following lines set up the <code>generic</code> authenticator, named <code>auth</code>. This configuration checks if a request includes a <code>Cookie</code> named <code>SESSION</code>, and then sends it to the <code>http://oauth2-proxy:4180/oauth2/userinfo</code> endpoint to get user information. If successful, heimdall extracts the user identifier from the <code>user</code> property in the response. If there’s an error (e.g. the <code>SESSION</code> cookie is not present or the response from the OAuth2-Proxy contains an error), an authentication error is triggered.</td></tr><tr><td><i class=conum data-value=6></i><b>6</b></td><td>These lines define a <code>cel</code> authorizer that is configured to always fail. We’ll improve this in our upstream-specific rule.</td></tr><tr><td><i class=conum data-value=7></i><b>7</b></td><td>These lines define the <code>jwt</code> finalizer. It creates a JWT from the subject object with standard claims, setting the <code>sub</code> claim to the subject’s ID. The key for signing the JWT comes from a key store we’ll configure later.</td></tr><tr><td><i class=conum data-value=8></i><b>8</b></td><td>These two lines define the <code>noop</code> finalizer, which we’ll use for public endpoints.</td></tr><tr><td><i class=conum data-value=9></i><b>9</b></td><td>Here, we set up two <code>redirect</code> error handlers: one redirects to the <code>/oauth2/start</code> endpoint with a deep link to the current URL, and the other redirects to Google with the search query "access denied".</td></tr><tr><td><i class=conum data-value=10></i><b>10</b></td><td>With all mechanisms defined, we configure our first rule - the <a href=../../../docs/rules/default_rule/>default rule</a>. This rule applies if no other rules match the request and serves as a <a href=../../../docs/concepts/rules/#_default_rule_inheritance>base</a> for defining regular (upstream service-specific) rules as well. It sets up a default <a href=../../../docs/concepts/pipelines/#_authentication_authorization_pipeline>authentication & authorization pipeline</a> that rejects all requests using the <code>deny_all</code> authenticator. This rejection triggers the <code>redirect_to_error_page</code> error handler. If a regular rule overrides this authenticator, a JWT is created using the <code>jwt</code> finalizer.</td></tr><tr><td><i class=conum data-value=11></i><b>11</b></td><td>The last few lines configure the <a href=../../../docs/rules/providers/#_filesystem><code>file_system</code></a> provider, which loads regular rules from the file system and watches for changes. This allows you to modify the rules while testing.</td></tr></tbody></table></div></li><li><p>Create a file named <code>signer.pem</code> and add the following content to it. This file should also be placed in the root directory and will act as our key store, containing the private key referenced in the configuration above.</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=s>-----BEGIN EC PRIVATE KEY-----</span>
<span class=s>MIGkAgEBBDALv/dRp6zvm6nmozmB/21viwFCUGBoisHz0v8LSRXGiM5aDywLFmMy</span>
<span class=s>1jPnw29tz36gBwYFK4EEACKhZANiAAQgZkUS7PCh5tEXXvZk0LDQ4Xn4LSK+vKkI</span>
<span class=s>zlCZl+oMgud8gacf4uG5ERgju1xdUyfewsXlwepTnWuwhXM7GdnwY5GOxZTwGn3X</span>
<span class=s>XVwR/5tokqFVrFxt/5c1x7VdccF4nNM=</span>
<span class=s>-----END EC PRIVATE KEY-----</span></code></pre></div></div><div class="admonitionblock warning"><table><tbody><tr><td class=icon><i class="fa icon-warning" title=Warning></i></td><td class=content>Do not use it for any purposes beyond this tutorial!</td></tr></tbody></table></div></li><li><p>Next, we’ll create rules for our main service - the one exposing <code>/</code>, <code>/user</code> and the <code>/admin</code> endpoints. To do this, create a file named <code>upstream-rules.yaml</code> in the <code>rules</code> directory with the following content:</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>version</span><span class=pi>:</span> <span class=s2>&#34;</span><span class=s>1alpha4&#34;</span>
<span class=na>rules</span><span class=pi>:</span>
<span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>upstream:public</span>  <i class=conum data-value=1></i><b>(1)</b>
  <span class=na>match</span><span class=pi>:</span>
    <span class=na>routes</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=na>path</span><span class=pi>:</span> <span class=s>/</span>
      <span class=pi>-</span> <span class=na>path</span><span class=pi>:</span> <span class=s>/favicon.ico</span>
  <span class=na>forward_to</span><span class=pi>:</span>
    <span class=na>host</span><span class=pi>:</span> <span class=s>upstream:8081</span>
  <span class=na>execute</span><span class=pi>:</span>
  <span class=pi>-</span> <span class=na>authenticator</span><span class=pi>:</span> <span class=s>anon</span>
  <span class=pi>-</span> <span class=na>finalizer</span><span class=pi>:</span> <span class=s>noop</span>

<span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>upstream:protected</span>  <i class=conum data-value=2></i><b>(2)</b>
  <span class=na>match</span><span class=pi>:</span>
    <span class=na>routes</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=na>path</span><span class=pi>:</span> <span class=s>/user</span>
      <span class=pi>-</span> <span class=na>path</span><span class=pi>:</span> <span class=s>/admin</span>
  <span class=na>forward_to</span><span class=pi>:</span>
    <span class=na>host</span><span class=pi>:</span> <span class=s>upstream:8081</span>
  <span class=na>execute</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>authenticator</span><span class=pi>:</span> <span class=s>auth</span>
    <span class=pi>-</span> <span class=na>authorizer</span><span class=pi>:</span> <span class=s>cel</span>
      <span class=na>if</span><span class=pi>:</span> <span class=s>Request.URL.Path == &#39;/admin&#39;</span>
      <span class=na>config</span><span class=pi>:</span>
        <span class=na>expressions</span><span class=pi>:</span>
          <span class=pi>-</span> <span class=na>expression</span><span class=pi>:</span> <span class=pi>|</span>
              <span class=s>has(Subject.Attributes.groups) &amp;&amp;</span>
              <span class=s>&#34;role:admin&#34; in Subject.Attributes.groups</span>
            <span class=na>message</span><span class=pi>:</span> <span class=s>User is not admin</span>
  <span class=na>on_error</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>error_handler</span><span class=pi>:</span> <span class=s>redirect_to_idp</span>
      <span class=na>if</span><span class=pi>:</span> <span class=pi>|</span>
        <span class=s>type(Error) == authentication_error &amp;&amp;</span>
        <span class=s>Request.Header(&#34;Accept&#34;).contains(&#34;text/html&#34;)</span>
    <span class=pi>-</span> <span class=na>error_handler</span><span class=pi>:</span> <span class=s>redirect_to_error_page</span>
      <span class=na>if</span><span class=pi>:</span> <span class=pi>|</span>
        <span class=s>type(Error) == authorization_error &amp;&amp;</span>
        <span class=s>Request.Header(&#34;Accept&#34;).contains(&#34;text/html&#34;)</span></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>This first rule is for the <code>/</code> endpoint. It instructs heimdall to pass requests to this endpoint directly through to our upstream service.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>The second rule ensures that the <code>/user</code> endpoint is only accessible to authenticated users, while the <code>/admin</code> endpoint is only accessible to users with the <code>admin</code> role configured in our IDP.</td></tr></tbody></table></div></li><li><p>Next, we’ll create a rule for the OAuth2-Proxy, placed behind heimdall and publicly exposing only certain endpoints. Create a new file named <code>oauth2-proxy-rules.yaml</code> in the <code>rules</code> directory with the following content:</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>version</span><span class=pi>:</span> <span class=s2>&#34;</span><span class=s>1alpha4&#34;</span>
<span class=na>rules</span><span class=pi>:</span>
<span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>oauth2-proxy:public</span>
  <span class=na>match</span><span class=pi>:</span>
    <span class=na>routes</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=na>path</span><span class=pi>:</span> <span class=s>/oauth2/start</span>
      <span class=pi>-</span> <span class=na>path</span><span class=pi>:</span> <span class=s>/oauth2/callback</span>
  <span class=na>forward_to</span><span class=pi>:</span>
    <span class=na>host</span><span class=pi>:</span> <span class=s>oauth2-proxy:4180</span>
  <span class=na>execute</span><span class=pi>:</span>
  <span class=pi>-</span> <span class=na>authenticator</span><span class=pi>:</span> <span class=s>anon</span>
  <span class=pi>-</span> <span class=na>finalizer</span><span class=pi>:</span> <span class=s>noop</span></code></pre></div></div></li><li><p>Next, we’ll create a database initialization script to set up a database for Keycloak. In the <code>initdb</code> directory, create a file named <code>initdb.sh</code> with the following content, and make it executable by running <code>chmod +x initdb.sh</code>:</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=bash><span class=c>#!/bin/bash</span>
<span class=nb>set</span> <span class=nt>-e</span>

psql <span class=nt>-v</span> <span class=nv>ON_ERROR_STOP</span><span class=o>=</span>1 <span class=nt>--username</span> <span class=s2>&#34;</span><span class=nv>$POSTGRES_USER</span><span class=s2>&#34;</span> <span class=o>&lt;&lt;-</span><span class=no>EOSQL</span><span class=sh>
  CREATE USER keycloak WITH PASSWORD &#39;keycloak&#39;;
  CREATE DATABASE keycloak OWNER keycloak;
</span><span class=no>EOSQL
</span></code></pre></div></div></li><li><p>Now, let’s bring everything together using a Docker Compose file. Create a file named <code>docker-compose.yaml</code> in the root directory with the following content:</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>services</span><span class=pi>:</span>
  <span class=na>heimdall</span><span class=pi>:</span> <i class=conum data-value=1></i><b>(1)</b>
    <span class=na>image</span><span class=pi>:</span> <span class=s>dadrus/heimdall:{{ github.ref_name }}</span>
    <span class=na>ports</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=s2>&#34;</span><span class=s>9090:4456&#34;</span>
    <span class=na>command</span><span class=pi>:</span> <span class=s>serve proxy --c /etc/heimdall/config.yaml --insecure</span>
    <span class=na>volumes</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=s>./heimdall-config.yaml:/etc/heimdall/config.yaml:ro</span>
      <span class=pi>-</span> <span class=s>./rules:/etc/heimdall/rules:ro</span>
      <span class=pi>-</span> <span class=s>./signer.pem:/etc/heimdall/signer.pem:ro</span>

  <span class=na>upstream</span><span class=pi>:</span> <i class=conum data-value=2></i><b>(2)</b>
    <span class=na>image</span><span class=pi>:</span> <span class=s>traefik/whoami:latest</span>
    <span class=na>command</span><span class=pi>:</span> <span class=s>--port=8081</span>

  <span class=na>oauth2-proxy</span><span class=pi>:</span> <i class=conum data-value=3></i><b>(3)</b>
    <span class=na>depends_on</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=s>keycloak</span>
    <span class=na>image</span><span class=pi>:</span> <span class=s>quay.io/oauth2-proxy/oauth2-proxy:v7.6.0-amd64</span>
    <span class=na>command</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=s>--http-address</span>
      <span class=pi>-</span> <span class=s>0.0.0.0:4180</span>
    <span class=na>environment</span><span class=pi>:</span>
        <span class=na>OAUTH2_PROXY_CLIENT_ID</span><span class=pi>:</span> <span class=s>placeholder</span> <i class=conum data-value=4></i><b>(4)</b>
        <span class=na>OAUTH2_PROXY_CLIENT_SECRET</span><span class=pi>:</span> <span class=s>placeholder</span>
        <span class=na>OAUTH2_PROXY_REDIRECT_URL</span><span class=pi>:</span> <span class=s>http://127.0.0.1:9090/oauth2/callback</span> <i class=conum data-value=5></i><b>(5)</b>
        <span class=na>OAUTH2_PROXY_PROVIDER</span><span class=pi>:</span> <span class=s>keycloak-oidc</span>
        <span class=na>OAUTH2_PROXY_SKIP_PROVIDER_BUTTON</span><span class=pi>:</span> <span class=kc>true</span>
        <span class=na>OAUTH2_PROXY_COOKIE_SECRET</span><span class=pi>:</span> <span class=s>VerySecure!!!!!!</span>
        <span class=na>OAUTH2_PROXY_COOKIE_NAME</span><span class=pi>:</span> <span class=s>SESSION</span>
        <span class=na>OAUTH2_PROXY_WHITELIST_DOMAINS</span><span class=pi>:</span> <span class=s>127.0.0.1:9090</span>
        <span class=na>OAUTH2_PROXY_OIDC_ISSUER_URL</span><span class=pi>:</span> <span class=s>http://keycloak:8080/realms/test</span> <i class=conum data-value=6></i><b>(6)</b>
        <span class=na>OAUTH2_PROXY_INSECURE_OIDC_ALLOW_UNVERIFIED_EMAIL</span><span class=pi>:</span> <span class=kc>true</span> <i class=conum data-value=7></i><b>(7)</b>
        <span class=na>OAUTH2_PROXY_EMAIL_DOMAINS</span><span class=pi>:</span> <span class=s1>&#39;</span><span class=s>*&#39;</span>
        <span class=na>OAUTH2_PROXY_OIDC_EXTRA_AUDIENCES</span><span class=pi>:</span> <span class=s>account</span> <i class=conum data-value=8></i><b>(8)</b>
        <span class=na>OAUTH2_PROXY_LOGIN_URL</span><span class=pi>:</span> <span class=s>http://127.0.0.1:8080/realms/test/protocol/openid-connect/auth</span> <i class=conum data-value=9></i><b>(9)</b>
        <span class=na>OAUTH2_PROXY_OIDC_JWKS_URL</span><span class=pi>:</span> <span class=s>http://keycloak:8080/realms/test/protocol/openid-connect/certs</span>
        <span class=na>OAUTH2_PROXY_REDEEM_URL</span><span class=pi>:</span> <span class=s>http://keycloak:8080/realms/test/protocol/openid-connect/token</span>
        <span class=na>OAUTH2_PROXY_INSECURE_OIDC_SKIP_ISSUER_VERIFICATION</span><span class=pi>:</span> <span class=kc>true</span>
        <span class=na>OAUTH2_PROXY_SKIP_OIDC_DISCOVERY</span><span class=pi>:</span> <span class=kc>true</span>

  <span class=na>keycloak</span><span class=pi>:</span> <i class=conum data-value=10></i><b>(10)</b>
    <span class=na>image</span><span class=pi>:</span> <span class=s>quay.io/keycloak/keycloak:25.0.4</span>
    <span class=na>command</span><span class=pi>:</span> <span class=pi>[</span> <span class=s2>&#34;</span><span class=s>start-dev&#34;</span><span class=pi>,</span> <span class=s2>&#34;</span><span class=s>--http-port&#34;</span><span class=pi>,</span> <span class=s2>&#34;</span><span class=s>8080&#34;</span> <span class=pi>]</span>
    <span class=na>ports</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=s2>&#34;</span><span class=s>8080:8080&#34;</span>
    <span class=na>environment</span><span class=pi>:</span>
      <span class=na>KC_HOSTNAME</span><span class=pi>:</span> <span class=s>127.0.0.1</span>
      <span class=na>KC_HOSTNAME_PORT</span><span class=pi>:</span> <span class=m>8080</span>
      <span class=na>KC_HOSTNAME_STRICT_BACKCHANNEL</span><span class=pi>:</span> <span class=s2>&#34;</span><span class=s>true&#34;</span>
      <span class=na>KEYCLOAK_ADMIN</span><span class=pi>:</span> <span class=s>admin</span>
      <span class=na>KEYCLOAK_ADMIN_PASSWORD</span><span class=pi>:</span> <span class=s>admin</span>
      <span class=na>KC_HEALTH_ENABLED</span><span class=pi>:</span> <span class=s2>&#34;</span><span class=s>true&#34;</span>
      <span class=na>KC_LOG_LEVEL</span><span class=pi>:</span> <span class=s>info</span>
      <span class=na>KC_DB_URL_HOST</span><span class=pi>:</span> <span class=s>postgresql</span>
      <span class=na>KC_DB</span><span class=pi>:</span> <span class=s>postgres</span>
      <span class=na>KC_DB_USERNAME</span><span class=pi>:</span> <span class=s>keycloak</span>
      <span class=na>KC_DB_PASSWORD</span><span class=pi>:</span> <span class=s>keycloak</span>
    <span class=na>depends_on</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=s>postgresql</span>

  <span class=na>postgresql</span><span class=pi>:</span> <i class=conum data-value=11></i><b>(11)</b>
    <span class=na>image</span><span class=pi>:</span> <span class=s>postgres:13.11</span>
    <span class=na>volumes</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=na>type</span><span class=pi>:</span> <span class=s>volume</span>
        <span class=na>source</span><span class=pi>:</span> <span class=s>postgres-db</span>
        <span class=na>target</span><span class=pi>:</span> <span class=s>/var/lib/postgresql/data</span>
        <span class=na>read_only</span><span class=pi>:</span> <span class=kc>false</span>
      <span class=pi>-</span> <span class=s>./initdb:/docker-entrypoint-initdb.d</span>
    <span class=na>environment</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=s>POSTGRES_USER=postgres</span>
      <span class=pi>-</span> <span class=s>POSTGRES_PASSWORD=postgres</span>

<span class=na>volumes</span><span class=pi>:</span>
  <span class=na>postgres-db</span><span class=pi>:</span></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>Here, we configure heimdall to use the previously defined configuration.<div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>We’re using the <code>--insecure</code> flag here to simplify our setup, which disables enforcement of some security settings you can learn about more <a href=../../../docs/operations/security/#_defaults>here</a>.</td></tr></tbody></table></div></td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>This section sets up the main service that we’ll be protecting.</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>This section defines the OAuth2-Proxy configuration, which heimdall will use to handle the Authorization Code Grant flow and manage the authentication session with a <code>SESSION</code> cookie.</td></tr><tr><td><i class=conum data-value=4></i><b>4</b></td><td>The client ID and client secret values are placeholders. We will configure these in Keycloak.</td></tr><tr><td><i class=conum data-value=5></i><b>5</b></td><td>Since the redirect URI, exposed as <code>/oauth2/callback</code>, is behind heimdall, we use the publicly accessible endpoint here.</td></tr><tr><td><i class=conum data-value=6></i><b>6</b></td><td>The URL of the issuer that OAuth2-Proxy will use. We’ll create a corresponding realm in Keycloak to match this configuration.</td></tr><tr><td><i class=conum data-value=7></i><b>7</b></td><td>The following two lines are required as we don’t want keycloak to verify the email addresses of the users we’ll be creating, and we want to allow any email domain.</td></tr><tr><td><i class=conum data-value=8></i><b>8</b></td><td>To avoid creating a mapper to let Keycloak set a proper <code>aud</code> claim value, we allow the usage of <code>account</code> audience set by Keycloak by default.</td></tr><tr><td><i class=conum data-value=9></i><b>9</b></td><td>These lines are only required as Keycloak is part of our docker compose setup, and we have to use different domain names while communicating with it.</td></tr><tr><td><i class=conum data-value=10></i><b>10</b></td><td>This section sets up Keycloak.</td></tr><tr><td><i class=conum data-value=11></i><b>11</b></td><td>Finally, this section configures our database.</td></tr></tbody></table></div></li></ol></div></div></div><div class=sect1><h2 id=_create_a_realm_and_a_client_in_keycloak>Create a Realm and a Client in Keycloak</h2><div class=sectionbody><div class=paragraph><p>With the above configuration in place, follow these steps to start Keycloak and the database, initialize both, and create the OAuth2-Proxy client:</p></div><div class="olist arabic"><ol class=arabic><li><p>In the root directory, run <code>docker compose up postgresql keycloak</code>. Wait until the database is initialized and Keycloak has started.</p></li><li><p>Open your browser and go to <code>http://127.0.0.1:8080</code>. Log in using the admin credentials (both the username and password are set to <code>admin</code> in our setup).</p></li><li><p>Create a Realm named <code>test</code>. For detailed instructions, refer to the Keycloak documentation on <a href=https://www.keycloak.org/docs/latest/server_admin/index.html#proc-creating-a-realm_server_administration_guide>creating a realm</a>.</p></li><li><p>Within the <code>test</code> realm, create an OpenID Client. Follow the Keycloak documentation on <a href=https://www.keycloak.org/docs/latest/server_admin/index.html#proc-creating-oidc-client_server_administration_guide>creating an OIDC client</a>. Enable "Client authentication" and "Standard Flow", set <code>http://127.0.0.1:9090/oauth2/callback</code> as the "Valid Redirect URI" and <code>http://127.0.0.1:9090/</code> as the "Home URL" and "Valid post logout redirect URIs" and note the "Client ID" and "Client Secret" (later can be found under the "Credentials" tab after completing the client creation wizard); we will use these to complete the OAuth2-Proxy configuration in our Docker Compose file.</p></li><li><p>Stop the docker compose setup with <code>CTRL-C</code>.</p></li></ol></div></div></div><div class=sect1><h2 id=_update_oauth2_proxy_configuration>Update OAuth2-Proxy Configuration</h2><div class=sectionbody><div class=paragraph><p>We can now finalize the configuration and use the proper client id and secret for OAuth2-Proxy</p></div><div class="olist arabic"><ol class=arabic><li><p>Update the <code>OAUTH2_PROXY_CLIENT_ID</code> and <code>OAUTH2_PROXY_CLIENT_SECRET</code> in the configuration of OAuth2-Proxy in your docker compose file with the "Client ID" and "Client Secret" values from Keycloak</p></li></ol></div></div></div><div class=sect1><h2 id=_use_the_setup>Use the Setup</h2><div class=sectionbody><div class=paragraph><p>We now have almost everything set up. The final step is to create a few users, including at least one with the <code>admin</code> role assigned.</p></div><div class="olist arabic"><ol class=arabic><li><p>In the root directory, run <code>docker compose up</code>. Wait until all services are up and running.</p></li><li><p>Open your browser and navigate to <code>http://127.0.0.1:8080</code>. Log in using the admin credentials (both username and password are set to <code>admin</code>).</p></li><li><p>Select the <code>test</code> realm and create an <code>admin</code> group with a role named <code>admin</code> assigned to it. For guidance, refer to the Keycloak documentation on creating <a href=https://www.keycloak.org/docs/latest/server_admin/index.html#proc-managing-groups_server_administration_guide>Groups</a> and <a href=https://www.keycloak.org/docs/latest/server_admin/index.html#proc-creating-realm-roles_server_administration_guide>Roles</a>.</p></li><li><p>Create several users following the Keycloak documentation on <a href=https://www.keycloak.org/docs/latest/server_admin/index.html#proc-creating-user_server_administration_guide>managing users</a>, and assign some of them to the <code>admin</code> group. Disable email verification during user creation to avoid sending verification emails to potentially non-existent addresses.</p></li></ol></div><div class=paragraph><p>Now, let’s test the setup:</p></div><div class="olist arabic"><ol class=arabic><li><p>Navigate to <code>http://127.0.0.1:9090/</code>. You should see some text similar to the one shown below. This text is the response from our upstream service, which echoes back everything the browser sends in its request.</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=text>Hostname: 39f1815dd8ac
IP: 127.0.0.1
IP: ::1
IP: 172.31.0.3
RemoteAddr: 172.31.0.2:37908
GET / HTTP/1.1
Host: upstream:8081
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:130.0) Gecko/20100101 Firefox/130.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Accept-Encoding: gzip, deflate, br, zstd
Accept-Language: de,en-US;q=0.7,en;q=0.3
Dnt: 1
Forwarded: for=172.31.0.1;host=127.0.0.1:9090;proto=http
Priority: u=0, i
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: none
Sec-Fetch-User: ?1
Upgrade-Insecure-Requests: 1
X-Trp-Catalog: de</code></pre></div></div></li><li><p>Attempt to access the <code>http://127.0.0.1:9090/user</code> endpoint. You should be redirected to the Keycloak login page. Log in with any of the users you configured. After logging in, you should be redirected back to <code>http://127.0.0.1:9090/user</code>, where you’ll see some text similar to the one shown below. This indicates that the request hit the <code>/user</code> endpoint of our upstream service. You should also see a JWT token in the <code>Authorization</code> header, which is the result of the JWT finalizer we configured.</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=text>Hostname: 39f1815dd8ac
IP: 127.0.0.1
IP: ::1
IP: 172.31.0.3
RemoteAddr: 172.31.0.2:37908
GET /user HTTP/1.1
Host: upstream:8081
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:130.0) Gecko/20100101 Firefox/130.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Accept-Encoding: gzip, deflate, br, zstd
Accept-Language: de,en-US;q=0.7,en;q=0.3
Authorization: Bearer eyJhbGciOiJFUzM4NCIsImtpZCI6ImIzNDA3N2ZlNWI5NDczYzBjMmY3NDNmYWQ0MmY3ZDU0YWM3ZTFkN2EiLCJ0eXAiOiJKV1QifQ.eyJhdHRycyI6eyJlbWFpbCI6InRlc3QxQGV4YW1wbGUuY29tIiwiZ3JvdXBzIjpbInJvbGU6ZGVmYXVsdC1yb2xlcy10ZXN0Iiwicm9sZTpvZmZsaW5lX2FjY2VzcyIsInJvbGU6YWRtaW4iLCJyb2xlOnVtYV9hdXRob3JpemF0aW9uIiwicm9sZTphY2NvdW50Om1hbmFnZS1hY2NvdW50Iiwicm9sZTphY2NvdW50Om1hbmFnZS1hY2NvdW50LWxpbmtzIiwicm9sZTphY2NvdW50OnZpZXctcHJvZmlsZSJdLCJwcmVmZXJyZWRVc2VybmFtZSI6InRlc3QxIiwidXNlciI6IjQ5ZWE3Mjk3LWI0NzgtNDcxNC05NjM2LWQ5ZTk3ZmVkZmNhOSJ9LCJleHAiOjE3MjY0NjkyMTAsImlhdCI6MTcyNjQ2ODkxMCwiaXNzIjoiaGVpbWRhbGwiLCJqdGkiOiJkODg3Y2Q3MC1iYzhlLTQ2MTItODYzNS1lYTYwYjU1ZmU3MzciLCJuYmYiOjE3MjY0Njg5MTAsInN1YiI6IjQ5ZWE3Mjk3LWI0NzgtNDcxNC05NjM2LWQ5ZTk3ZmVkZmNhOSJ9.JLS__gH0wEHwB07DV9Rcrm9mo1xfXpqHoC8pbZ523KHV7QO3n2jrauiB4fVggB5DPe4tTUrp8X1e4nePXPniJyACyC7gmoBX5PJTbUPlalsw0WKOfYOcYXjwJDakId5r
Cookie: SESSION=S77dk6NGQyyreWQ1enWRSCSP...wBsNTlidPgTBahs=
Dnt: 1
Forwarded: for=172.31.0.1;host=127.0.0.1:9090;proto=http
Priority: u=0, i
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: none
Sec-Fetch-User: ?1
Upgrade-Insecure-Requests: 1
X-Trp-Catalog: de</code></pre></div></div></li><li><p>Try accessing the <code>http://127.0.0.1:9090/admin</code> endpoint with both a user not in the <code>admin</code> group and a user from the <code>admin</code> group. The user not in the <code>admin</code> group should see the "access denied" page, while the user from the <code>admin</code> group should be able to access the endpoint and see the echoed response from our upstream service.</p><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>To "logout" the user, just delete the cookies for <code>http://127.0.0.1:9090</code> using the Web-Developer Tools of your browser.</td></tr></tbody></table></div></li><li><p>Attempts to access any not exposed endpoints, like <code>http://127.0.0.1:9090/foo</code> will always result in the "access denied" page.</p></li></ol></div></div></div><div class=sect1><h2 id=_cleanup>Cleanup</h2><div class=sectionbody><div class=paragraph><p>Just stop the environment with <code>CTRL-C</code> and delete the created files. If you started docker compose in the background, tear the environment down with <code>docker compose down</code>.</p></div></div></div></linkable-headline-area></div><p class="text-end fst-italic fs-7 pb-3">Last updated on <span class=fw-bold>Apr 8, 2025</span></p><hr><div class="d-flex justify-content-between py-3"><a href=../../../guides/authz/openfga/ class="fs-6 fw-bold text-dark link-secondary link-underline-opacity-0"><svg width="16" height="16" fill="currentColor" class="bi bi-chevron-left" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5.0 010 .708L5.707 8l5.647 5.646a.5.5.0 01-.708.708l-6-6a.5.5.0 010-.708l6-6a.5.5.0 01.708.0z"/></svg>
Integration with OpenFGA</a></div></div></main></div><footer class="footer py-4 py-md-5 px-4 px-md-3 mt-3"><div class=container><div class=row><div class="col-lg-3 mb-3"><p class=fs-5>Heimdall</p><ul class="list-unstyled small text-muted"><li class=mb-2>2022-2024 © Heimdall Project Authors. All rights reserved.</li><li class=mb-2><a href=https://github.com/dadrus/heimdall/blob/master/LICENSE>Apache 2.0 licensed</a></li></ul></div><div class="col-6 col-lg-2 offset-lg-1 mb-3"><h5>Links</h5><ul class=list-unstyled><li class=mb-2><a href=../../../>Home</a></li><li class=mb-2><a href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=mb-2><a href=../../../guides/>Guides</a></li><li class=mb-2><a href=../../../openapi/>API</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Guides</h5><ul class=list-unstyled><li class=mb-2><a href=../../../guides/proxies/>API Gateways & Proxies</a></li><li class=mb-2><a href=../../../guides/authz/>Authorization Services</a></li><li class=mb-2><a href=../../../guides/authn/>Authentication Protocols & Services</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Community</h5><ul class=list-unstyled><li class=mb-2><a href=https://github.com/dadrus/heimdall>Github</a></li><li class=mb-2><a href=https://discord.gg/qQgg8xKuyb>Discord</a></li></ul></div></div></div></footer><script src=../../../js/main.js defer></script></body></html>