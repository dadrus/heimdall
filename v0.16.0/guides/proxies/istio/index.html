<!doctype html><html lang=en><head><title>Istio Service Mesh Integration</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="An open source Identity Aware Proxy and an Access Control Decision service for cloud native applications"><meta name=dc.relation content="https://dadrus.github.io/"><meta name=theme-color content="#1A94D2"><link rel=stylesheet href=../../../css/styles.min.css media=screen><link rel='shortcut icon' type=image/x-icon href=../../../favicon.ico></head><body><header class="navbar navbar-expand-md navbar-dark bg-dark sticky-top"><nav class="container-xxl flex-wrap flex-lg-nowrap px-0" aria-label="Main navigation"><button class="btn btn-outline-dark d-lg-none navbar-toggler border-0 shadow-none ps-3" type=button data-bs-toggle=offcanvas data-bs-target=#docsMenuContent aria-controls=docsMenuContent aria-expanded=false aria-label="Open docs menu"><svg width="36" height="36" fill="currentcolor" class="bi bi-list" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.5 12a.5.5.0 01.5-.5h10a.5.5.0 010 1H3a.5.5.0 01-.5-.5m0-4a.5.5.0 01.5-.5h10a.5.5.0 010 1H3A.5.5.0 012.5 8m0-4a.5.5.0 01.5-.5h10a.5.5.0 010 1H3A.5.5.0 012.5 4"/></svg></button><nav class="offcanvas offcanvas-start d-md-none text-bg-light" tabindex=-1 id=docsMenuContent aria-labelledby=docsMenuContentLabel><div class=offcanvas-header><h5 class=offcanvas-title id=docsMenuContentLabel>Browse guides</h5><button type=button class=btn-close data-bs-dismiss=offcanvas aria-label="Close docs menu"></button></div><div class="offcanvas-body docs-sidebar"><div class=docs-search-button><button type=button class="btn btn-outline-secondary mb-3 d-none d-md-block w-100 text-start" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search">
<svg width="20" height="20" fill="currentcolor" class="bi bi-search me-2" viewBox="0 0 20 20"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg>
<span>Quick search...</span></button></div><nav id=SideBarToc><ul><li><span>API Gateways & Proxies</span><ul><li><a href=../../../guides/proxies/caddy/>Caddy Integration</a></li><li><a href=../../../guides/proxies/contour/>Contour Integration</a></li><li><a href=../../../guides/proxies/emissary/>Emissary Ingress Integration</a></li><li><a href=../../../guides/proxies/envoy/>Envoy Integration</a></li><li><a href=../../../guides/proxies/envoy_gateway/>Envoy Gateway Integration</a></li><li><a href=../../../guides/proxies/haproxy/>HAProxy Integration</a></li><li><a class=active href=../../../guides/proxies/istio/>Istio Service Mesh Integration</a></li><li><a href=../../../guides/proxies/nginx/>NGINX Integration</a></li><li><a href=../../../guides/proxies/traefik/>Traefik Proxy Integration</a></li></ul></li><li><span>Authorization Services</span><ul><li><a href=../../../guides/authz/opa/>Integration with OPA</a></li><li><a href=../../../guides/authz/openfga/>Integration with OpenFGA</a></li></ul></li><li><span>Authentication Protocols & Services</span><ul><li><a href=../../../guides/authn/oidc_first_party_auth/>First-Party Authentication with OpenID Connect</a></li></ul></li></ul></nav></div></nav><div class="d-flex align-items-center px-4"><a class="navbar-brand navbar-brand-highlight text-white me-0" href=../../../ style=font-weight:500;font-size:1.5rem>Heimdall</a><ul class="navbar-nav d-none d-md-flex ms-3"><li class=nav-item><a class='nav-link text-white' href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=nav-item><a class='nav-link text-white active' href=../../../guides/>Guides</a></li><li class=nav-item><a class='nav-link text-white' href=../../../openapi/>API</a></li></ul></div><div class=d-flex><button type=button class="btn btn-outline-dark navbar-toggler border-0 shadow-none" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search">
<span class="bi bi-search"></span>
</button>
<button class="btn btn-outline-dark navbar-toggler border-0 shadow-none pe-3" type=button data-bs-toggle=offcanvas data-bs-target=#mainMenuContent aria-controls=mainMenuContent aria-expanded=false aria-label="Open main menu"><svg width="24" height="24" fill="currentcolor" class="bi bi-three-dots" viewBox="0 0 16 16"><path d="M3 9.5a1.5 1.5.0 110-3 1.5 1.5.0 010 3m5 0a1.5 1.5.0 110-3 1.5 1.5.0 010 3m5 0a1.5 1.5.0 110-3 1.5 1.5.0 010 3"/></svg></button><div class="offcanvas offcanvas-end text-bg-dark" tabindex=-1 id=mainMenuContent aria-labelledby=mainMenuContentLabel><div class=offcanvas-header><h5 class="offcanvas-title text-white" id=mainMenuContentLabel>Heimdall</h5><button type=button class="btn-close btn-close-white" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class=offcanvas-body><ul class="navbar-nav flex-column d-md-none d-lg-none d-xl-none"><li class=nav-item><a class='nav-link text-white' href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=nav-item><a class='nav-link text-white active' href=../../../guides/>Guides</a></li><li class=nav-item><a class='nav-link text-white' href=../../../openapi/>API</a></li></ul><hr class="text-white-50 d-md-none"><ul class="navbar-nav flex-column ms-auto"><doc-version-select class="nav-item dropdown" version-file=/heimdall/data.json current-version=v0.16.0 current-page=/guides/proxies/istio/><button class="btn btn-dark dropdown-toggle me-4" data-bs-toggle=dropdown aria-expanded=false>
v0.16.0</button></doc-version-select></ul><ul class="navbar-nav flex-column"><li class="nav-item mb-1 pe-4"><a class="nav-link text-white" style=align-self:center href=https://github.com/dadrus/heimdall><svg role="img" width="20" height="20" fill="currentcolor" class="bi bi-github text-white" viewBox="0 0 16 16"><title>GitHub</title><path d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.012 8.012.0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
<small class="ms-2 d-md-none">GitHub</small></a></li></ul></div></div></div></nav></header><div class=modal id=docSearch tabindex=-1 aria-labelledby=docSearchLabel aria-hidden=true><doc-search class="col-auto me-auto mw-75" index-file=/heimdall/v0.16.0/index.json path-prefix=/heimdall/v0.16.0><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class=modal-content><div class="modal-header p-2"><div class=input-group><div class="input-group-text bg-body border-0 fs-4"><svg width="16" height="16" fill="currentcolor" class="bi bi-search text-secondary my-0" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg></div><input id=search-input class="form-control search-bar border-0" type=search placeholder="Search documentation " aria-label="Search docs..." autocomplete=off autofocus><div class="input-group-text bg-body border-0"><a class="btn input-group-text text-muted border p-1 bg-light-subtle fs-7 fw-bold font-monospace" data-bs-dismiss=modal aria-label=Close>ESC</a></div></div></div><div class=modal-body><div class=search-results><p class="text-center mt-5">No recent searches</p></div></div><div class=modal-footer></div></div></div></doc-search></div><div class="container-xxl docs-layout px-4"><aside class="d-none pe-3 docs-sidebar"><div class=docs-search-button><button type=button class="btn btn-outline-secondary mb-3 d-none d-md-block w-100 text-start" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search">
<svg width="20" height="20" fill="currentcolor" class="bi bi-search me-2" viewBox="0 0 20 20"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg>
<span>Quick search...</span></button></div><nav id=SideBarToc><ul><li><span>API Gateways & Proxies</span><ul><li><a href=../../../guides/proxies/caddy/>Caddy Integration</a></li><li><a href=../../../guides/proxies/contour/>Contour Integration</a></li><li><a href=../../../guides/proxies/emissary/>Emissary Ingress Integration</a></li><li><a href=../../../guides/proxies/envoy/>Envoy Integration</a></li><li><a href=../../../guides/proxies/envoy_gateway/>Envoy Gateway Integration</a></li><li><a href=../../../guides/proxies/haproxy/>HAProxy Integration</a></li><li><a class=active href=../../../guides/proxies/istio/>Istio Service Mesh Integration</a></li><li><a href=../../../guides/proxies/nginx/>NGINX Integration</a></li><li><a href=../../../guides/proxies/traefik/>Traefik Proxy Integration</a></li></ul></li><li><span>Authorization Services</span><ul><li><a href=../../../guides/authz/opa/>Integration with OPA</a></li><li><a href=../../../guides/authz/openfga/>Integration with OpenFGA</a></li></ul></li><li><span>Authentication Protocols & Services</span><ul><li><a href=../../../guides/authn/oidc_first_party_auth/>First-Party Authentication with OpenID Connect</a></li></ul></li></ul></nav></aside><main class=docs-main><div class="d-md-none docs-location bg-body"><nav style="--bs-breadcrumb-divider:'>'" aria-label=breadcrumb><ol class="breadcrumb mb-0"><li class="breadcrumb-item fw-bold">API Gateways & Proxies</li><li class="breadcrumb-item active" aria-current=page>Istio Service Mesh Integration</li></ol></nav></div><div class="docs-intro pt-3 pe-3"><h1>Istio Service Mesh Integration</h1><p>Explains how to integrate heimdall with Istio Service Mesh.</p></div><aside class="text-muted docs-toc"><strong class="d-md-block h6 pb-2 my-2 ms-2 border-bottom d-none d-md-none d-lg-block">On this page</strong><div id=page-content-toc class="mt-1 mb-3 text-muted d-none d-md-none d-lg-block docs-toc-content"><nav id=TableOfContents><ul><li><a href=#_prerequisites>Prerequisites</a></li><li><a href=#_integration_options>Integration Options</a></li><li><a href=#_common_configuration>Common Configuration</a><ul><li><a href=#_register_the_extension_provider>Register the Extension Provider</a></li><li><a href=#_configure_additional_ca_certificates>Configure additional CA certificates</a></li><li><a href=#_route_the_requests_through_heimdall>Route the requests through heimdall</a></li></ul></li><li><a href=#_ingress_gateway_configuration>Ingress Gateway Configuration</a></li><li><a href=#_kubernetes_gateway_api>Kubernetes Gateway API</a></li><li><a href=#_additional_resources>Additional Resources</a></li></ul></nav></div><button class="btn btn-outline-secondary text-decoration-none d-lg-none collapsed" type=button data-bs-toggle=collapse data-bs-target=#page-content-toc-collapsible aria-expanded=false aria-controls=page-content-toc-collapsible>
On this page<svg width="16" height="16" fill="currentcolor" class="bi bi-chevron-expand" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M3.646 9.146a.5.5.0 01.708.0L8 12.793l3.646-3.647a.5.5.0 01.708.708l-4 4a.5.5.0 01-.708.0l-4-4a.5.5.0 010-.708m0-2.292a.5.5.0 00.708.0L8 3.207l3.646 3.647a.5.5.0 00.708-.708l-4-4a.5.5.0 00-.708.0l-4 4a.5.5.0 000 .708"/></svg></button><div id=page-content-toc-collapsible class="mt-1 mb-3 text-muted d-lg-none collapse docs-toc-content"><div class="card card-body"><nav id=TableOfContents><ul><li><a href=#_prerequisites>Prerequisites</a></li><li><a href=#_integration_options>Integration Options</a></li><li><a href=#_common_configuration>Common Configuration</a><ul><li><a href=#_register_the_extension_provider>Register the Extension Provider</a></li><li><a href=#_configure_additional_ca_certificates>Configure additional CA certificates</a></li><li><a href=#_route_the_requests_through_heimdall>Route the requests through heimdall</a></li></ul></li><li><a href=#_ingress_gateway_configuration>Ingress Gateway Configuration</a></li><li><a href=#_kubernetes_gateway_api>Kubernetes Gateway API</a></li><li><a href=#_additional_resources>Additional Resources</a></li></ul></nav></div></div></aside><div class="docs-content pe-3"><div data-bs-spy=scroll data-bs-target=#page-content-toc class=mt-3><linkable-headline-area><div class=paragraph><p><a href=https://istio.io/>Istio</a> is an open-source service mesh that extends Kubernetes’ capabilities, providing a uniform way to observe, secure, and connect microservices. It also functions as a Kubernetes-based application gateway, using either its built-in <a href=https://istio.io/latest/docs/concepts/traffic-management/#gateways>Ingress Gateway</a>, the Kubernetes <a href=https://istio.io/latest/docs/tasks/traffic-management/ingress/kubernetes-ingress/>Ingress</a>, or the <a href=https://gateway-api.sigs.k8s.io/>Gateway API</a> resources for configuration.</p></div><div class=sect1><h2 id=_prerequisites>Prerequisites</h2><div class=sectionbody><div class=ulist><ul><li><p>A kubernetes cluster</p></li><li><p>Deployed Istio (See <a href=https://istio.io/latest/docs/setup/install/>here</a> for installation options)</p></li><li><p>heimdall installed and operated in <a href=../../../docs/concepts/operating_modes/#_decision_mode>Decision Operation Mode</a>.</p><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>To allow heimdall communicating with services running in the mesh, add the certificate of the CA used by Istio to heimdall’s <a href=../../../docs/operations/security/#_tls_trust_store>trust store</a>.</td></tr></tbody></table></div></li></ul></div></div></div><div class=sect1><h2 id=_integration_options>Integration Options</h2><div class=sectionbody><div class=paragraph><p>Technically, the integration works similarly to the <a href=../../../guides/proxies/envoy/>Envoy</a> setup by utilizing the <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/http/ext_authz/v3/ext_authz.proto.html>External Authorization</a> filter. This can be implemented in two ways:</p></div><div class=ulist><ul><li><p>via HTTP</p></li><li><p>via gRPC (recommended)</p></li></ul></div><div class=paragraph><p>In both approaches, the filter sends a request to an external gRPC or HTTP service (in this case, heimdall) to determine if the incoming HTTP request is authorized. If heimdall responds with a <code>2xx</code> status code, the request is forwarded to the upstream service. Otherwise, heimdall’s response is returned to the caller.</p></div><div class=paragraph><p>For Istio, this integration involves configuring an <code>envoyExtAuthzHttp</code> or <code>envoyExtAuthzGrpc</code> <a href=https://istio.io/latest/docs/reference/config/istio.mesh.v1alpha1/#MeshConfig-ExtensionProvider>ExtensionProvider</a> for heimdall in the mesh configuration. The configured extension can then be enabled via an <a href=https://istio.io/latest/docs/reference/config/security/authorization-policy/><code>AuthorizationPolicy</code></a> resource. Depending on its definition, heimdall can be used globally for all requests served through a particular gateway, or selectively for specific requests only.</p></div><div class=paragraph><p>The sections below explain how to achieve this for Istio’s Ingress Gateway, as well as using the Kubernetes Gateway API.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>This guide assumes that Istio and heimdall are installed in the same cluster. If they are not, you will need to register heimdall in Istio’s internal service registry using a <a href=https://istio.io/latest/docs/reference/config/networking/service-entry/><code>ServiceEntry</code></a> resource.</td></tr></tbody></table></div></div></div><div class=sect1><h2 id=_common_configuration>Common Configuration</h2><div class=sectionbody><div class=sect2><h3 id=_register_the_extension_provider>Register the Extension Provider</h3><div class=paragraph><p>As mentioned earlier, registering an extension provider in Istio’s mesh configuration is required. Follow these steps:</p></div><div class="olist arabic"><ol class=arabic><li><p>Edit the mesh configuration: Run <code>kubectl edit configmap istio -n istio-system</code> to open the mesh configuration for editing.</p></li><li><p>Add the <code>extensionProvider</code> configuration: Insert the following settings into the mesh configuration:</p><div class=exampleblock><div class=content><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>apiVersion</span><span class=pi>:</span> <span class=s>v1</span>
<span class=na>data</span><span class=pi>:</span>
  <span class=na>mesh</span><span class=pi>:</span> <span class=pi>|-</span>
    <span class=s># Add the following contents:</span>
    <span class=s>extensionProviders:</span>
    <span class=s>- name: heimdall-ext-auth </span><i class=conum data-value=1></i><b>(1)</b>
      <span class=s>envoyExtAuthzGrpc: </span><i class=conum data-value=2></i><b>(2)</b>
        <span class=s>service: heimdall.heimdall.svc.cluster.local </span><i class=conum data-value=3></i><b>(3)</b>
        <span class=s>port: &#34;4456&#34;</span></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td><code>heimdall-ext-auth</code> is the name of our extension provider, which will be referenced later in the <a href=https://istio.io/latest/docs/reference/config/security/authorization-policy/><code>AuthorizationPolicy</code></a> configuration.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>We’re using a gRPC based implementation here. However, since Istio does not automatically configure Envoy to use HTTP/2 for gRPC calls, it requires an additional <a href=https://istio.io/latest/docs/reference/config/networking/envoy-filter/><code>EnvoyFilter</code></a> resource. This appears to be a bug in Istio’s implementation.</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>Heimdall’s address within the cluster, which the extension provider will use for communication.</td></tr></tbody></table></div></div></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>Alternatively, you can make use of <code>envoyExtAuthzHttp</code> extension provider. In that case insert the following settings:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>apiVersion</span><span class=pi>:</span> <span class=s>v1</span>
<span class=na>data</span><span class=pi>:</span>
  <span class=na>mesh</span><span class=pi>:</span> <span class=pi>|-</span>
    <span class=s># Add the following contents:</span>
    <span class=s>extensionProviders:</span>
    <span class=s>- name: heimdall-ext-auth</span>
      <span class=s>envoyExtAuthzHttp:</span>
        <span class=s>service: heimdall.heimdall.svc.cluster.local</span>
        <span class=s>port: &#34;4456&#34;</span>
        <span class=s>includeRequestHeadersInCheck: [ &#34;authorization&#34;, &#34;cookie&#34;, &#34;accept&#34;, &#34;x-forwarded-for&#34;, &#34;x-forwarded-proto&#34;, &#34;x-forwarded-host&#34; ] </span><i class=conum data-value=1></i><b>(1)</b>
        <span class=s>headersToUpstreamOnAllow: [ &#34;authorization&#34; ] </span><i class=conum data-value=2></i><b>(2)</b></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>Include further headers, you expect to make use of in your heimdall rules.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>Include further headers, you expect to be set in your heimdall rules and which should be forwarded to the upstream service.</td></tr></tbody></table></div></td></tr></tbody></table></div></li><li><p>Deploy the following <a href=https://istio.io/latest/docs/reference/config/networking/envoy-filter/><code>EnvoyFilter</code></a> resource to correct the cluster configuration that Istio sets up for the heimdall service.</p><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>This is only required if you made use of the <code>envoyExtAuthzGrpc</code> provider as shown above.</td></tr></tbody></table></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>apiVersion</span><span class=pi>:</span> <span class=s>networking.istio.io/v1alpha3</span>
<span class=na>kind</span><span class=pi>:</span> <span class=s>EnvoyFilter</span>
<span class=na>metadata</span><span class=pi>:</span>
  <span class=na>name</span><span class=pi>:</span> <span class=s>http2-protocol-for-heimdall</span>
  <span class=na>namespace</span><span class=pi>:</span> <span class=s>istio-system</span> <i class=conum data-value=1></i><b>(1)</b>
<span class=na>spec</span><span class=pi>:</span>
  <span class=na>configPatches</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>applyTo</span><span class=pi>:</span> <span class=s>CLUSTER</span> <i class=conum data-value=2></i><b>(2)</b>
      <span class=na>match</span><span class=pi>:</span> <i class=conum data-value=3></i><b>(3)</b>
        <span class=na>context</span><span class=pi>:</span> <span class=s>GATEWAY</span>
        <span class=na>cluster</span><span class=pi>:</span>
          <span class=na>name</span><span class=pi>:</span> <span class=s>outbound|4456||heimdall.heimdall.svc.cluster.local</span>
      <span class=na>patch</span><span class=pi>:</span>
        <span class=na>operation</span><span class=pi>:</span> <span class=s>MERGE</span>
        <span class=na>value</span><span class=pi>:</span>
          <span class=na>typed_extension_protocol_options</span><span class=pi>:</span> <i class=conum data-value=4></i><b>(4)</b>
            <span class=na>envoy.extensions.upstreams.http.v3.HttpProtocolOptions</span><span class=pi>:</span>
              <span class=s2>&#34;</span><span class=s>@type&#34;</span><span class=err>:</span> <span class=s>type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions</span>
              <span class=s>explicit_http_config</span><span class=err>:</span>
                <span class=na>http2_protocol_options</span><span class=pi>:</span> <span class=pi>{}</span></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>The namespace where the Istio control plane is deployed (the config root namespace). That way this filter is used each time envoy instance is created by Istio.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>Specifies that we want to apply the patch for a cluster</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>Since we want this patch to be applied for gateways only, we limit the context accordingly</td></tr><tr><td><i class=conum data-value=4></i><b>4</b></td><td>This is the actual config we would like to merge into the cluster definition to enable HTTP/2 support.</td></tr></tbody></table></div></li></ol></div></div><div class=sect2><h3 id=_configure_additional_ca_certificates>Configure additional CA certificates</h3><div class=paragraph><p>This step is optional and only necessary if heimdall is configured to use TLS for inbound traffic.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>It is highly recommended to secure the communication between the Istio-managed gateway and heimdall. Instead of configuring heimdall to handle TLS directly, you can let Istio inject a proxy into heimdall’s pod to manage TLS termination. However, this approach introduces an additional network hop, which could negatively impact performance.</td></tr></tbody></table></div><div class="olist arabic"><ol class=arabic><li><p>Instruct Istio to trust heimdall’s certificate by applying the following <a href=https://istio.io/latest/docs/reference/config/networking/destination-rule/><code>DestinationRule</code></a> resource in the Istio root configuration namespace:</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>apiVersion</span><span class=pi>:</span> <span class=s>networking.istio.io/v1</span>
<span class=na>kind</span><span class=pi>:</span> <span class=s>DestinationRule</span>
<span class=na>metadata</span><span class=pi>:</span>
  <span class=na>name</span><span class=pi>:</span> <span class=s>heimdall</span>
  <span class=na>namespace</span><span class=pi>:</span> <span class=s>istio-system</span>
<span class=na>spec</span><span class=pi>:</span>
  <span class=na>host</span><span class=pi>:</span> <span class=s>heimdall.heimdall.svc.cluster.local</span>
  <span class=na>trafficPolicy</span><span class=pi>:</span>
    <span class=na>tls</span><span class=pi>:</span>
      <span class=na>mode</span><span class=pi>:</span> <span class=s>SIMPLE</span>
      <span class=na>sni</span><span class=pi>:</span> <span class=s>heimdall.heimdall.svc.cluster.local</span> <i class=conum data-value=1></i><b>(1)</b>
      <span class=na>credentialName</span><span class=pi>:</span> <span class=s>cacerts</span> <i class=conum data-value=2></i><b>(2)</b></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>If <code>sni</code> is not set, it defaults to the downstream HTTP <code>Host</code> or <code>Authority</code> header, which will cause an error on the heimdall side because the name will not match the DNS entries in heimdall’s certificate.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>The secret contains the certificate of the CA that issued heimdall’s certificate. Without this, Envoy won’t trust heimdall’s certificate. This secret must be available in every namespace where Istio creates a gateway.</td></tr></tbody></table></div></li></ol></div></div><div class=sect2><h3 id=_route_the_requests_through_heimdall>Route the requests through heimdall</h3><div class=paragraph><p>With the previous configuration in place, we can now instruct Istio to route the ingress traffic through heimdall first.</p></div><div class="olist arabic"><ol class=arabic><li><p>Create the following <a href=https://istio.io/latest/docs/reference/config/security/authorization-policy/><code>AuthorizationPolicy</code></a> in Istio’s root configuration namespace:</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>apiVersion</span><span class=pi>:</span> <span class=s>security.istio.io/v1</span>
<span class=na>kind</span><span class=pi>:</span> <span class=s>AuthorizationPolicy</span>
<span class=na>metadata</span><span class=pi>:</span>
  <span class=na>name</span><span class=pi>:</span> <span class=s>heimdall</span>
  <span class=na>namespace</span><span class=pi>:</span> <span class=s>istio-system</span>
<span class=na>spec</span><span class=pi>:</span>
  <span class=na>selector</span><span class=pi>:</span>
    <span class=na>matchLabels</span><span class=pi>:</span> <i class=conum data-value=1></i><b>(1)</b>
      <span class=na>istio</span><span class=pi>:</span> <span class=s>ingressgateway</span>
  <span class=na>action</span><span class=pi>:</span> <span class=s>CUSTOM</span>
  <span class=na>provider</span><span class=pi>:</span>
    <span class=na>name</span><span class=pi>:</span> <span class=s>heimdall-ext-auth</span> <i class=conum data-value=2></i><b>(2)</b>
  <span class=na>rules</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=pi>{}</span> <i class=conum data-value=3></i><b>(3)</b></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>This policy is specifically intended for gateways, excluding injected sidecars.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>Here, we reference the extension provider that was configured earlier.</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>The policy is set to apply universally, with no specific conditions, hence the empty rules.</td></tr></tbody></table></div></li></ol></div><div class=paragraph><p>With this configuration completed, you can proceed to deploy the necessary gateway resources.</p></div></div></div></div><div class=sect1><h2 id=_ingress_gateway_configuration>Ingress Gateway Configuration</h2><div class=sectionbody><div class=paragraph><p>Simply create the Ingress <a href=https://istio.io/latest/docs/reference/config/networking/gateway/><code>Gateway</code></a> resource and define the <a href=https://istio.io/latest/docs/reference/config/networking/virtual-service/><code>VirtualService</code></a> resources for your services according to your requirements. No further configuration is necessary.</p></div></div></div><div class=sect1><h2 id=_kubernetes_gateway_api>Kubernetes Gateway API</h2><div class=sectionbody><div class=paragraph><p>As of this writing, Istio’s implementation of the Gateway API appears incomplete. It lacks the necessary <code>Role</code> and <code>RoleBinding</code> to access the <code>Secret</code> containing additional CA certificates. Without these, the Envoy instances cannot access the secret, preventing them from trusting heimdall’s certificate. To resolve this, apply the following resources in the namespace where the <a href=https://kubernetes.io/docs/concepts/services-networking/gateway/#api-kind-gateway><code>Gateway</code></a> will be installed:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>apiVersion</span><span class=pi>:</span> <span class=s>rbac.authorization.k8s.io/v1</span>
<span class=na>kind</span><span class=pi>:</span> <span class=s>Role</span>
<span class=na>metadata</span><span class=pi>:</span>
  <span class=na>labels</span><span class=pi>:</span>
    <span class=na>gateway.istio.io/managed</span><span class=pi>:</span> <span class=s>istio.io-gateway-controller</span>
    <span class=na>gateway.networking.k8s.io/gateway-name</span><span class=pi>:</span> <span class=s>istio-gw</span>
    <span class=na>istio</span><span class=pi>:</span> <span class=s>ingressgateway</span>
    <span class=na>istio.io/gateway-name</span><span class=pi>:</span> <span class=s>istio-gw</span>
  <span class=na>name</span><span class=pi>:</span> <span class=s>istio-gw-istio</span>
  <span class=na>namespace</span><span class=pi>:</span> <span class=s>istio-gw</span>
<span class=na>rules</span><span class=pi>:</span>
  <span class=pi>-</span> <span class=na>apiGroups</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=s2>&#34;</span><span class=s>&#34;</span>
    <span class=na>resources</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=s>secrets</span>
    <span class=na>verbs</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=s>get</span>
      <span class=pi>-</span> <span class=s>watch</span>
      <span class=pi>-</span> <span class=s>list</span>
<span class=nn>---</span>
<span class=na>apiVersion</span><span class=pi>:</span> <span class=s>rbac.authorization.k8s.io/v1</span>
<span class=na>kind</span><span class=pi>:</span> <span class=s>RoleBinding</span>
<span class=na>metadata</span><span class=pi>:</span>
  <span class=na>labels</span><span class=pi>:</span>
    <span class=na>gateway.istio.io/managed</span><span class=pi>:</span> <span class=s>istio.io-gateway-controller</span>
    <span class=na>gateway.networking.k8s.io/gateway-name</span><span class=pi>:</span> <span class=s>istio-gw</span>
    <span class=na>istio</span><span class=pi>:</span> <span class=s>ingressgateway</span>
    <span class=na>istio.io/gateway-name</span><span class=pi>:</span> <span class=s>istio-gw</span>
  <span class=na>name</span><span class=pi>:</span> <span class=s>istio-gw-istio</span>
  <span class=na>namespace</span><span class=pi>:</span> <span class=s>istio-gw</span>
<span class=na>roleRef</span><span class=pi>:</span>
  <span class=na>apiGroup</span><span class=pi>:</span> <span class=s>rbac.authorization.k8s.io</span>
  <span class=na>kind</span><span class=pi>:</span> <span class=s>Role</span>
  <span class=na>name</span><span class=pi>:</span> <span class=s>istio-gw-istio</span>
<span class=na>subjects</span><span class=pi>:</span>
  <span class=pi>-</span> <span class=na>kind</span><span class=pi>:</span> <span class=s>ServiceAccount</span>
    <span class=na>name</span><span class=pi>:</span> <span class=s>istio-gw-istio</span> <i class=conum data-value=1></i><b>(1)</b></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>Change the name of the service account accordingly; it follows the pattern <code>&lt;namespace>-istio</code>.</td></tr></tbody></table></div><div class=paragraph><p>Now, you can create the required <a href=https://kubernetes.io/docs/concepts/services-networking/gateway/#api-kind-gateway><code>Gateway</code></a> and <a href=https://kubernetes.io/docs/concepts/services-networking/gateway/#api-kind-httproute><code>HTTPRoute</code></a> resources for your service. When creating the <code>Gateway</code> resource, ensure you add the <code>istio: ingressgateway</code> label to its metadata. If you omit this label, the <a href=https://istio.io/latest/docs/reference/config/security/authorization-policy/><code>AuthorizationPolicy</code></a> configured earlier will not be applied.</p></div></div></div><div class=sect1><h2 id=_additional_resources>Additional Resources</h2><div class=sectionbody><div class=paragraph><p>A fully working example with Istio is also available on <a href=https://github.com/dadrus/heimdall/tree/main/examples>GitHub</a>.</p></div></div></div></linkable-headline-area></div><p class="text-end fst-italic fs-7 pb-3">Last updated on <span class=fw-bold>Apr 8, 2025</span></p><hr><div class="d-flex justify-content-between py-3"><a href=../../../guides/proxies/haproxy/ class="fs-6 fw-bold text-dark link-secondary link-underline-opacity-0"><svg width="16" height="16" fill="currentcolor" class="bi bi-chevron-left" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5.0 010 .708L5.707 8l5.647 5.646a.5.5.0 01-.708.708l-6-6a.5.5.0 010-.708l6-6a.5.5.0 01.708.0z"/></svg>
HAProxy Integration
</a><a class="ms-auto fs-6 fw-bold text-dark link-secondary link-underline-opacity-0" href=../../../guides/proxies/nginx/>NGINX Integration<svg width="16" height="16" fill="currentcolor" class="bi bi-chevron-right" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5.0 01.708.0l6 6a.5.5.0 010 .708l-6 6a.5.5.0 01-.708-.708L10.293 8 4.646 2.354a.5.5.0 010-.708z"/></svg></a></div></div></main></div><footer class="footer py-4 py-md-5 px-4 px-md-3 mt-3"><div class=container><div class=row><div class="col-lg-3 mb-3"><p class=fs-5>Heimdall</p><ul class="list-unstyled small text-muted"><li class=mb-2>2022-2024 © Heimdall Project Authors. All rights reserved.</li><li class=mb-2><a href=https://github.com/dadrus/heimdall/blob/master/LICENSE>Apache 2.0 licensed</a></li></ul></div><div class="col-6 col-lg-2 offset-lg-1 mb-3"><h5>Links</h5><ul class=list-unstyled><li class=mb-2><a href=../../../>Home</a></li><li class=mb-2><a href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=mb-2><a href=../../../guides/>Guides</a></li><li class=mb-2><a href=../../../openapi/>API</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Guides</h5><ul class=list-unstyled><li class=mb-2><a href=../../../guides/proxies/>API Gateways & Proxies</a></li><li class=mb-2><a href=../../../guides/authz/>Authorization Services</a></li><li class=mb-2><a href=../../../guides/authn/>Authentication Protocols & Services</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Community</h5><ul class=list-unstyled><li class=mb-2><a href=https://github.com/dadrus/heimdall>Github</a></li><li class=mb-2><a href=https://discord.gg/qQgg8xKuyb>Discord</a></li></ul></div></div></div></footer><script src=../../../js/main.js defer></script></body></html>