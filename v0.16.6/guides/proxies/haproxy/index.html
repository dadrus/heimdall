<!doctype html><html lang=en><head><title>HAProxy Integration</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="An open source Identity Aware Proxy and an Access Control Decision service for cloud native applications"><meta name=dc.relation content="https://dadrus.github.io/"><meta name=theme-color content="#1A94D2"><link rel=stylesheet href=../../../css/styles.min.css media=screen><link rel='shortcut icon' type=image/x-icon href=../../../favicon.ico></head><body><header class="navbar navbar-expand-md navbar-dark bg-dark sticky-top"><nav class="container-xxl flex-wrap flex-lg-nowrap px-0" aria-label="Main navigation"><button class="btn btn-outline-dark d-lg-none navbar-toggler border-0 shadow-none ps-3" type=button data-bs-toggle=offcanvas data-bs-target=#docsMenuContent aria-controls=docsMenuContent aria-expanded=false aria-label="Open docs menu"><svg width="36" height="36" fill="currentcolor" class="bi bi-list" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.5 12a.5.5.0 01.5-.5h10a.5.5.0 010 1H3a.5.5.0 01-.5-.5m0-4a.5.5.0 01.5-.5h10a.5.5.0 010 1H3A.5.5.0 012.5 8m0-4a.5.5.0 01.5-.5h10a.5.5.0 010 1H3A.5.5.0 012.5 4"/></svg></button><nav class="offcanvas offcanvas-start d-md-none text-bg-light" tabindex=-1 id=docsMenuContent aria-labelledby=docsMenuContentLabel><div class=offcanvas-header><h5 class=offcanvas-title id=docsMenuContentLabel>Browse guides</h5><button type=button class=btn-close data-bs-dismiss=offcanvas aria-label="Close docs menu"></button></div><div class="offcanvas-body docs-sidebar"><div class=docs-search-button><button type=button class="btn btn-outline-secondary mb-3 d-none d-md-block w-100 text-start" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search">
<svg width="20" height="20" fill="currentcolor" class="bi bi-search me-2" viewBox="0 0 20 20"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg>
<span>Quick search...</span></button></div><nav id=SideBarToc><ul><li><span>API Gateways & Proxies</span><ul><li><a href=../../../guides/proxies/caddy/>Caddy Integration</a></li><li><a href=../../../guides/proxies/contour/>Contour Integration</a></li><li><a href=../../../guides/proxies/emissary/>Emissary Ingress Integration</a></li><li><a href=../../../guides/proxies/envoy/>Envoy Integration</a></li><li><a href=../../../guides/proxies/envoy_gateway/>Envoy Gateway Integration</a></li><li><a class=active href=../../../guides/proxies/haproxy/>HAProxy Integration</a></li><li><a href=../../../guides/proxies/istio/>Istio Service Mesh Integration</a></li><li><a href=../../../guides/proxies/nginx/>NGINX Integration</a></li><li><a href=../../../guides/proxies/traefik/>Traefik Proxy Integration</a></li></ul></li><li><span>Authorization Services</span><ul><li><a href=../../../guides/authz/opa/>Integration with OPA</a></li><li><a href=../../../guides/authz/openfga/>Integration with OpenFGA</a></li></ul></li><li><span>Authentication Protocols & Services</span><ul><li><a href=../../../guides/authn/oidc_first_party_auth/>First-Party Authentication with OpenID Connect</a></li></ul></li></ul></nav></div></nav><div class="d-flex align-items-center px-4"><a class="navbar-brand navbar-brand-highlight text-white me-0" href=../../../ style=font-weight:500;font-size:1.5rem>Heimdall</a><ul class="navbar-nav d-none d-md-flex ms-3"><li class=nav-item><a class='nav-link text-white' href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=nav-item><a class='nav-link text-white active' href=../../../guides/>Guides</a></li><li class=nav-item><a class='nav-link text-white' href=../../../openapi/>API</a></li></ul></div><div class=d-flex><button type=button class="btn btn-outline-dark navbar-toggler border-0 shadow-none" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search">
<span class="bi bi-search"></span>
</button>
<button class="btn btn-outline-dark navbar-toggler border-0 shadow-none pe-3" type=button data-bs-toggle=offcanvas data-bs-target=#mainMenuContent aria-controls=mainMenuContent aria-expanded=false aria-label="Open main menu"><svg width="24" height="24" fill="currentcolor" class="bi bi-three-dots" viewBox="0 0 16 16"><path d="M3 9.5a1.5 1.5.0 110-3 1.5 1.5.0 010 3m5 0a1.5 1.5.0 110-3 1.5 1.5.0 010 3m5 0a1.5 1.5.0 110-3 1.5 1.5.0 010 3"/></svg></button><div class="offcanvas offcanvas-end text-bg-dark" tabindex=-1 id=mainMenuContent aria-labelledby=mainMenuContentLabel><div class=offcanvas-header><h5 class="offcanvas-title text-white" id=mainMenuContentLabel>Heimdall</h5><button type=button class="btn-close btn-close-white" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class=offcanvas-body><ul class="navbar-nav flex-column d-md-none d-lg-none d-xl-none"><li class=nav-item><a class='nav-link text-white' href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=nav-item><a class='nav-link text-white active' href=../../../guides/>Guides</a></li><li class=nav-item><a class='nav-link text-white' href=../../../openapi/>API</a></li></ul><hr class="text-white-50 d-md-none"><ul class="navbar-nav flex-column ms-auto"><doc-version-select class="nav-item dropdown" version-file=/heimdall/data.json current-version=v0.16.6 current-page=/guides/proxies/haproxy/><button class="btn btn-dark dropdown-toggle me-4" data-bs-toggle=dropdown aria-expanded=false>
v0.16.6</button></doc-version-select></ul><ul class="navbar-nav flex-column"><li class="nav-item mb-1 pe-4"><a class="nav-link text-white" style=align-self:center href=https://github.com/dadrus/heimdall><svg role="img" width="20" height="20" fill="currentcolor" class="bi bi-github text-white" viewBox="0 0 16 16"><title>GitHub</title><path d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.012 8.012.0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
<small class="ms-2 d-md-none">GitHub</small></a></li></ul></div></div></div></nav></header><div class=modal id=docSearch tabindex=-1 aria-labelledby=docSearchLabel aria-hidden=true><doc-search class="col-auto me-auto mw-75" index-file=/heimdall/v0.16.6/index.json path-prefix=/heimdall/v0.16.6><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class=modal-content><div class="modal-header p-2"><div class=input-group><div class="input-group-text bg-body border-0 fs-4"><svg width="16" height="16" fill="currentcolor" class="bi bi-search text-secondary my-0" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg></div><input id=search-input class="form-control search-bar border-0" type=search placeholder="Search documentation " aria-label="Search docs..." autocomplete=off autofocus><div class="input-group-text bg-body border-0"><a class="btn input-group-text text-muted border p-1 bg-light-subtle fs-7 fw-bold font-monospace" data-bs-dismiss=modal aria-label=Close>ESC</a></div></div></div><div class=modal-body><div class=search-results><p class="text-center mt-5">No recent searches</p></div></div><div class=modal-footer></div></div></div></doc-search></div><div class="container-xxl docs-layout px-4"><aside class="d-none pe-3 docs-sidebar"><div class=docs-search-button><button type=button class="btn btn-outline-secondary mb-3 d-none d-md-block w-100 text-start" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search">
<svg width="20" height="20" fill="currentcolor" class="bi bi-search me-2" viewBox="0 0 20 20"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg>
<span>Quick search...</span></button></div><nav id=SideBarToc><ul><li><span>API Gateways & Proxies</span><ul><li><a href=../../../guides/proxies/caddy/>Caddy Integration</a></li><li><a href=../../../guides/proxies/contour/>Contour Integration</a></li><li><a href=../../../guides/proxies/emissary/>Emissary Ingress Integration</a></li><li><a href=../../../guides/proxies/envoy/>Envoy Integration</a></li><li><a href=../../../guides/proxies/envoy_gateway/>Envoy Gateway Integration</a></li><li><a class=active href=../../../guides/proxies/haproxy/>HAProxy Integration</a></li><li><a href=../../../guides/proxies/istio/>Istio Service Mesh Integration</a></li><li><a href=../../../guides/proxies/nginx/>NGINX Integration</a></li><li><a href=../../../guides/proxies/traefik/>Traefik Proxy Integration</a></li></ul></li><li><span>Authorization Services</span><ul><li><a href=../../../guides/authz/opa/>Integration with OPA</a></li><li><a href=../../../guides/authz/openfga/>Integration with OpenFGA</a></li></ul></li><li><span>Authentication Protocols & Services</span><ul><li><a href=../../../guides/authn/oidc_first_party_auth/>First-Party Authentication with OpenID Connect</a></li></ul></li></ul></nav></aside><main class=docs-main><div class="d-md-none docs-location bg-body"><nav style="--bs-breadcrumb-divider:'>'" aria-label=breadcrumb><ol class="breadcrumb mb-0"><li class="breadcrumb-item fw-bold">API Gateways & Proxies</li><li class="breadcrumb-item active" aria-current=page>HAProxy Integration</li></ol></nav></div><div class="docs-intro pt-3 pe-3"><h1>HAProxy Integration</h1><p>Explains how to integrate heimdall with HAProxy.</p></div><aside class="text-muted docs-toc"><strong class="d-md-block h6 pb-2 my-2 ms-2 border-bottom d-none d-md-none d-lg-block">On this page</strong><div id=page-content-toc class="mt-1 mb-3 text-muted d-none d-md-none d-lg-block docs-toc-content"><nav id=TableOfContents><ul><li><a href=#_vanilla_haproxy>Vanilla HAProxy</a></li><li><a href=#_haproxy_ingress_controller>HAProxy Ingress Controller</a><ul><li><a href=#_global_integration>Global integration</a></li><li><a href=#_ingress_rule_based_integration>Ingress Rule based integration</a></li></ul></li><li><a href=#_additional_resources>Additional Resources</a></li></ul></nav></div><button class="btn btn-outline-secondary text-decoration-none d-lg-none collapsed" type=button data-bs-toggle=collapse data-bs-target=#page-content-toc-collapsible aria-expanded=false aria-controls=page-content-toc-collapsible>
On this page<svg width="16" height="16" fill="currentcolor" class="bi bi-chevron-expand" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M3.646 9.146a.5.5.0 01.708.0L8 12.793l3.646-3.647a.5.5.0 01.708.708l-4 4a.5.5.0 01-.708.0l-4-4a.5.5.0 010-.708m0-2.292a.5.5.0 00.708.0L8 3.207l3.646 3.647a.5.5.0 00.708-.708l-4-4a.5.5.0 00-.708.0l-4 4a.5.5.0 000 .708"/></svg></button><div id=page-content-toc-collapsible class="mt-1 mb-3 text-muted d-lg-none collapse docs-toc-content"><div class="card card-body"><nav id=TableOfContents><ul><li><a href=#_vanilla_haproxy>Vanilla HAProxy</a></li><li><a href=#_haproxy_ingress_controller>HAProxy Ingress Controller</a><ul><li><a href=#_global_integration>Global integration</a></li><li><a href=#_ingress_rule_based_integration>Ingress Rule based integration</a></li></ul></li><li><a href=#_additional_resources>Additional Resources</a></li></ul></nav></div></div></aside><div class="docs-content pe-3"><div data-bs-spy=scroll data-bs-target=#page-content-toc class=mt-3><linkable-headline-area><div class=paragraph><p><a href=https://www.haproxy.com/>HAProxy</a> (High Availability Proxy) is a popular open source, fast, and reliable solution providing load balancer and reverse proxy features for TCP- and HTTP-based applications, capable handling heavy load traffic and rerouting requests seamlessly across multiple workloads (e.g. web, application, database).</p></div><div class=sect1><h2 id=_vanilla_haproxy>Vanilla HAProxy</h2><div class=sectionbody><div class=paragraph><p>HAProxy is highly extensible thanks to Lua scripting support. For that reason the vanilla HAProxy does not implement any means of external authorization support and requires custom Lua code to achieve integration with heimdall.</p></div></div></div><div class=sect1><h2 id=_haproxy_ingress_controller>HAProxy Ingress Controller</h2><div class=sectionbody><div class=paragraph><p>The <a href=https://haproxy-ingress.github.io/>HAProxy Ingress Controller</a> has the required <a href=https://haproxy-ingress.github.io/docs/configuration/keys/#auth-external>integration options</a> however in place. That way, delegation of authentication and authorization to heimdall operated in <a href=../../../docs/concepts/operating_modes/#_decision_mode>Decision Mode</a> is easily possible using the Ingress rule annotations as well as globally, with latter allowing implementation of secure defaults for all your workloads</p></div><div class=paragraph><p>In both cases, if heimdall answers with a 2XX code, HAProxy grants access and forwards the original request to the upstream service. Otherwise, the response from heimdall is returned to the client.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>This integration requires proper configuration of <code>trusted_proxies</code>.</td></tr></tbody></table></div><div class=sect2><h3 id=_global_integration>Global integration</h3><div class="admonitionblock warning"><table><tbody><tr><td class=icon><i class="fa icon-warning" title=Warning></i></td><td class=content>There seems to be a bug in the implementation of the HAProxy Ingress controller. Even the below description is based on the official documentation, it does not work. Corresponding ticket has been filed: <a href=https://github.com/jcmoraisjr/haproxy-ingress/issues/1105 class=bare>https://github.com/jcmoraisjr/haproxy-ingress/issues/1105</a>. Please check the status of this ticket first.</td></tr></tbody></table></div><div class=paragraph><p>To have the integration configured globally and used for all workloads, you have to add the keys shown in the snipped below to the <code>data</code> of the <a href=https://haproxy-ingress.github.io/docs/configuration/keys/#configmap>ConfigMap</a> used by the haproxy ingress controller.</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>apiVersion</span><span class=pi>:</span> <span class=s>v1</span>
<span class=na>kind</span><span class=pi>:</span> <span class=s>ConfigMap</span>
<span class=na>data</span><span class=pi>:</span>
  <span class=na>auth-url</span><span class=pi>:</span> <span class=s2>&#34;</span><span class=s>https://&lt;heimdall</span><span class=nv> </span><span class=s>service</span><span class=nv> </span><span class=s>name&gt;.&lt;namespace&gt;.svc.cluster.local:&lt;port&gt;&#34;</span> <i class=conum data-value=1></i><b>(1)</b>
  <span class=na>auth-headers-succeed</span><span class=pi>:</span> <span class=s2>&#34;</span><span class=s>authorization&#34;</span> <i class=conum data-value=2></i><b>(2)</b>
  <span class=na>headers</span><span class=pi>:</span> <span class=pi>|</span> <i class=conum data-value=3></i><b>(3)</b>
    <span class=s>X-Forwarded-Uri: %[pathq]</span>
    <span class=s>X-Forwarded-Method: %[method]</span>
    <span class=s>X-Forwarded-Host: %[req.hdr(host)]</span></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>Configures the controller to use heimdall’s main service endpoint with <code>&lt;heimdall service name></code>, <code>&lt;namespace></code> and <code>&lt;port></code> depending on your configuration.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>Let HAProxy forward the <code>Authorization</code> header set by heimdall to the upstream service upon successful response. This configuration depends on
your <a href=../../../docs/mechanisms/contextualizers/>Contextualizers</a> and <a href=../../../docs/mechanisms/finalizers/>Finalizers</a> configuration.<div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>There is currently a limitation in HAProxy Ingress Controller regarding the case-insensitivity for headers. Since heimdall returns the header in lower-case, it is important to set the names of the required to be forwarded headers in lower case as well.</td></tr></tbody></table></div></td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>Configures the required headers to pass the information about the used HTTP scheme, host and port, request path and used query parameters to be forwarded to heimdall. <code>X-Forwarded-Proto</code> is not used, as it is already set by HAProxy by default.</td></tr></tbody></table></div><div class=paragraph><p>If the installation of haproxy ingress controller happens using helm, these keys can easily be added by making use of the <code>controller.config</code> property (see also <a href=https://github.com/haproxy-ingress/charts/blob/release-0.14/haproxy-ingress/README.md#configuration>Helm chart configuration options</a> for details).</p></div></div><div class=sect2><h3 id=_ingress_rule_based_integration>Ingress Rule based integration</h3><div class=paragraph><p>The code snipped below shows the required annotations on the ingress rule. It uses the same configuration keys as the global configuration prefixed with <code>haproxy-ingress.github.io/</code></p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>annotations</span><span class=pi>:</span>
  <span class=na>haproxy-ingress.github.io/auth-url</span><span class=pi>:</span> <span class=s2>&#34;</span><span class=s>https://&lt;heimdall</span><span class=nv> </span><span class=s>service</span><span class=nv> </span><span class=s>name&gt;.&lt;namespace&gt;.svc.cluster.local:&lt;port&gt;&#34;</span>
  <span class=na>haproxy-ingress.github.io/auth-headers-succeed</span><span class=pi>:</span> <span class=s2>&#34;</span><span class=s>authorization&#34;</span>
  <span class=na>haproxy-ingress.github.io/headers</span><span class=pi>:</span> <span class=pi>|</span>
    <span class=s>X-Forwarded-Uri: %[pathq]</span>
    <span class=s>X-Forwarded-Method: %[method]</span>
    <span class=s>X-Forwarded-Host: %[req.hdr(host)]</span></code></pre></div></div></div></div></div><div class=sect1><h2 id=_additional_resources>Additional Resources</h2><div class=sectionbody><div class=paragraph><p>Checkout the examples on <a href=https://github.com/dadrus/heimdall/tree/main/examples>GitHub</a> for a working demo.</p></div></div></div></linkable-headline-area></div><p class="text-end fst-italic fs-7 pb-3">Last updated on <span class=fw-bold>Feb 17, 2025</span></p><hr><div class="d-flex justify-content-between py-3"><a href=../../../guides/proxies/envoy_gateway/ class="fs-6 fw-bold text-dark link-secondary link-underline-opacity-0"><svg width="16" height="16" fill="currentcolor" class="bi bi-chevron-left" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5.0 010 .708L5.707 8l5.647 5.646a.5.5.0 01-.708.708l-6-6a.5.5.0 010-.708l6-6a.5.5.0 01.708.0z"/></svg>
Envoy Gateway Integration
</a><a class="ms-auto fs-6 fw-bold text-dark link-secondary link-underline-opacity-0" href=../../../guides/proxies/istio/>Istio Service Mesh Integration<svg width="16" height="16" fill="currentcolor" class="bi bi-chevron-right" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5.0 01.708.0l6 6a.5.5.0 010 .708l-6 6a.5.5.0 01-.708-.708L10.293 8 4.646 2.354a.5.5.0 010-.708z"/></svg></a></div></div></main></div><footer class="footer py-4 py-md-5 px-4 px-md-3 mt-3"><div class=container><div class=row><div class="col-lg-3 mb-3"><p class=fs-5>Heimdall</p><ul class="list-unstyled small text-muted"><li class=mb-2>2022-2024 © Heimdall Project Authors. All rights reserved.</li><li class=mb-2><a href=https://github.com/dadrus/heimdall/blob/master/LICENSE>Apache 2.0 licensed</a></li></ul></div><div class="col-6 col-lg-2 offset-lg-1 mb-3"><h5>Links</h5><ul class=list-unstyled><li class=mb-2><a href=../../../>Home</a></li><li class=mb-2><a href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=mb-2><a href=../../../guides/>Guides</a></li><li class=mb-2><a href=../../../openapi/>API</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Guides</h5><ul class=list-unstyled><li class=mb-2><a href=../../../guides/proxies/>API Gateways & Proxies</a></li><li class=mb-2><a href=../../../guides/authz/>Authorization Services</a></li><li class=mb-2><a href=../../../guides/authn/>Authentication Protocols & Services</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Community</h5><ul class=list-unstyled><li class=mb-2><a href=https://github.com/dadrus/heimdall>Github</a></li><li class=mb-2><a href=https://discord.gg/qQgg8xKuyb>Discord</a></li></ul></div></div></div></footer><script src=../../../js/main.js defer></script></body></html>