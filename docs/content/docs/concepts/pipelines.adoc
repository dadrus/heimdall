---
title: "Pipelines"
date: 2022-11-29T22:29:36+02:00
draft: false
weight: 11
menu:
  docs:
    parent: "Concepts"
    weight: 1
description: Pipelines let you orchestrate existing authentication and authorization systems via mechanisms.
---

:toc:

== Overview

Pipelines are specified in link:{{< relref "/docs/concepts/rules.adoc" >}}[rules] and are used to authenticate and authorize the particular requests, as well as to handle encountered errors.

As described in the link:{{< relref "/docs/getting_started/discover_heimdall.adoc" >}}[Discover heimdall] chapter and also shown in the diagram below, central aspects of heimdall are upstream specific pipelines, which allow you to orchestrate different services to authenticate, enrich and authorize incoming HTTP requests, transform the resulting subject information into a format, or obtain credentials required for the communication with the particular upstream services.

[[_fig_heimdall_request_pipeline]]
.Authentication & Authorization Pipeline
[ditaa, format=svg]
....
                 /-----------------------------------------------------------------------------------\
                 |                                                                                   |
                 :                     Authentication & Authorization Pipeline                       |<- controlled by> --+
                 |                                                                                   |                    |
                 |+------------------+ +------------------+ +------------------+ +------------------+|                    |
                 || cCCC             | | cCCC             | | cCCC             | | cCCC             ||                    :
                 || 1. Authenticate  | | 2. Contextualize | | 3. Authorize     | | 4. Finalize      ||                    |
                 ||                  | |                  | |                  | |                  ||   +------------------+
                 |+------------------+ +------------------+ +------------------+ +------------------+|   |                  |
                 |                                                                                   |   |                  |
+------------+   |                                                                                   |   |   Microservice   |
|            |   |                                                                                   |   |                  |
|   Client   |   |                             Client Request Journey                                |   |                  |
|            |------------------------------------------------------------------------------------------>|                  |
|            |   :                                                                                   |   |                  |
|            |   \-----------------------------------------------------------------------------------/   |                  |
+------------+                                                                                           +------------------+
....

== Authentication & Authorization Pipeline

While the figure above presents four steps, the authentication and authorization pipeline is actually divided into three stages, as illustrated in the diagram below. Within each stage, you can define any number of steps, where each step represents the use of a specific link:{{< relref "/docs/concepts/mechanisms.adoc" >}}[mechanism] to fulfill that stage’s requirements.

.Pipeline Stages
[ditaa, format=svg]
....
                 /----------------------------------------------------------------------------------------\
                 |                                                                                        |
                 :                     Authentication & Authorization Pipeline                            |<- controlled by> --+
                 |                                                                                        |                    |
                 |+--------------------------+  +--------------------------+  +--------------------------+|                    |
                 || cCCC                     |  | cCCC                     |  | cCCC                     ||                    :
                 || Authentication           |  | Contextualization &      |  | Finalization             ||                    |
                 || Stage                    |  | Authorization Stage      |  | Stage                    ||                    |
                 ||                          |  |                          |  |                          ||                    |
                 ||   ---------------------+ |  |   ---------------------+ |  |   ---------------------+ ||   +----------------+-+
                 || +--------------------+ | |  | +--------------------+ | |  | +--------------------+ | ||   |                  |
                 || |     Mechanism      |-+ |  | |     Mechanism      |-+ |  | |     Mechanism      |-+ ||   |                  |
                 || +--------------------+   |  | +--------------------+   |  | +--------------------+   ||   |                  |
+------------+   |+--------------------------+  +--------------------------+  +--------------------------+|   |   Microservice   |
|            |   |           |                     |               |                                      |   |                  |
|   Client   |   |           |                     |               |  Client Request Journey              |   |                  |
|            |------------------------------------------------------------------------------------------->|   |                  |
|            |   :           :                     :               :                                      |   |                  |
|            |   |           |                     |               |                                      |   |                  |
|            |   \----------------------------------------------------------------------------------------/   |                  |
+------------+               |                     |               |                                          +------------------+
                             :                     :               :
                             v                     v               v
                  +----------------+     +----------------+     +----------------+
                  |                |-+   |                |-+   |                |-+
                  | Authentication | |   | Some other     | |   | Authorization  | |
                  |                | |   |                | |   |                | |
                  |  System        | |   |  System        | |   |  System        | |
                  |                | |   |                | |   |                | |
                  +----------------+ |   +----------------+ |   +----------------+ |
                     ----------------+      ----------------+      ----------------+
....

* **Authentication Stage:** In this stage you can define any number of steps making use of link:{{< relref "/docs/mechanisms/authenticators.adoc" >}}[authentication] mechanisms, allowing heimdall to communicate with the actual authentication systems. This may involve retrieving information about a particular authenticated principal, obtaining key material to verify authentication data provided with the request, or perform other authentication-related activities. The result of this stage is a subject object, aggregating all verified principals, which is then made available to the subsequent stages.
+
This stage is mandatory, meaning at least one authentication step must be defined. Authenticator steps may each contribute their own principal to the resulting subject, or they may target the same principal and thus form a fallback chain, where a subsequent step is only used if a previous one fails or determines that it is not responsible for the authentication data present in the request.
+
[NOTE]
====
A principal represents a single entity whose authentication data has been verified by a particular authenticator. In contrast, a subject is a higher-level construct that can consist of one or more principals and allows combining multiple authentication mechanisms (e.g., mutual TLS and a JWT) for a single request.
====

* **Authorization Stage:** In this stage you can define any number of steps that make use of link:{{< relref "/docs/mechanisms/contextualizers.adoc" >}}[contextualization] and link:{{< relref "/docs/mechanisms/authorizers.adoc" >}}[authorization] mechanisms in any order, required to satisfy your authorization needs. Here, you let heimdall communicate with other systems to collect contextual information required for authorization purposes (for example, determining the country associated with the request’s IP, retrieving subscription status of your customer, etc), and to perform the actual authorization, e.g. by talking to an Open Policy Agent, OpenFGA, any other type of authorization system, or even let heimdall perform the required checks locally.
+
This stage is optional and is executed only after the authentication stage completes successfully. Steps in this stage can optionally define conditions under which they are executed. The actual step execution happens in the order of their definitions.

* **Finalization Stage:** In this stage you can define any number of steps that make use of link:{{< relref "/docs/mechanisms/finalizers.adoc" >}}[finalization] mechanisms to complete the pipeline execution. It allows you transforming the information collected about the subject in the previous stages — the verified set of principals — into a representation expected by your upstream services, or even driving specific protocols, e.g. to obtain a token required by the upstream service.
+
This stage is optional and is executed only after the previous stage completes successfully. As with the authorization stage, steps may specify conditions controlling their execution, and they run in the order in which they are defined.

NOTE: Stages are implicit. A pipeline is simply a list of steps executed in the specified order. All steps referencing link:{{< relref "/docs/mechanisms/authenticators.adoc" >}}[authentication] mechanisms must appear before any steps referencing link:{{< relref "/docs/mechanisms/contextualizers.adoc" >}}[contextualization], link:{{< relref "/docs/mechanisms/authorizers.adoc" >}}[authorization], or link:{{< relref "/docs/mechanisms/finalizers.adoc" >}}[finalization] mechanisms, and all finalization steps must appear at the end. If this ordering is violated, heimdall will refuse to load the corresponding rule.

== Error Pipeline

The execution of any step defined in the link:{{< relref "#_authentication_authorization_pipeline" >}}[Authentication & Authorization Pipeline] may fail, which leads to the execution of the error pipeline. This pipeline is also a list of steps, but each of them references an link:{{< relref "/docs/mechanisms/error_handlers.adoc" >}}[error handler] mechanism. These mechanisms range from simple ones that return an error response to the client to more sophisticated variants that support complex logic or redirects.

Each step in the error pipeline must define a condition controlling when it is executed. The first step whose condition evaluates to `true` is executed and all remaining steps are ignored. If none of the conditions match, a default error handler is applied (see below).

The error pipeline is optional. If no error handler steps are defined, heimdall responds with an HTTP status code derived from the error raised in the Authentication & Authorization Pipeline.

