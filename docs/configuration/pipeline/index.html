<!doctype html><html><head><title>Pipeline Handler</title><meta charset=utf-8><meta name=description content="Website meta description for google search results go here"><meta name=dc.relation content="https://dadrus.github.io/"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=theme-color content="#1A94D2"><link rel=stylesheet href=../../../css/styles.min.css media=screen><link rel='shortcut icon' type=image/x-icon href=../../../favicon.ico></head><body><nav class="navbar navbar-expand-lg navbar-light bg-dark fixed-top"><div class=container><a class="navbar-brand text-white" href=../../../>Heimdall</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class=nav-item><a class='text-white nav-link' href=../../../docs/introduction/architecture>Docs</a></li><li class=nav-item><a class='text-white nav-link' href=../../../docs/api/>API</a></li><li class="nav-item dropdown"><a class='text-white nav-link dropdown-toggle' href=# id="Get Started-navbarDropdown" role=button data-bs-toggle=dropdown aria-expanded=false>Get Started</a><ul class=dropdown-menu aria-labelledby="Get Started-navbarDropdown"><li><a class=dropdown-item href=../../../docs/introduction/install/>Install</a></li><li><a class=dropdown-item href=../../../docs/introduction/quickstart/>Quickstart</a></li></ul></li></ul><a class=d-flex href=https://github.com/dadrus/heimdall><svg xmlns="http://www.w3.org/2000/svg" role="img" width="20" height="20" fill="currentcolor" class="bi bi-github text-white" viewBox="0 0 16 16"><title>GitHub</title><path d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.012 8.012.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a></div></div></nav><div id=content class=container><div class=row><div class=col-3><ul class="nav flex-column"><li class=nav-item><span class=nav-link>Introduction</span><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/introduction/architecture/>Architecture</a></li><li class=nav-item><a class=nav-link href=../../../docs/introduction/install/>Install</a></li><li class=nav-item><a class=nav-link href=../../../docs/introduction/quickstart/>Quickstart</a></li><li class=nav-item><a class=nav-link href=../../../docs/introduction/from_source/>Install from Source</a></li></ul></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/>Configuration</a><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/configuration/services/>Services</a><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/configuration/services/decision_api/>Decision API</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/services/proxy/>Proxy</a></li></ul></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/observability/>Observability</a><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/configuration/observability/logging/>Logging</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/observability/metrics/>Metrics</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/observability/tracing/>Tracing</a></li></ul></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/pipeline/>Pipeline Handler</a><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/configuration/pipeline/authenticators/>Authenticators</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/pipeline/authorizers/>Authorizers</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/pipeline/hydrators/>Hydrators</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/pipeline/mutators/>Mutators</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/pipeline/error_handlers/>Error Handlers</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/pipeline/configuration_types/>Configuration Types</a></li></ul></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/>Rules</a><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/default_rule/>Default Rule</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/rule_definition/>Rule Definition</a></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/rules/providers/>Providers</a></li></ul></li><li class=nav-item><a class=nav-link href=../../../docs/configuration/reference/>Reference</a><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/configuration/reference/configuration/>Static Configuration</a></li></ul></li></ul></li><li class=nav-item><span class=nav-link>Guides</span><ul class="nav flex-column"><li class=nav-item><a class=nav-link href=../../../docs/guides/traefik/>Traefik Proxy Integration</a></li></ul></li></ul></div><div class=col-9><h1>Pipeline Handler</h1><div><p>This section explains the available pipeline handler and mechanisms in detail. Before diving onto the details of these, we recommend to make yourself familiar with the principal architecture and components.</p><p>The general pipeline handlers are:</p><ul><li><a href=../../../docs/configuration/pipeline/authenticators/>Authenticators</a> inspect HTTP requests, like the presence of a specific cookie, which represents the authentication object of the subject with the service and execute logic required to verify the authentication status and obtain information about that subject. A subject, could be a user who tries to use particular functionality of the upstream service, a machine (if you have machine-2-machine interaction), or something different. Authenticators ensure the subject has already been authenticated and the information available about it is valid.</li><li><a href=../../../docs/configuration/pipeline/authorizers/>Authorizers</a> ensure that the subject obtained via an authenticator step has the required permissions to submit the given HTTP request and thus to execute the corresponding logic in the upstream service. E.g. a specific endpoint of the upstream service might only be accessible to a &ldquo;user&rdquo; from the &ldquo;admin&rdquo; group, or to an HTTP request if a specific HTTP header is set.</li><li><a href=../../../docs/configuration/pipeline/hydrators/>Hydrators</a> enrich the information about the subject obtained in the authenticator step with further information, required by either the endpoint of the upstream service itself or an authorizer step. This can be handy if the actual authentication system doesn&rsquo;t have all information about the subject (which is usually the case in microservice architectures), or if dynamic information about the subject, like the current location based on the IP address, is required.</li><li><a href=../../../docs/configuration/pipeline/mutators/>Mutators</a> finalize the successful execution of the pipeline and transform the available information about the subject into a format expected, respectively required by the upstream service. This ranges from adding a query parameter, to a structured JWT in a specific header.</li><li><a href=../../../docs/configuration/pipeline/error_handlers/>Error Handlers</a> are responsible for execution of logic if any of the handlers described above failed. These range from a simple error response to the client which sent the request to sophisticated handlers supporting complex logic and redirects.</li></ul><h2 id=general-configuration>General Configuration</h2><p>All of the above said handlers must be configured in the <code>pipeline</code> section of Heimdall&rsquo;s configuration as prototypes for usage in the actual rule definition. With other words only those handlers, which have been configured, can then be reused by a rule.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>pipeline</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>authenticators</span>:
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&lt;list of authenticators&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>authorizers</span>:
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&lt;list of authorizers&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hydrators</span>:
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&lt;list of hydrators&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>mutators</span>:
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&lt;list of mutators&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>error_handlers</span>:
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&lt;list of error handlers&gt;</span>
</span></span></code></pre></div><p>Each handler configuration entry must contain at least the following properties:</p><ul><li><code>id</code> - The unique identifier of a handler. Identifiers are used to reference the required handler from a rule. You can choose whatever identifier, you want. It is just a name. It must however be unique across all defined handlers of a particular general type (like authenticator, authorizer, etc.).</li><li><code>type</code> - The specific type of pipeline handler.</li></ul><p>Depending on a pipeline handler type, there can be an additional <code>config</code> property, as the name implies, for the definition of handler&rsquo;s specific configuration. Every handler specific type can be defined as many times as needed in the pipeline definition. However, for those, which don&rsquo;t have a configuration, it doesn&rsquo;t really make sense, as all of them would behave the same way.</p><p>For e.g. your authenticator definitions could look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>pipeline</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>authenticators</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>foo</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>bar</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>baz</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>bla</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>bla</span>: <span style=color:#ae81ff>bar</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>zab</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>bar</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>oof</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>bla</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>bar</span>: <span style=color:#ae81ff>bla</span>
</span></span></code></pre></div><p>The above pipeline configures two instances of an imaginary authenticator of a specific type <code>bar</code> available via ids <code>foo</code> and <code>zab</code>, as well as two instances of an imaginary authenticator of a specific type <code>bla</code> available via ids <code>baz</code> and <code>oof</code>. The <code>baz</code> and <code>oof</code> authenticators are different, as they are configured differently, but <code>foo</code> and <code>zab</code> authenticators do not have a configuration. So, they behave the same way and there is actually no need to define two instances of them.</p><p>In simplest case a rule will just reuse a handler. In more complex cases a rule can reconfigure parts of it (More about rules configuration can be found <a href=../../../docs/configuration/rules/>here</a>). Which parts can be reconfigured are handler specific and described in the documentation of each handler.</p><p>Here is an example which configures a couple of prototypes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>pipeline</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>authenticators</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>noop_authn</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>noop</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>anon_authn</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>anonymous</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>opaque_auth_token_authn</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>oauth2_introspection</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>introspection_endpoint</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>url</span>: <span style=color:#ae81ff>http://hydra:4445/oauth2/introspect</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>assertions</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>issuers</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>http://127.0.0.1:4444/</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>authorizers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>allow_all_authz</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>allow</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>deny_all_authz</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>deny</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>local_authz</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>local</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>script</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          if (!heimdall.subject.Attributes.group_manager.groups[&#34;foo&#34;]) {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            raise(&#34;user not in the expected group&#34;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          }</span>          
</span></span><span style=display:flex><span>  <span style=color:#f92672>hydrators</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>group_manager</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>generic</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>endpoint</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>url</span>: <span style=color:#ae81ff>http://group-manager.local/groups</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>method</span>: <span style=color:#ae81ff>GET</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>forward_headers</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>Authorization</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>cache_ttl</span>: <span style=color:#ae81ff>1m</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>mutators</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>noop_mut</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>noop</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>jwt_mut</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>jwt</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ttl</span>: <span style=color:#ae81ff>5m</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>claims</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              {{ $user_name := .Attributes.identity.user_name -}}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              &#34;email&#34;: {{ quote .Attributes.identity.email }},
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              &#34;email_verified&#34;: {{ .Attributes.identity.email_verified }},
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              {{ if $user_name -}}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              &#34;name&#34;: {{ quote $user_name }}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              {{ else -}}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              &#34;name&#34;: {{ quote $email }}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              {{ end -}}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            }</span>            
</span></span><span style=display:flex><span>  <span style=color:#f92672>error_handlers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>authenticate_with_kratos</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>redirect</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>to</span>: <span style=color:#ae81ff>http://127.0.0.1:4433/self-service/login/browser</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>return_to_query_parameter</span>: <span style=color:#ae81ff>return_to</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>when</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>error</span>:
</span></span><span style=display:flex><span>              - <span style=color:#ae81ff>unauthorized</span>
</span></span><span style=display:flex><span>              - <span style=color:#ae81ff>forbidden</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>request_headers</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>Accept</span>:
</span></span><span style=display:flex><span>                - <span style=color:#ae81ff>text/html</span>
</span></span></code></pre></div><h2 id=templating>Templating</h2><p>Some pipeline handlers support templating using <a href=https://golang.org/pkg/text/template/>Golang Text Templates</a>. To ease the usage, all <a href=http://masterminds.github.io/sprig/>sprig</a> functions as well as a <code>urlenc</code> function are available. Latter is handy if you need to add e.g. a query parameter to the original request and encode it properly. In addition to the above said functions, heimdall makes the following objects available to the template:</p><ul><li><code>subject</code> - to provide access to all attributes available for the given subject. The access is read only.</li><li><code>ctx</code> - to provide access to the actual HTTP request, like headers, cookies, URL, etc. The access is read only</li></ul><p>Examples are provided as part of handler description supporting scripting.</p><h2 id=scripting>Scripting</h2><p>Some authorizers, which verify the presence or values of particular attributes of the subject can make use of <a href=https://262.ecma-international.org/5.1/>ECMAScript 5.1(+)</a>. Heimdall uses <a href=https://github.com/dop251/goja>goja</a> as ECMAScript engine. In addition to the general ECMAScript functionality, heimdall makes the following functions and object available to the script:</p><ul><li><code>console.log</code> - to log the activities in the script. Can become handy during development of debugging. The output is only available if <code>debug</code> log level is set.</li><li><code>heimdall.subject</code> - to provide access to all attributes available for the given subject. The access is read only.</li><li><code>heimdall.ctx</code> - to provide access to the actual HTTP request, like headers, cookies, URL, etc. You can only add new elements (like headers, query parameter), but not change existing.</li></ul><p>Examples are provided as part of handler description supporting scripting.</p></div></div></div></div><footer class="footer py-4 py-md-5 px-4 px-md-3"><div class=container><div class=row><div class="col-lg-3 mb-3"><p class=fs-5>Heimdall</p><ul class="list-unstyled small text-muted"><li class=mb-2>2022 Â© Heimdall Project Authors. All rights reserved.</li><li class=mb-2><a href=https://github.com/dadrus/heimdall/blob/master/LICENSE>Apache 2.0 licensed</a></li></ul></div><div class="col-6 col-lg-2 offset-lg-1 mb-3"><h5>Links</h5><ul class=list-unstyled><li class=mb-2><a href=../../../>Home</a></li><li class=mb-2><a href=../../../>Docs</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Guides</h5><ul class=list-unstyled><li class=mb-2><a href=../../../>Install</a></li><li class=mb-2><a href=../../../>Getting Started</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Community</h5><ul class=list-unstyled><li class=mb-2><a href=https://github.com/dadrus/heimdall>Github</a></li><li class=mb-2><a href=https://github.com/dadrus/heimdall/issues>Issues</a></li><li class=mb-2><a href=https://github.com/dadrus/heimdall/discussions>Discussions</a></li></ul></div></div></div><script src=../../../js/bundle.min.js defer></script></footer></body></html>