<!doctype html><html lang=en><head><title>Integration with OpenFGA</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="An open source Identity Aware Proxy and an Access Control Decision service for cloud native applications"><meta name=dc.relation content="https://dadrus.github.io/"><meta name=theme-color content="#1A94D2"><link rel=stylesheet href=../../../css/styles.min.css media=screen><link rel='shortcut icon' type=image/x-icon href=../../../favicon.ico></head><body><header class="navbar navbar-expand-md navbar-dark bg-dark sticky-top"><nav class="container-xxl flex-wrap flex-lg-nowrap px-0" aria-label="Main navigation"><button class="btn btn-outline-dark d-lg-none navbar-toggler border-0 shadow-none ps-3" type=button data-bs-toggle=offcanvas data-bs-target=#docsMenuContent aria-controls=docsMenuContent aria-expanded=false aria-label="Open docs menu"><svg width="36" height="36" fill="currentcolor" class="bi bi-list" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.5 12a.5.5.0 01.5-.5h10a.5.5.0 010 1H3a.5.5.0 01-.5-.5m0-4a.5.5.0 01.5-.5h10a.5.5.0 010 1H3A.5.5.0 012.5 8m0-4a.5.5.0 01.5-.5h10a.5.5.0 010 1H3A.5.5.0 012.5 4"/></svg></button><nav class="offcanvas offcanvas-start d-md-none text-bg-light" tabindex=-1 id=docsMenuContent aria-labelledby=docsMenuContentLabel><div class=offcanvas-header><h5 class=offcanvas-title id=docsMenuContentLabel>Browse guides</h5><button type=button class=btn-close data-bs-dismiss=offcanvas aria-label="Close docs menu"></button></div><div class="offcanvas-body docs-sidebar"><div class=docs-search-button><button type=button class="btn btn-outline-secondary mb-3 d-none d-md-block w-100 text-start" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search">
<svg width="20" height="20" fill="currentcolor" class="bi bi-search me-2" viewBox="0 0 20 20"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg>
<span>Quick search...</span></button></div><nav id=SideBarToc><ul><li><span>API Gateways & Proxies</span><ul><li><a href=../../../guides/proxies/caddy/>Caddy Integration</a></li><li><a href=../../../guides/proxies/contour/>Contour Integration</a></li><li><a href=../../../guides/proxies/emissary/>Emissary Ingress Integration</a></li><li><a href=../../../guides/proxies/envoy/>Envoy Integration</a></li><li><a href=../../../guides/proxies/envoy_gateway/>Envoy Gateway Integration</a></li><li><a href=../../../guides/proxies/haproxy/>HAProxy Integration</a></li><li><a href=../../../guides/proxies/istio/>Istio Service Mesh Integration</a></li><li><a href=../../../guides/proxies/nginx/>NGINX Integration</a></li><li><a href=../../../guides/proxies/traefik/>Traefik Proxy Integration</a></li></ul></li><li><span>Authorization Services</span><ul><li><a href=../../../guides/authz/opa/>Integration with OPA</a></li><li><a class=active href=../../../guides/authz/openfga/>Integration with OpenFGA</a></li></ul></li><li><span>Authentication Protocols & Services</span><ul><li><a href=../../../guides/authn/oidc_first_party_auth/>First-Party Authentication with OpenID Connect</a></li></ul></li></ul></nav></div></nav><div class="d-flex align-items-center px-4"><a class="navbar-brand navbar-brand-highlight text-white me-0" href=../../../ style=font-weight:500;font-size:1.5rem>Heimdall</a><ul class="navbar-nav d-none d-md-flex ms-3"><li class=nav-item><a class='nav-link text-white' href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=nav-item><a class='nav-link text-white active' href=../../../guides/>Guides</a></li><li class=nav-item><a class='nav-link text-white' href=../../../openapi/>API</a></li></ul></div><div class=d-flex><button type=button class="btn btn-outline-dark navbar-toggler border-0 shadow-none" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search">
<span class="bi bi-search"></span>
</button>
<button class="btn btn-outline-dark navbar-toggler border-0 shadow-none pe-3" type=button data-bs-toggle=offcanvas data-bs-target=#mainMenuContent aria-controls=mainMenuContent aria-expanded=false aria-label="Open main menu"><svg width="24" height="24" fill="currentcolor" class="bi bi-three-dots" viewBox="0 0 16 16"><path d="M3 9.5a1.5 1.5.0 110-3 1.5 1.5.0 010 3m5 0a1.5 1.5.0 110-3 1.5 1.5.0 010 3m5 0a1.5 1.5.0 110-3 1.5 1.5.0 010 3"/></svg></button><div class="offcanvas offcanvas-end text-bg-dark" tabindex=-1 id=mainMenuContent aria-labelledby=mainMenuContentLabel><div class=offcanvas-header><h5 class="offcanvas-title text-white" id=mainMenuContentLabel>Heimdall</h5><button type=button class="btn-close btn-close-white" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class=offcanvas-body><ul class="navbar-nav flex-column d-md-none d-lg-none d-xl-none"><li class=nav-item><a class='nav-link text-white' href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=nav-item><a class='nav-link text-white active' href=../../../guides/>Guides</a></li><li class=nav-item><a class='nav-link text-white' href=../../../openapi/>API</a></li></ul><hr class="text-white-50 d-md-none"><ul class="navbar-nav flex-column ms-auto"><doc-version-select class="nav-item dropdown" version-file=/heimdall/data.json current-version=dev current-page=/guides/authz/openfga/><button class="btn btn-dark dropdown-toggle me-4" data-bs-toggle=dropdown aria-expanded=false>
dev</button></doc-version-select></ul><ul class="navbar-nav flex-column"><li class="nav-item mb-1 pe-4"><a class="nav-link text-white" style=align-self:center href=https://github.com/dadrus/heimdall><svg role="img" width="20" height="20" fill="currentcolor" class="bi bi-github text-white" viewBox="0 0 16 16"><title>GitHub</title><path d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.012 8.012.0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
<small class="ms-2 d-md-none">GitHub</small></a></li></ul></div></div></div></nav></header><div class=modal id=docSearch tabindex=-1 aria-labelledby=docSearchLabel aria-hidden=true><doc-search class="col-auto me-auto mw-75" index-file=/heimdall/dev/index.json path-prefix=/heimdall/dev><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class=modal-content><div class="modal-header p-2"><div class=input-group><div class="input-group-text bg-body border-0 fs-4"><svg width="16" height="16" fill="currentcolor" class="bi bi-search text-secondary my-0" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg></div><input id=search-input class="form-control search-bar border-0" type=search placeholder="Search documentation " aria-label="Search docs..." autocomplete=off autofocus><div class="input-group-text bg-body border-0"><a class="btn input-group-text text-muted border p-1 bg-light-subtle fs-7 fw-bold font-monospace" data-bs-dismiss=modal aria-label=Close>ESC</a></div></div></div><div class=modal-body><div class=search-results><p class="text-center mt-5">No recent searches</p></div></div><div class=modal-footer></div></div></div></doc-search></div><div class="container-xxl docs-layout px-4"><aside class="d-none pe-3 docs-sidebar"><div class=docs-search-button><button type=button class="btn btn-outline-secondary mb-3 d-none d-md-block w-100 text-start" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search">
<svg width="20" height="20" fill="currentcolor" class="bi bi-search me-2" viewBox="0 0 20 20"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg>
<span>Quick search...</span></button></div><nav id=SideBarToc><ul><li><span>API Gateways & Proxies</span><ul><li><a href=../../../guides/proxies/caddy/>Caddy Integration</a></li><li><a href=../../../guides/proxies/contour/>Contour Integration</a></li><li><a href=../../../guides/proxies/emissary/>Emissary Ingress Integration</a></li><li><a href=../../../guides/proxies/envoy/>Envoy Integration</a></li><li><a href=../../../guides/proxies/envoy_gateway/>Envoy Gateway Integration</a></li><li><a href=../../../guides/proxies/haproxy/>HAProxy Integration</a></li><li><a href=../../../guides/proxies/istio/>Istio Service Mesh Integration</a></li><li><a href=../../../guides/proxies/nginx/>NGINX Integration</a></li><li><a href=../../../guides/proxies/traefik/>Traefik Proxy Integration</a></li></ul></li><li><span>Authorization Services</span><ul><li><a href=../../../guides/authz/opa/>Integration with OPA</a></li><li><a class=active href=../../../guides/authz/openfga/>Integration with OpenFGA</a></li></ul></li><li><span>Authentication Protocols & Services</span><ul><li><a href=../../../guides/authn/oidc_first_party_auth/>First-Party Authentication with OpenID Connect</a></li></ul></li></ul></nav></aside><main class=docs-main><div class="d-md-none docs-location bg-body"><nav style="--bs-breadcrumb-divider:'>'" aria-label=breadcrumb><ol class="breadcrumb mb-0"><li class="breadcrumb-item fw-bold">Authorization Services</li><li class="breadcrumb-item active" aria-current=page>Integration with OpenFGA</li></ol></nav></div><div class="docs-intro pt-3 pe-3"><h1>Integration with OpenFGA</h1><p>This guide explains how to integrate heimdall with the OpenFGA, a scalable open source authorization system.</p></div><aside class="text-muted docs-toc"><strong class="d-md-block h6 pb-2 my-2 ms-2 border-bottom d-none d-md-none d-lg-block">On this page</strong><div id=page-content-toc class="mt-1 mb-3 text-muted d-none d-md-none d-lg-block docs-toc-content"><nav id=TableOfContents><ul><li><a href=#_prerequisites>Prerequisites</a></li><li><a href=#_configure_the_base_setup>Configure the Base Setup</a></li><li><a href=#_create_authorization_model_rules>Create Authorization Model & Rules</a></li><li><a href=#_update_relationship_tuples>Update Relationship Tuples</a></li><li><a href=#_use_the_setup>Use the Setup</a></li><li><a href=#_cleanup>Cleanup</a></li></ul></nav></div><button class="btn btn-outline-secondary text-decoration-none d-lg-none collapsed" type=button data-bs-toggle=collapse data-bs-target=#page-content-toc-collapsible aria-expanded=false aria-controls=page-content-toc-collapsible>
On this page<svg width="16" height="16" fill="currentcolor" class="bi bi-chevron-expand" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M3.646 9.146a.5.5.0 01.708.0L8 12.793l3.646-3.647a.5.5.0 01.708.708l-4 4a.5.5.0 01-.708.0l-4-4a.5.5.0 010-.708m0-2.292a.5.5.0 00.708.0L8 3.207l3.646 3.647a.5.5.0 00.708-.708l-4-4a.5.5.0 00-.708.0l-4 4a.5.5.0 000 .708"/></svg></button><div id=page-content-toc-collapsible class="mt-1 mb-3 text-muted d-lg-none collapse docs-toc-content"><div class="card card-body"><nav id=TableOfContents><ul><li><a href=#_prerequisites>Prerequisites</a></li><li><a href=#_configure_the_base_setup>Configure the Base Setup</a></li><li><a href=#_create_authorization_model_rules>Create Authorization Model & Rules</a></li><li><a href=#_update_relationship_tuples>Update Relationship Tuples</a></li><li><a href=#_use_the_setup>Use the Setup</a></li><li><a href=#_cleanup>Cleanup</a></li></ul></nav></div></div></aside><div class="docs-content pe-3"><div data-bs-spy=scroll data-bs-target=#page-content-toc class=mt-3><linkable-headline-area><div class=paragraph><p><a href=https://openfga.dev>OpenFGA</a> is inspired by <a href=https://zanzibar.academy/>Google’s Zanzibar</a>, Google’s Relationship Based Access Control system and allows easily implementing authorization for any kind of application relying on Role-Based Access Control with additional Attribute-Based Access Control capabilities.</p></div><div class=paragraph><p>This guide is based on the OpenFGA’s official <a href=https://openfga.dev/docs/getting-started>Getting Started</a> guide and highlights the relevant differences. It mimics a RESTful document management API, allowing listing, creating, reading, updating, and deleting documents. The API consists of two endpoints:</p></div><div class=ulist><ul><li><p><code>/document/&lt;id></code> with <code>id</code> being the id of the document and the HTTP verbs reflecting the actual operations. E.g. a <code>GET /document/1234</code> request should read the document with the id <code>1234</code>.</p></li><li><p><code>/documents</code> which supports the HTTP <code>GET</code> verb only and allows the user to list the documents it can access.</p></li></ul></div><div class=paragraph><p>The identity of the user will be taken from a JWT.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>Even this guide addresses OpenFGA, it actually covers integration with any ReBAC system, be it Ory’s <a href=https://www.ory.sh/keto/>Keto</a>, <a href=https://authzed.com/spicedb>SpiceDB</a> from AuthZed, or any other system inspired by Google’s Zanzibar.</td></tr></tbody></table></div><div class=sect1><h2 id=_prerequisites>Prerequisites</h2><div class=sectionbody><div class=paragraph><p>To be able to follow this guide, you’ll need the following tools installed locally:</p></div><div class=ulist><ul><li><p><a href=https://docs.docker.com/install/>Docker</a>,</p></li><li><p><a href=https://docs.docker.com/compose/install/>docker-compose</a>, and</p></li><li><p>a text editor of your choice.</p></li></ul></div></div></div><div class=sect1><h2 id=_configure_the_base_setup>Configure the Base Setup</h2><div class=sectionbody><div class="olist arabic"><ol class=arabic><li><p>Create a directory in which we’re going to create further directories and files required for the setup and switch to it.</p></li><li><p>Create a directory named <code>rules</code>. We’ll add the heimdall rule to it after our setup is started.</p></li><li><p>Create a <code>docker-compose.yaml</code> file with the following contents</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>services</span><span class=pi>:</span>
  <span class=na>heimdall</span><span class=pi>:</span> <i class=conum data-value=1></i><b>(1)</b>
    <span class=na>image</span><span class=pi>:</span> <span class=s>dadrus/heimdall:dev</span>
    <span class=na>container_name</span><span class=pi>:</span> <span class=s>heimdall</span>
    <span class=na>ports</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s2>&#34;</span><span class=s>9090:4456&#34;</span>
    <span class=na>volumes</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s>./heimdall-config.yaml:/etc/heimdall/config.yaml:ro</span>
    <span class=pi>-</span> <span class=s>./rules:/etc/heimdall/rules:ro</span>
    <span class=pi>-</span> <span class=s>./signer.pem:/etc/heimdall/signer.pem:ro</span>
    <span class=na>command</span><span class=pi>:</span> <span class=s>serve proxy -c /etc/heimdall/config.yaml --insecure</span>

  <span class=na>upstream</span><span class=pi>:</span> <i class=conum data-value=2></i><b>(2)</b>
    <span class=na>image</span><span class=pi>:</span> <span class=s>traefik/whoami:latest</span>
    <span class=na>container_name</span><span class=pi>:</span> <span class=s>upstream</span>
    <span class=na>command</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s>--port=8081</span>

  <span class=na>openfga</span><span class=pi>:</span> <i class=conum data-value=3></i><b>(3)</b>
    <span class=na>image</span><span class=pi>:</span> <span class=s>openfga/openfga:latest</span>
    <span class=na>container_name</span><span class=pi>:</span> <span class=s>openfga</span>
    <span class=na>command</span><span class=pi>:</span> <span class=s>run</span>
    <span class=na>ports</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=s2>&#34;</span><span class=s>8080:8080&#34;</span>

  <span class=na>idp</span><span class=pi>:</span> <i class=conum data-value=4></i><b>(4)</b>
    <span class=na>image</span><span class=pi>:</span> <span class=s>nginx:1.25.4</span>
    <span class=na>volumes</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s>./idp.nginx:/etc/nginx/nginx.conf:ro</span>
    <span class=pi>-</span> <span class=s>./jwks.json:/var/www/nginx/jwks.json:ro</span></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>These lines configure heimdall to use a config file, we’re going to configure next and a rule directory, we’ll add our rules to.<div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>We’re using the <code>--insecure</code> flag here to simplify our setup, which disables enforcement of some security settings you can learn about more <a href=../../../docs/operations/security/#_defaults>here</a>.</td></tr></tbody></table></div></td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>Here, we define the "upstream" service, which just echoes back everything it receives.</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>And these lines configure our OpenFGA instance. It is the simplest setup, described in <a href=https://openfga.dev/docs/getting-started/setup-openfga/docker>Setup OpenFGA with Docker</a></td></tr><tr><td><i class=conum data-value=4></i><b>4</b></td><td>This is an NGINX service, which mimics an IDP system and exposes an JWKS endpoint with key material, heimdall is going to use to validate the JWT you’re going to use.</td></tr></tbody></table></div></li><li><p>Create a configuration file for heimdall, named <code>heimdall-config.yaml</code> with the following contents.</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>mechanisms</span><span class=pi>:</span>
  <span class=na>authenticators</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>jwt_auth</span> <i class=conum data-value=1></i><b>(1)</b>
      <span class=na>type</span><span class=pi>:</span> <span class=s>jwt</span>
      <span class=na>config</span><span class=pi>:</span>
        <span class=na>jwks_endpoint</span><span class=pi>:</span> <span class=s>http://idp:8080/.well-known/jwks</span>
        <span class=na>assertions</span><span class=pi>:</span>
          <span class=na>issuers</span><span class=pi>:</span>
            <span class=pi>-</span> <span class=s>demo_issuer</span>
  <span class=na>authorizers</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>openfga_check</span> <i class=conum data-value=2></i><b>(2)</b>
      <span class=na>type</span><span class=pi>:</span> <span class=s>remote</span>
      <span class=na>config</span><span class=pi>:</span>
        <span class=na>endpoint</span><span class=pi>:</span> <span class=s>http://openfga:8080/stores/{{ .Values.store_id }}/check</span> <i class=conum data-value=3></i><b>(3)</b>
        <span class=na>payload</span><span class=pi>:</span> <span class=pi>|</span> <i class=conum data-value=4></i><b>(4)</b>
          <span class=s>{</span>
            <span class=s>&#34;authorization_model_id&#34;: &#34;{{ .Values.model_id }}&#34;,</span>
            <span class=s>&#34;tuple_key&#34;: {</span>
              <span class=s>&#34;user&#34;: &#34;user:{{ .Subject.ID }}&#34;,</span>
              <span class=s>&#34;relation&#34;:&#34;{{ .Values.relation }}&#34;,</span>
              <span class=s>&#34;object&#34;:&#34;{{ .Values.object }}&#34;</span>
            <span class=s>}</span>
          <span class=s>}</span>
        <span class=na>expressions</span><span class=pi>:</span>
          <span class=pi>-</span> <span class=na>expression</span><span class=pi>:</span> <span class=pi>|</span>
              <span class=s>Payload.allowed == true </span><i class=conum data-value=5></i><b>(5)</b>
  <span class=na>contextualizers</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>openfga_list</span> <i class=conum data-value=6></i><b>(6)</b>
      <span class=na>type</span><span class=pi>:</span> <span class=s>generic</span>
      <span class=na>config</span><span class=pi>:</span>
        <span class=na>endpoint</span><span class=pi>:</span> <span class=s>http://openfga:8080/stores/{{ .Values.store_id }}/list-objects</span> <i class=conum data-value=7></i><b>(7)</b>
        <span class=na>payload</span><span class=pi>:</span> <span class=pi>|</span> <i class=conum data-value=8></i><b>(8)</b>
          <span class=s>{</span>
            <span class=s>&#34;authorization_model_id&#34;: &#34;{{ .Values.model_id }}&#34;,</span>
            <span class=s>&#34;user&#34;: &#34;user:{{ .Subject.ID }}&#34;,</span>
            <span class=s>&#34;relation&#34;:&#34;{{ .Values.relation }}&#34;,</span>
            <span class=s>&#34;type&#34;:&#34;document&#34;</span>
          <span class=s>}</span>
  <span class=na>finalizers</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>create_jwt</span> <i class=conum data-value=9></i><b>(9)</b>
      <span class=na>type</span><span class=pi>:</span> <span class=s>jwt</span>
      <span class=na>config</span><span class=pi>:</span>
        <span class=na>signer</span><span class=pi>:</span>
          <span class=na>key_store</span><span class=pi>:</span>
            <span class=na>path</span><span class=pi>:</span> <span class=s>/etc/heimdall/signer.pem</span>

<span class=na>providers</span><span class=pi>:</span>
  <span class=na>file_system</span><span class=pi>:</span> <i class=conum data-value=10></i><b>(10)</b>
    <span class=na>src</span><span class=pi>:</span> <span class=s>/etc/heimdall/rules</span>
    <span class=na>watch</span><span class=pi>:</span> <span class=kc>true</span></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>This and the following lines define and configure the <code><a href=../../../docs/mechanisms/authenticators/#_jwt>jwt</a></code> authenticator named <code>jwt_auth</code>. With the given configuration it will check whether a request contains an <code>Authorization</code> header with a bearer token in JWT format and validate it using key material fetched from the JWKS endpoint.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>Here we define and configure a <code><a href=../../../docs/mechanisms/authorizers/#_remote>remote</a></code> authorizer named <code>openfga_check</code>, which we’re going to use for the actual authorization purposes in our rules.</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>Here we define the endpoint to be used for the authorization checks. Most probably, you’ll want to hard code your OpenFGA model id. Since, we’re going to create the model, when we start our setup, we’ll reference it in our rule via <code>store_id</code>.<div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>We use a very simple <code><a href=../../../docs/configuration/types/#_endpoint>endpoint</a></code> configuration here by just specifying the actual url. If required, you can specify API keys, and many more. Take a look at the linked documentation of this property.</td></tr></tbody></table></div></td></tr><tr><td><i class=conum data-value=4></i><b>4</b></td><td>This is the definition of our payload to be sent to the check endpoint. As we don’t know the model id as well, we’ll configure it in our rule. The user will be taken from the <code>Subject</code> create by heimdall, and the relation and object will be specified in our rule.</td></tr><tr><td><i class=conum data-value=5></i><b>5</b></td><td>In case of a successful response, the response from the check endpoint will look like <code>{"allowed": true}</code>. Otherwise, it will be <code>{"allowed": false}</code>. With the expression here, we perform the required verification.</td></tr><tr><td><i class=conum data-value=6></i><b>6</b></td><td>Here we define and configure a <code><a href=../../../docs/mechanisms/contextualizers/#_generic>generic</a></code> contextualizer named <code>openfga_list</code>.</td></tr><tr><td><i class=conum data-value=7></i><b>7</b></td><td>As with the authorization mechanism, defined above, here we configure the endpoint to list the allowed objects.</td></tr><tr><td><i class=conum data-value=8></i><b>8</b></td><td>The payload configuration used while communicating to the configured endpoint.</td></tr><tr><td><i class=conum data-value=9></i><b>9</b></td><td>The following two lines define the <code><a href=../../../docs/mechanisms/finalizers/#_jwt>jwt</a></code> finalizer. With the given configuration, it will create a jwt out of the subject object with standard claims and set the <code>sub</code> claim to the value of subject’s ID.</td></tr><tr><td><i class=conum data-value=10></i><b>10</b></td><td>The last few lines of the configure the <code><a href=../../../docs/rules/providers/#_filesystem>file_system</a></code> provider, which allows loading of regular rules from the file system.</td></tr></tbody></table></div></li><li><p>Create a file, named <code>signer.pem</code> with the following content. This is our key store with a private key, you’ve seen in the configuration above.</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=s>-----BEGIN EC PRIVATE KEY-----</span>
<span class=s>MIGkAgEBBDALv/dRp6zvm6nmozmB/21viwFCUGBoisHz0v8LSRXGiM5aDywLFmMy</span>
<span class=s>1jPnw29tz36gBwYFK4EEACKhZANiAAQgZkUS7PCh5tEXXvZk0LDQ4Xn4LSK+vKkI</span>
<span class=s>zlCZl+oMgud8gacf4uG5ERgju1xdUyfewsXlwepTnWuwhXM7GdnwY5GOxZTwGn3X</span>
<span class=s>XVwR/5tokqFVrFxt/5c1x7VdccF4nNM=</span>
<span class=s>-----END EC PRIVATE KEY-----</span></code></pre></div></div><div class="admonitionblock warning"><table><tbody><tr><td class=icon><i class="fa icon-warning" title=Warning></i></td><td class=content>Do not use it for purposes beyond this tutorial!</td></tr></tbody></table></div></li><li><p>Configure NGINX to expose a static endpoint serving a JWKS document under the <code>.well-known</code> path, so heimdall is able to verify the JWT, we’re going to use. Create a file named <code>idp.nginx</code> with the following content:</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=bash>worker_processes  1<span class=p>;</span>
user       nginx<span class=p>;</span>
pid        /var/run/nginx.pid<span class=p>;</span>

events <span class=o>{</span>
  worker_connections  1024<span class=p>;</span>
<span class=o>}</span>

http <span class=o>{</span>
    keepalive_timeout  65<span class=p>;</span>

    server <span class=o>{</span>
        listen 8080<span class=p>;</span>

        location /.well-known/jwks <span class=o>{</span>
            default_type  application/json<span class=p>;</span>
            root /var/www/nginx<span class=p>;</span>
            try_files /jwks.json <span class=o>=</span>404<span class=p>;</span>
        <span class=o>}</span>
    <span class=o>}</span>
<span class=o>}</span></code></pre></div></div><div class=paragraph><p>In addition, create a file named <code>jwks.json</code> with the public key required to verify the tokens we’re going to use.</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=json><span class=p>{</span><span class=w>
  </span><span class=nl>&#34;keys&#34;</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w>
    </span><span class=p>{</span><span class=w>
      </span><span class=nl>&#34;use&#34;</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;sig&#34;</span><span class=p>,</span><span class=w>
      </span><span class=nl>&#34;kty&#34;</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;EC&#34;</span><span class=p>,</span><span class=w>
      </span><span class=nl>&#34;kid&#34;</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;key-2&#34;</span><span class=p>,</span><span class=w>
      </span><span class=nl>&#34;crv&#34;</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;P-256&#34;</span><span class=p>,</span><span class=w>
      </span><span class=nl>&#34;alg&#34;</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;ES256&#34;</span><span class=p>,</span><span class=w>
      </span><span class=nl>&#34;x&#34;</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NnU0iWRq7szZP_8Ir3D4BShUEtcW1dHpuvlCgB6ecE0&#34;</span><span class=p>,</span><span class=w>
      </span><span class=nl>&#34;y&#34;</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;X71tZm51ovUPFNKE0bsi5XF-FtIykEfk1O83EHNkSdo&#34;</span><span class=w>
    </span><span class=p>}</span><span class=w>
  </span><span class=p>]</span><span class=w>
</span><span class=p>}</span></code></pre></div></div></li></ol></div></div></div><div class=sect1><h2 id=_create_authorization_model_rules>Create Authorization Model & Rules</h2><div class=sectionbody><div class=paragraph><p>The static configuration of our services is in place. Let us now create the actual authorization model and based on it the required heimdall rules.</p></div><div class="olist arabic"><ol class=arabic><li><p>Start our setup with <code>docker compose up</code> and wait until all services are up and running.</p></li><li><p>Create the OpenFGA store as also described in <a href=https://openfga.dev/docs/getting-started/create-store>Create Store</a> with</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=bash>curl <span class=nt>-X</span> POST http://127.0.0.1:8080/stores <span class=se>\</span>
  <span class=nt>-H</span> <span class=s2>&#34;content-type: application/json&#34;</span> <span class=se>\</span>
  <span class=nt>-d</span> <span class=s1>&#39;{&#34;name&#34;: &#34;FGA Demo Store&#34;}&#39;</span></code></pre></div></div><div class=paragraph><p>This call should result in an output similar to</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=json><span class=p>{</span><span class=w>
  </span><span class=nl>&#34;id&#34;</span><span class=p>:</span><span class=s2>&#34;01HSXG2XSZJMQG99EVXB4QQX8P&#34;</span><span class=p>,</span><span class=w>
  </span><span class=nl>&#34;name&#34;</span><span class=p>:</span><span class=s2>&#34;FGA Demo Store&#34;</span><span class=p>,</span><span class=w>
  </span><span class=nl>&#34;created_at&#34;</span><span class=p>:</span><span class=s2>&#34;2024-03-26T13:44:37.439559338Z&#34;</span><span class=p>,</span><span class=w>
  </span><span class=nl>&#34;updated_at&#34;</span><span class=p>:</span><span class=s2>&#34;2024-03-26T13:44:37.439559338Z&#34;</span><span class=w>
</span><span class=p>}</span></code></pre></div></div><div class=paragraph><p>Note or write down the value of the store <code>id</code> returned.</p></div></li><li><p>Configure the authorization model as also described in <a href=https://openfga.dev/docs/getting-started/configure-model>Configure Model</a> with</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=bash>curl <span class=nt>-X</span> POST http://127.0.0.1:8080/stores/&lt;the <span class=nb>id </span>from above&gt;/authorization-models <span class=se>\</span>
  <span class=nt>-H</span> <span class=s2>&#34;content-type: application/json&#34;</span> <span class=se>\</span>
  <span class=nt>-d</span> <span class=s1>&#39;{&#34;schema_version&#34;:&#34;1.1&#34;,&#34;type_definitions&#34;:[{&#34;type&#34;:&#34;user&#34;},{&#34;type&#34;:&#34;document&#34;,&#34;relations&#34;:{&#34;reader&#34;:{&#34;this&#34;:{}},&#34;writer&#34;:{&#34;this&#34;:{}},&#34;owner&#34;:{&#34;this&#34;:{}}},&#34;metadata&#34;:{&#34;relations&#34;:{&#34;reader&#34;:{&#34;directly_related_user_types&#34;:[{&#34;type&#34;:&#34;user&#34;}]},&#34;writer&#34;:{&#34;directly_related_user_types&#34;:[{&#34;type&#34;:&#34;user&#34;}]},&#34;owner&#34;:{&#34;directly_related_user_types&#34;:[{&#34;type&#34;:&#34;user&#34;}]}}}}]}&#39;</span></code></pre></div></div><div class=paragraph><p>This call should result in an output similar to</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=json><span class=p>{</span><span class=w>
  </span><span class=nl>&#34;authorization_model_id&#34;</span><span class=p>:</span><span class=s2>&#34;01HSXG7TBQEJ7GBPKQR2VYH24G&#34;</span><span class=w>
</span><span class=p>}</span></code></pre></div></div><div class=paragraph><p>Note or write down the value of <code>authorization_model_id</code>.</p></div></li><li><p>Let us now create a rule set for heimdall. Create a file named <code>demo.yaml</code> with the following contents in the <code>rules</code> directory</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>version</span><span class=pi>:</span> <span class=s2>&#34;</span><span class=s>1beta1&#34;</span>
<span class=na>rules</span><span class=pi>:</span>
<span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>access_document</span>  <i class=conum data-value=1></i><b>(1)</b>
  <span class=na>match</span><span class=pi>:</span>
    <span class=na>routes</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=na>path</span><span class=pi>:</span> <span class=s>/document/:id</span> <i class=conum data-value=2></i><b>(2)</b>
    <span class=na>methods</span><span class=pi>:</span> <span class=pi>[</span> <span class=nv>GET</span><span class=pi>,</span> <span class=nv>POST</span><span class=pi>,</span> <span class=nv>DELETE</span> <span class=pi>]</span>
  <span class=na>forward_to</span><span class=pi>:</span> <i class=conum data-value=3></i><b>(3)</b>
    <span class=na>host</span><span class=pi>:</span> <span class=s>upstream:8081</span>
  <span class=na>execute</span><span class=pi>:</span>
  <span class=pi>-</span> <span class=na>authenticator</span><span class=pi>:</span> <span class=s>jwt_auth</span> <i class=conum data-value=4></i><b>(4)</b>
  <span class=pi>-</span> <span class=na>authorizer</span><span class=pi>:</span> <span class=s>openfga_check</span> <i class=conum data-value=5></i><b>(5)</b>
    <span class=na>config</span><span class=pi>:</span>
      <span class=na>values</span><span class=pi>:</span>
        <span class=na>store_id</span><span class=pi>:</span> <span class=s>01HSXG2XSZJMQG99EVXB4QQX8P</span> <i class=conum data-value=6></i><b>(6)</b>
        <span class=na>model_id</span><span class=pi>:</span> <span class=s>01HSXG7TBQEJ7GBPKQR2VYH24G</span> <i class=conum data-value=7></i><b>(7)</b>
        <span class=na>relation</span><span class=pi>:</span> <span class=pi>&gt;</span> <i class=conum data-value=8></i><b>(8)</b>
          <span class=s>{{- if eq .Request.Method &#34;GET&#34; -}} reader</span>
          <span class=s>{{- else if eq .Request.Method &#34;POST&#34; -}} creator</span>
          <span class=s>{{- else if eq .Request.Method &#34;DELETE&#34; -}} deleter</span>
          <span class=s>{{- else -}} unknown</span>
          <span class=s>{{- end -}}</span>
        <span class=na>object</span><span class=pi>:</span> <span class=pi>&gt;</span>
          <span class=s>document:{{- .Request.URL.Captures.id -}} </span><i class=conum data-value=9></i><b>(9)</b>
  <span class=pi>-</span> <span class=na>finalizer</span><span class=pi>:</span> <span class=s>create_jwt</span> <i class=conum data-value=10></i><b>(10)</b>

<span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>list_documents</span>  <i class=conum data-value=11></i><b>(11)</b>
  <span class=na>match</span><span class=pi>:</span>
    <span class=na>routes</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=na>path</span><span class=pi>:</span> <span class=s>/documents</span> <i class=conum data-value=12></i><b>(12)</b>
    <span class=na>methods</span><span class=pi>:</span> <span class=pi>[</span> <span class=nv>GET</span> <span class=pi>]</span> <i class=conum data-value=14></i><b>(14)</b>
  <span class=na>forward_to</span><span class=pi>:</span> <i class=conum data-value=13></i><b>(13)</b>
    <span class=na>host</span><span class=pi>:</span> <span class=s>upstream:8081</span>
  <span class=na>execute</span><span class=pi>:</span> <i class=conum data-value=15></i><b>(15)</b>
  <span class=pi>-</span> <span class=na>authenticator</span><span class=pi>:</span> <span class=s>jwt_auth</span>
  <span class=pi>-</span> <span class=na>contextualizer</span><span class=pi>:</span> <span class=s>openfga_list</span>
    <span class=na>config</span><span class=pi>:</span>
      <span class=na>values</span><span class=pi>:</span>
        <span class=na>store_id</span><span class=pi>:</span> <span class=s>01HSXG2XSZJMQG99EVXB4QQX8P</span>
        <span class=na>model_id</span><span class=pi>:</span> <span class=s>01HSXG7TBQEJ7GBPKQR2VYH24G</span>
        <span class=na>relation</span><span class=pi>:</span> <span class=s>reader</span>
  <span class=pi>-</span> <span class=na>finalizer</span><span class=pi>:</span> <span class=s>create_jwt</span>
    <span class=na>config</span><span class=pi>:</span>
      <span class=na>claims</span><span class=pi>:</span> <span class=pi>|</span>
        <span class=s>{{ toJson .Outputs.openfga_list }} </span><i class=conum data-value=16></i><b>(16)</b></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>Our rule set consists of two rules. The first one has the id <code>access_document</code></td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>This rule should match urls of the following form <code>/document/&lt;id></code>, with id being the identifier of a document.</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>If the execution of the authentication & authorization pipeline was successful, the request should be forwarded to the <code>upstream:8081</code> host.</td></tr><tr><td><i class=conum data-value=4></i><b>4</b></td><td>The authentication & authorization pipeline starts with the reference to the previously defined authenticator <code>jwt_auth</code></td></tr><tr><td><i class=conum data-value=5></i><b>5</b></td><td>Next, we specify the <code>openfga_check</code> authorizer and also configure the rule specific settings</td></tr><tr><td><i class=conum data-value=6></i><b>6</b></td><td>Replace the value here with the store id, you’ve received in step 6</td></tr><tr><td><i class=conum data-value=7></i><b>7</b></td><td>Replace the value here with the authorization model id, you’ve received in step 7</td></tr><tr><td><i class=conum data-value=8></i><b>8</b></td><td>Here, we set the relation depending on the used HTTP request method</td></tr><tr><td><i class=conum data-value=9></i><b>9</b></td><td>Our object reference. We use the value captured by the wildcard named <code>id</code>.</td></tr><tr><td><i class=conum data-value=10></i><b>10</b></td><td>Reference to the previously configured finalizer to create a JWT to be forwarded to our upstream service</td></tr><tr><td><i class=conum data-value=11></i><b>11</b></td><td>This is our second rule. It has the id <code>list_documents</code>.</td></tr><tr><td><i class=conum data-value=12></i><b>12</b></td><td>And matches any request of the form <code>/documents</code></td></tr><tr><td><i class=conum data-value=13></i><b>13</b></td><td>As the previous rule, this one forwards the request to the <code>upstream:8081</code> host on successful completion of the authentication & authorization pipeline</td></tr><tr><td><i class=conum data-value=14></i><b>14</b></td><td>Unlike the <code>access_document</code> rule, this one allows only HTTP GET methods for the matched urls.</td></tr><tr><td><i class=conum data-value=15></i><b>15</b></td><td>The authentication & authorization pipeline is pretty similar to the previous rule. The main difference is the usage of the <code>openfga_list</code> contextualizer instead of the <code>openfga_check</code> authorizer and the reconfiguration of the <code>create_jwt</code> finalizer. As with the previous rule, replace the <code>store_id</code> and <code>model_id</code> with the values, you’ve received above.</td></tr><tr><td><i class=conum data-value=16></i><b>16</b></td><td>Here, we reconfigure our finalizer to include the results from the <code>openfga_list</code> contextualizer into the created JWT.</td></tr></tbody></table></div></li></ol></div></div></div><div class=sect1><h2 id=_update_relationship_tuples>Update Relationship Tuples</h2><div class=sectionbody><div class=paragraph><p>Having everything in place, time to configure the actual permissions. As with the previous steps, this one is based on <a href=https://openfga.dev/docs/getting-started/update-tuples>Update Relationship Tuples</a> from the official OpenFGA guide. So, let us give our user <code>anne</code> at least the <code>read</code> permission.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>If you skip this step and directly continue with <a href=#_use_the_setup>Use the Setup</a>, you’ll always receive a <code>403 Forbidden</code> response.</td></tr></tbody></table></div><div class="olist arabic"><ol class=arabic><li><p>Call the OpenFGA write endpoint as also described in <a href=https://openfga.dev/docs/getting-started/update-tuples#02-calling-write-api-to-add-new-relationship-tuples>Calling Write API To Add New Relationship Tuples</a> to create a reader relationship between our user <code>anne</code> and the document with the id <code>1234</code>. Replace the store id and the authorization model id with those, you’ve received while following the steps above:</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=bash>curl <span class=nt>-X</span> POST http://127.0.0.1:8080/stores/&lt;the store <span class=nb>id </span>from above&gt;/write <span class=se>\</span>
     <span class=nt>-H</span> <span class=s2>&#34;content-type: application/json&#34;</span> <span class=se>\</span>
     <span class=nt>-d</span> <span class=s1>&#39;{
            &#34;authorization_model_id&#34;: &#34;&lt;the authorization model id from above&gt;&#34;,
            &#34;writes&#34;: {
              &#34;tuple_keys&#34; : [
                {
                  &#34;user&#34;:&#34;user:anne&#34;,
                  &#34;relation&#34;:&#34;reader&#34;,
                  &#34;object&#34;:&#34;document:1234&#34;
                }
              ]
            }
        }&#39;</span></code></pre></div></div></li><li><p>Verify <code>anne</code> has the required permissions</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=bash>curl <span class=nt>-X</span> POST http://127.0.0.1:8080/stores/&lt;the store <span class=nb>id </span>from above&gt;/check  <span class=se>\</span>
     <span class=nt>-H</span> <span class=s2>&#34;content-type: application/json&#34;</span> <span class=se>\</span>
     <span class=nt>-d</span> <span class=s1>&#39;{
          &#34;authorization_model_id&#34;: &#34;&lt;the authorization model id from above&gt;&#34;,
          &#34;tuple_key&#34;: {
            &#34;user&#34;: &#34;user:anne&#34;,
            &#34;relation&#34;: &#34;reader&#34;,
            &#34;object&#34;: &#34;document:1234&#34;
          }
        }&#39;</span></code></pre></div></div><div class=paragraph><p>You should receive the following response:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=json><span class=p>{</span><span class=nl>&#34;allowed&#34;</span><span class=p>:</span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=nl>&#34;resolution&#34;</span><span class=p>:</span><span class=s2>&#34;&#34;</span><span class=p>}</span></code></pre></div></div></li></ol></div></div></div><div class=sect1><h2 id=_use_the_setup>Use the Setup</h2><div class=sectionbody><div class=paragraph><p>We have now definitely everything in place to allow our user <code>anne</code> to at least read the document with the id <code>1234</code> and also list the documents <code>anne</code> has access to.</p></div><div class="olist arabic"><ol class=arabic><li><p>Try executing the following command:</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=bash><span class=nv>$ </span>curl <span class=nt>-X</span> GET <span class=nt>-H</span> <span class=s2>&#34;Authorization: Bearer eyJhbGciOiJFUzI1NiIsImtpZCI6ImtleS0yIiwidHlwIjoiSldUIn0.eyJleHAiOjIwMjcyMzUxODUsImlhdCI6MTcxMTg3NTE4NSwiaXNzIjoiZGVtb19pc3N1ZXIiLCJqdGkiOiI1ZDJjM2E3OC1hM2Y5LTRlNmYtOTExYi0xZjZmZWQ5ODE3YTciLCJuYmYiOjE3MTE4NzUxODUsInN1YiI6ImFubmUifQ.wH7HOs-w8YbsOLJcZ9bHBuY5lCBZmYUhQGLJyEbePJZ_WlyR7aa0QmCc3Yx9JsSs3HDmnIbD2wUaFTe2rZWtqA&#34;</span> <span class=se>\</span>
       127.0.0.1:9090/document/1234</code></pre></div></div><div class=paragraph><p>You should see an output similar to the one shown below. Since our upstream does just echo everything back it receives, it represents a successful response to read the document with the id <code>1234</code>.</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=bash>Hostname: 94e60bba8498
IP: 127.0.0.1
IP: 172.19.0.2
RemoteAddr: 172.19.0.4:43688
GET /admin HTTP/1.1
Host: upstream:8081
User-Agent: curl/8.2.1
Accept: <span class=k>*</span>/<span class=k>*</span>
Accept-Encoding: <span class=nb>gzip
</span>Authorization: Bearer eyJhbGciOiJFUzM4NCIsImtpZCI6ImIzNDA3N2ZlNWI5NDczYzBjMmY3NDNmYWQ0MmY3ZDU0YWM3ZTFkN2EiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MTg2OTQ5MzAsImlhdCI6MTcxODY5NDYzMCwiaXNzIjoiaGVpbWRhbGwiLCJqdGkiOiJiNzgyZGE4YS1mMDFlLTRmYmUtYTlkZC04MzdiYzYzYzlhODUiLCJuYmYiOjE3MTg2OTQ2MzAsInN1YiI6ImFubmUifQ.xANlIPmRWdMraL_j0i-0cK4NVhqopzgSc5_u0m4Hyg4VAFQ3ZHuuap1ZD9hs8ZkBQGin9-vPsBeVrQr40OfAev7WKyNVPpIpmFBAU8fX15kXgVXox29kgBAcAM2b2W-w
Forwarded: <span class=k>for</span><span class=o>=</span>172.19.0.1<span class=p>;</span><span class=nv>host</span><span class=o>=</span>127.0.0.1:9090<span class=p>;</span><span class=nv>proto</span><span class=o>=</span>http</code></pre></div></div></li><li><p>Let us list the documents our user has access to</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=bash><span class=nv>$ </span>curl <span class=nt>-H</span> <span class=s2>&#34;Authorization: Bearer eyJhbGciOiJFUzI1NiIsImtpZCI6ImtleS0yIiwidHlwIjoiSldUIn0.eyJleHAiOjIwMjcyMzUxODUsImlhdCI6MTcxMTg3NTE4NSwiaXNzIjoiZGVtb19pc3N1ZXIiLCJqdGkiOiI1ZDJjM2E3OC1hM2Y5LTRlNmYtOTExYi0xZjZmZWQ5ODE3YTciLCJuYmYiOjE3MTE4NzUxODUsInN1YiI6ImFubmUifQ.wH7HOs-w8YbsOLJcZ9bHBuY5lCBZmYUhQGLJyEbePJZ_WlyR7aa0QmCc3Yx9JsSs3HDmnIbD2wUaFTe2rZWtqA&#34;</span> <span class=se>\</span>
       127.0.0.1:9090/documents</code></pre></div></div><div class=paragraph><p>You should again see an output similar to the one shown below. However, if you take a closer look at the JWT from the <code>Authorization</code> header by e.g. making use of <a href=https://www.jstoolset.com/jwt class=bare>https://www.jstoolset.com/jwt</a>, you’ll see it contains also a list of documents <code>anne</code> has access to.</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=bash>Hostname: 94e60bba8498
IP: 127.0.0.1
IP: 172.19.0.2
RemoteAddr: 172.19.0.4:43688
GET /admin HTTP/1.1
Host: upstream:8081
User-Agent: curl/8.2.1
Accept: <span class=k>*</span>/<span class=k>*</span>
Accept-Encoding: <span class=nb>gzip
</span>Authorization: Bearer eyJhbGciOiJFUzM4NCIsImtpZCI6ImIzNDA3N2ZlNWI5NDczYzBjMmY3NDNmYWQ0MmY3ZDU0YWM3ZTFkN2EiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MTg2OTUwODEsImlhdCI6MTcxODY5NDc4MSwiaXNzIjoiaGVpbWRhbGwiLCJqdGkiOiJiNWRhMDg2OC0yNTFhLTRhZmEtODk4ZS1hZThlYzdkZjMyZDEiLCJuYmYiOjE3MTg2OTQ3ODEsIm9iamVjdHMiOlsiZG9jdW1lbnQ6MTIzNCJdLCJzdWIiOiJhbm5lIn0.GY-4oi75KV8jQz5SgMzVMG_-CcCSi9XpmRE934Uq-A326MBwTcFuHysSYmWNz85wwG5zti2Jijn1T8Vm2fpTVEgEE6qltB9caVQlVNGDyF3uAVdpq9NRgHDcru3-15oB
Forwarded: <span class=k>for</span><span class=o>=</span>172.19.0.1<span class=p>;</span><span class=nv>host</span><span class=o>=</span>127.0.0.1:9090<span class=p>;</span><span class=nv>proto</span><span class=o>=</span>http</code></pre></div></div></li><li><p>Try accessing a document with the id <code>1235</code> or delete a document using the <code>DELETE</code> HTTP verb. Useless :). Heimdall won’t let you through. But you can add new relations as you did in <a href=#_update_relationship_tuples>Update Relationship Tuples</a> to allow <code>anne</code> accessing further documents, or delete, or modify existing documents. Try that.</p></li></ol></div></div></div><div class=sect1><h2 id=_cleanup>Cleanup</h2><div class=sectionbody><div class=paragraph><p>Just stop the environment with <code>CTRL-C</code> and delete the created files. If you started docker compose in the background, tear the environment down with</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=bash><span class=nv>$ </span>docker compose down</code></pre></div></div></div></div></linkable-headline-area></div><p class="text-end fst-italic fs-7 pb-3">Last updated on <span class=fw-bold>Aug 12, 2025</span></p><hr><div class="d-flex justify-content-between py-3"><a href=../../../guides/authz/opa/ class="fs-6 fw-bold text-dark link-secondary link-underline-opacity-0"><svg width="16" height="16" fill="currentcolor" class="bi bi-chevron-left" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5.0 010 .708L5.707 8l5.647 5.646a.5.5.0 01-.708.708l-6-6a.5.5.0 010-.708l6-6a.5.5.0 01.708.0z"/></svg>
Integration with OPA
</a><a class="ms-auto fs-6 fw-bold text-dark link-secondary link-underline-opacity-0" href=../../../guides/authn/oidc_first_party_auth/>First-Party Authentication with OpenID Connect<svg width="16" height="16" fill="currentcolor" class="bi bi-chevron-right" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5.0 01.708.0l6 6a.5.5.0 010 .708l-6 6a.5.5.0 01-.708-.708L10.293 8 4.646 2.354a.5.5.0 010-.708z"/></svg></a></div></div></main></div><footer class="footer py-4 py-md-5 px-4 px-md-3 mt-3"><div class=container><div class=row><div class="col-lg-3 mb-3"><p class=fs-5>Heimdall</p><ul class="list-unstyled small text-muted"><li class=mb-2>2022-2024 © Heimdall Project Authors. All rights reserved.</li><li class=mb-2><a href=https://github.com/dadrus/heimdall/blob/master/LICENSE>Apache 2.0 licensed</a></li></ul></div><div class="col-6 col-lg-2 offset-lg-1 mb-3"><h5>Links</h5><ul class=list-unstyled><li class=mb-2><a href=../../../>Home</a></li><li class=mb-2><a href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=mb-2><a href=../../../guides/>Guides</a></li><li class=mb-2><a href=../../../openapi/>API</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Guides</h5><ul class=list-unstyled><li class=mb-2><a href=../../../guides/proxies/>API Gateways & Proxies</a></li><li class=mb-2><a href=../../../guides/authz/>Authorization Services</a></li><li class=mb-2><a href=../../../guides/authn/>Authentication Protocols & Services</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Community</h5><ul class=list-unstyled><li class=mb-2><a href=https://github.com/dadrus/heimdall>Github</a></li><li class=mb-2><a href=https://discord.gg/qQgg8xKuyb>Discord</a></li></ul></div></div></div></footer><script src=../../../js/main.js defer></script></body></html>