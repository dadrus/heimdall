<!doctype html><html lang=en><head><title>NGINX Integration</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="An open source Identity Aware Proxy and an Access Control Decision service for cloud native applications"><meta name=dc.relation content="https://dadrus.github.io/"><meta name=theme-color content="#1A94D2"><link rel=stylesheet href=../../../css/styles.min.css media=screen><link rel='shortcut icon' type=image/x-icon href=../../../favicon.ico></head><body><header class="navbar navbar-expand-md navbar-dark bg-dark sticky-top"><nav class="container-xxl flex-wrap flex-lg-nowrap px-0" aria-label="Main navigation"><button class="btn btn-outline-dark d-lg-none navbar-toggler border-0 shadow-none ps-3" type=button data-bs-toggle=offcanvas data-bs-target=#docsMenuContent aria-controls=docsMenuContent aria-expanded=false aria-label="Open docs menu"><svg width="36" height="36" fill="currentcolor" class="bi bi-list" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.5 12a.5.5.0 01.5-.5h10a.5.5.0 010 1H3a.5.5.0 01-.5-.5m0-4a.5.5.0 01.5-.5h10a.5.5.0 010 1H3A.5.5.0 012.5 8m0-4a.5.5.0 01.5-.5h10a.5.5.0 010 1H3A.5.5.0 012.5 4"/></svg></button><nav class="offcanvas offcanvas-start d-md-none text-bg-light" tabindex=-1 id=docsMenuContent aria-labelledby=docsMenuContentLabel><div class=offcanvas-header><h5 class=offcanvas-title id=docsMenuContentLabel>Browse guides</h5><button type=button class=btn-close data-bs-dismiss=offcanvas aria-label="Close docs menu"></button></div><div class="offcanvas-body docs-sidebar"><div class=docs-search-button><button type=button class="btn btn-outline-secondary mb-3 d-none d-md-block w-100 text-start" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search">
<svg width="20" height="20" fill="currentcolor" class="bi bi-search me-2" viewBox="0 0 20 20"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg>
<span>Quick search...</span></button></div><nav id=SideBarToc><ul><li><span>API Gateways & Proxies</span><ul><li><a href=../../../guides/proxies/caddy/>Caddy Integration</a></li><li><a href=../../../guides/proxies/contour/>Contour Integration</a></li><li><a href=../../../guides/proxies/emissary/>Emissary Ingress Integration</a></li><li><a href=../../../guides/proxies/envoy/>Envoy Integration</a></li><li><a href=../../../guides/proxies/envoy_gateway/>Envoy Gateway Integration</a></li><li><a href=../../../guides/proxies/haproxy/>HAProxy Integration</a></li><li><a href=../../../guides/proxies/istio/>Istio Service Mesh Integration</a></li><li><a class=active href=../../../guides/proxies/nginx/>NGINX Integration</a></li><li><a href=../../../guides/proxies/traefik/>Traefik Proxy Integration</a></li></ul></li><li><span>Authorization Services</span><ul><li><a href=../../../guides/authz/opa/>Integration with OPA</a></li><li><a href=../../../guides/authz/openfga/>Integration with OpenFGA</a></li></ul></li><li><span>Authentication Protocols & Services</span><ul><li><a href=../../../guides/authn/oidc_first_party_auth/>First-Party Authentication with OpenID Connect</a></li></ul></li></ul></nav></div></nav><div class="d-flex align-items-center px-4"><a class="navbar-brand navbar-brand-highlight text-white me-0" href=../../../ style=font-weight:500;font-size:1.5rem>Heimdall</a><ul class="navbar-nav d-none d-md-flex ms-3"><li class=nav-item><a class='nav-link text-white' href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=nav-item><a class='nav-link text-white active' href=../../../guides/>Guides</a></li><li class=nav-item><a class='nav-link text-white' href=../../../openapi/>API</a></li></ul></div><div class=d-flex><button type=button class="btn btn-outline-dark navbar-toggler border-0 shadow-none" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search">
<span class="bi bi-search"></span>
</button>
<button class="btn btn-outline-dark navbar-toggler border-0 shadow-none pe-3" type=button data-bs-toggle=offcanvas data-bs-target=#mainMenuContent aria-controls=mainMenuContent aria-expanded=false aria-label="Open main menu"><svg width="24" height="24" fill="currentcolor" class="bi bi-three-dots" viewBox="0 0 16 16"><path d="M3 9.5a1.5 1.5.0 110-3 1.5 1.5.0 010 3m5 0a1.5 1.5.0 110-3 1.5 1.5.0 010 3m5 0a1.5 1.5.0 110-3 1.5 1.5.0 010 3"/></svg></button><div class="offcanvas offcanvas-end text-bg-dark" tabindex=-1 id=mainMenuContent aria-labelledby=mainMenuContentLabel><div class=offcanvas-header><h5 class="offcanvas-title text-white" id=mainMenuContentLabel>Heimdall</h5><button type=button class="btn-close btn-close-white" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class=offcanvas-body><ul class="navbar-nav flex-column d-md-none d-lg-none d-xl-none"><li class=nav-item><a class='nav-link text-white' href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=nav-item><a class='nav-link text-white active' href=../../../guides/>Guides</a></li><li class=nav-item><a class='nav-link text-white' href=../../../openapi/>API</a></li></ul><hr class="text-white-50 d-md-none"><ul class="navbar-nav flex-column ms-auto"><doc-version-select class="nav-item dropdown" version-file=/heimdall/data.json current-version=dev current-page=/guides/proxies/nginx/><button class="btn btn-dark dropdown-toggle me-4" data-bs-toggle=dropdown aria-expanded=false>
dev</button></doc-version-select></ul><ul class="navbar-nav flex-column"><li class="nav-item mb-1 pe-4"><a class="nav-link text-white" style=align-self:center href=https://github.com/dadrus/heimdall><svg role="img" width="20" height="20" fill="currentcolor" class="bi bi-github text-white" viewBox="0 0 16 16"><title>GitHub</title><path d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.012 8.012.0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
<small class="ms-2 d-md-none">GitHub</small></a></li></ul></div></div></div></nav></header><div class=modal id=docSearch tabindex=-1 aria-labelledby=docSearchLabel aria-hidden=true><doc-search class="col-auto me-auto mw-75" index-file=/heimdall/dev/index.json path-prefix=/heimdall/dev><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class=modal-content><div class="modal-header p-2"><div class=input-group><div class="input-group-text bg-body border-0 fs-4"><svg width="16" height="16" fill="currentcolor" class="bi bi-search text-secondary my-0" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg></div><input id=search-input class="form-control search-bar border-0" type=search placeholder="Search documentation " aria-label="Search docs..." autocomplete=off autofocus><div class="input-group-text bg-body border-0"><a class="btn input-group-text text-muted border p-1 bg-light-subtle fs-7 fw-bold font-monospace" data-bs-dismiss=modal aria-label=Close>ESC</a></div></div></div><div class=modal-body><div class=search-results><p class="text-center mt-5">No recent searches</p></div></div><div class=modal-footer></div></div></div></doc-search></div><div class="container-xxl docs-layout px-4"><aside class="d-none pe-3 docs-sidebar"><div class=docs-search-button><button type=button class="btn btn-outline-secondary mb-3 d-none d-md-block w-100 text-start" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search">
<svg width="20" height="20" fill="currentcolor" class="bi bi-search me-2" viewBox="0 0 20 20"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg>
<span>Quick search...</span></button></div><nav id=SideBarToc><ul><li><span>API Gateways & Proxies</span><ul><li><a href=../../../guides/proxies/caddy/>Caddy Integration</a></li><li><a href=../../../guides/proxies/contour/>Contour Integration</a></li><li><a href=../../../guides/proxies/emissary/>Emissary Ingress Integration</a></li><li><a href=../../../guides/proxies/envoy/>Envoy Integration</a></li><li><a href=../../../guides/proxies/envoy_gateway/>Envoy Gateway Integration</a></li><li><a href=../../../guides/proxies/haproxy/>HAProxy Integration</a></li><li><a href=../../../guides/proxies/istio/>Istio Service Mesh Integration</a></li><li><a class=active href=../../../guides/proxies/nginx/>NGINX Integration</a></li><li><a href=../../../guides/proxies/traefik/>Traefik Proxy Integration</a></li></ul></li><li><span>Authorization Services</span><ul><li><a href=../../../guides/authz/opa/>Integration with OPA</a></li><li><a href=../../../guides/authz/openfga/>Integration with OpenFGA</a></li></ul></li><li><span>Authentication Protocols & Services</span><ul><li><a href=../../../guides/authn/oidc_first_party_auth/>First-Party Authentication with OpenID Connect</a></li></ul></li></ul></nav></aside><main class=docs-main><div class="d-md-none docs-location bg-body"><nav style="--bs-breadcrumb-divider:'>'" aria-label=breadcrumb><ol class="breadcrumb mb-0"><li class="breadcrumb-item fw-bold">API Gateways & Proxies</li><li class="breadcrumb-item active" aria-current=page>NGINX Integration</li></ol></nav></div><div class="docs-intro pt-3 pe-3"><h1>NGINX Integration</h1><p>This guide explains how to integrate heimdall with NGINX as well as with the NGINX Ingress Controller.</p></div><aside class="text-muted docs-toc"><strong class="d-md-block h6 pb-2 my-2 ms-2 border-bottom d-none d-md-none d-lg-block">On this page</strong><div id=page-content-toc class="mt-1 mb-3 text-muted d-none d-md-none d-lg-block docs-toc-content"><nav id=TableOfContents><ul><li><a href=#_prerequisites>Prerequisites</a></li><li><a href=#_limitations>Limitations</a></li><li><a href=#_vanilla_nginx>Vanilla NGINX</a><ul><li><a href=#_first_option>Forward only the path and query information</a></li><li><a href=#_second_option>Forward all information in <code>X-Forwarded-*</code> headers</a></li></ul></li><li><a href=#_nginx_ingress_controller>NGINX Ingress Controller</a><ul><li><a href=#_global_configuration>Global Configuration</a></li><li><a href=#_integration_on_ingress_resource_level>Integration on <code>Ingress</code> Resource Level</a></li></ul></li><li><a href=#_additional_resources>Additional Resources</a></li></ul></nav></div><button class="btn btn-outline-secondary text-decoration-none d-lg-none collapsed" type=button data-bs-toggle=collapse data-bs-target=#page-content-toc-collapsible aria-expanded=false aria-controls=page-content-toc-collapsible>
On this page<svg width="16" height="16" fill="currentcolor" class="bi bi-chevron-expand" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M3.646 9.146a.5.5.0 01.708.0L8 12.793l3.646-3.647a.5.5.0 01.708.708l-4 4a.5.5.0 01-.708.0l-4-4a.5.5.0 010-.708m0-2.292a.5.5.0 00.708.0L8 3.207l3.646 3.647a.5.5.0 00.708-.708l-4-4a.5.5.0 00-.708.0l-4 4a.5.5.0 000 .708"/></svg></button><div id=page-content-toc-collapsible class="mt-1 mb-3 text-muted d-lg-none collapse docs-toc-content"><div class="card card-body"><nav id=TableOfContents><ul><li><a href=#_prerequisites>Prerequisites</a></li><li><a href=#_limitations>Limitations</a></li><li><a href=#_vanilla_nginx>Vanilla NGINX</a><ul><li><a href=#_first_option>Forward only the path and query information</a></li><li><a href=#_second_option>Forward all information in <code>X-Forwarded-*</code> headers</a></li></ul></li><li><a href=#_nginx_ingress_controller>NGINX Ingress Controller</a><ul><li><a href=#_global_configuration>Global Configuration</a></li><li><a href=#_integration_on_ingress_resource_level>Integration on <code>Ingress</code> Resource Level</a></li></ul></li><li><a href=#_additional_resources>Additional Resources</a></li></ul></nav></div></div></aside><div class="docs-content pe-3"><div data-bs-spy=scroll data-bs-target=#page-content-toc class=mt-3><linkable-headline-area><div class=paragraph><p><a href=https://nginx.org/>NGINX</a> is an HTTP and reverse proxy server which became famous as one of the fastest web servers out there, heimdall can be integrated with by making use of the <a href=https://nginx.org/en/docs/http/ngx_http_auth_request_module.html>ngx_http_auth_request_module</a>. In such setup, NGINX delegates authentication and authorization to heimdall. If heimdall answers with a 2XX code, NGINX grants access and forwards the original request to the upstream service. If heimdall returns 401 or 403, the access is denied with the corresponding error code. Any other response code returned by heimdall is considered an error.</p></div><div class=sect1><h2 id=_prerequisites>Prerequisites</h2><div class=sectionbody><div class=ulist><ul><li><p>Integration with NGINX requires heimdall being operated in <a href=../../../docs/concepts/operating_modes/#_decision_mode>Decision Operation Mode</a> exposing its HTTP(s) endpoint.</p></li></ul></div></div></div><div class=sect1><h2 id=_limitations>Limitations</h2><div class=sectionbody><div class=paragraph><p>NGINX <a href=https://nginx.org/en/docs/http/ngx_http_auth_request_module.html>ngx_http_auth_request_module</a> responsible for communication with external authentication & authorization services, like heimdall, has a few limitations. As written above, it only supports 200, 401 and 403 response codes. That means:</p></div><div class=ulist><ul><li><p>You’ll not be able to drive redirects from heimdall, as 3xx error codes will result in 500 error returned by NGINX. You can partially overcome that limitation by letting heimdall respond with a 401 or 403 error code and mapping that to a redirect in NGINX itself, e.g. like shown below. This definitely not DRY and will not allow you using multiple identity provider if you need to</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=nginx><span class=c1># nginx.conf</span>
<span class=k>...</span>

<span class=c1># if the ext auth server, like heimdall returns `401 not authorized`</span>
<span class=c1># then forward the request to the error401 block</span>
<span class=s>error_page</span> <span class=mi>401</span> <span class=p>=</span> <span class=s>@error401</span><span class=p>;</span>

<span class=k>location</span> <span class=s>@error401</span> <span class=p>{</span>
  <span class=c1># redirect to the IdP for login</span>
  <span class=kn>return</span> <span class=mi>302</span> <span class=s>https://your-idp-service/login</span><span class=p>;</span>
  <span class=c1># you usually want your IdP to redirect back upon successful authentication</span>
  <span class=c1># typically, you can achieve that by adding such query parameters like</span>
  <span class=c1># return_to set to the value of the current request</span>
<span class=p>}</span></code></pre></div></div></li><li><p>If there is no matching rule on heimdall side, heimdall responds with <code>404 Not Found</code>, which, as said above will be treated by NGINX as error. To avoid such situations, you can define a <a href=../../../docs/rules/default_rule/>default rule</a>, which is anyway recommended to have secure defaults</p></li></ul></div></div></div><div class=sect1><h2 id=_vanilla_nginx>Vanilla NGINX</h2><div class=sectionbody><div class=paragraph><p>Since NGINX is highly configurable and heimdall supports different integration options, you can use any of the configuration examples given below. All of these enable heimdall to build the URL of the protected backend server for rule matching purposes.</p></div><div class=paragraph><p>In most cases you must configure heimdall to trust your NGINX instances by setting <a href=../../../docs/services/main/#_trusted_proxies><code>trusted_proxies</code></a>. Exceptions are described in the sections below.</p></div><div class=sect2><h3 id=_first_option>Forward only the path and query information</h3><div class=paragraph><p>With this method you don’t set any headers. That means, you cannot rely on the used HTTP scheme, or the host and port in your rules. Here NGINX uses the same HTTP method, used in the original request to it and add the path and query to the path/query URL used for communication with heimdall. That integration method does not require the configuration of <code>trusted_proxies</code> in heimdall.</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=nginx><span class=c1># nginx.conf</span>
<span class=k>...</span>

<span class=s>location</span> <span class=n>/</span> <span class=p>{</span>
  <span class=kn>auth_request</span>             <span class=n>/_auth</span><span class=p>;</span>  <i class=conum data-value=1></i><b>(1)</b>
  <span class=kn>auth_request_set</span>         <span class=nv>$auth_cookie</span> <span class=nv>$upstream_http_set_cookie</span><span class=p>;</span>  <i class=conum data-value=2></i><b>(2)</b>
  <span class=kn>add_header</span>               <span class=s>Set-Cookie</span> <span class=nv>$auth_cookie</span><span class=p>;</span>
  <span class=kn>auth_request_set</span>         <span class=nv>$authHeader0</span> <span class=nv>$upstream_http_authorization</span><span class=p>;</span>  <i class=conum data-value=3></i><b>(3)</b>
  <span class=kn>proxy_set_header</span>         <span class=s>&#39;Authorization&#39;</span> <span class=nv>$authHeader0</span><span class=p>;</span>
  <span class=c1># mitigate HTTPoxy Vulnerability</span>
  <span class=c1># https://www.nginx.com/blog/mitigating-the-httpoxy-vulnerability-with-nginx/</span>
  <span class=kn>proxy_set_header</span> <span class=s>Proxy</span>   <span class=s>&#34;&#34;</span><span class=p>;</span>
  <span class=kn>...</span>
<span class=err>}</span>

<span class=s>location</span> <span class=p>=</span> <span class=n>/_auth</span> <span class=p>{</span>  <i class=conum data-value=4></i><b>(4)</b>
  <span class=kn>internal</span><span class=p>;</span>
  <span class=kn>access_log</span>               <span class=no>off</span><span class=p>;</span>
  <span class=kn>proxy_method</span>             <span class=nv>$request_method</span><span class=p>;</span> <i class=conum data-value=5></i><b>(5)</b>
  <span class=kn>proxy_pass</span>               <span class=s>https://heimdall:4456</span><span class=nv>$request_uri</span><span class=p>;</span> <i class=conum data-value=6></i><b>(6)</b>
  <span class=kn>proxy_pass_request_body</span>  <span class=no>off</span><span class=p>;</span> <i class=conum data-value=7></i><b>(7)</b>
  <span class=kn>proxy_set_header</span>         <span class=s>Content-Length</span>   <span class=s>&#34;&#34;</span><span class=p>;</span>
  <span class=kn>proxy_set_header</span>         <span class=s>Host</span> <span class=nv>$http_host</span><span class=p>;</span> <i class=conum data-value=8></i><b>(8)</b>
<span class=p>}</span></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>Configures NGINX to forward every request to the internal <code>/_auth</code> endpoint (this is where the actual heimdall integration happens - see below).</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>When the response from heimdall returns, this and the next line set the Cookies set by heimdall in the response (whether you need this depends on your <a href=../../../docs/mechanisms/contextualizers/>Contextualizers</a> and <a href=../../../docs/mechanisms/finalizers/>Finalizers</a> configuration)</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>When the response from heimdall returns, this and the next line set the <code>Authorization</code> header set by heimdall in the response (which header to set depends again on your <a href=../../../docs/mechanisms/contextualizers/>Contextualizers</a> and <a href=../../../docs/mechanisms/finalizers/>Finalizers</a> configuration)</td></tr><tr><td><i class=conum data-value=4></i><b>4</b></td><td>This is where the "magic" happens</td></tr><tr><td><i class=conum data-value=5></i><b>5</b></td><td>Configure NGINX to use the HTTP method used by its client. Without this setting the implementation of <code>proxy_path</code> will use the HTTP GET method.</td></tr><tr><td><i class=conum data-value=6></i><b>6</b></td><td>Configures NGINX to pass the request to heimdall and sets the request path and queries from the original request</td></tr><tr><td><i class=conum data-value=7></i><b>7</b></td><td>Disables sending of the request body. If your heimdall rules make use of the body, you should set this to <code>on</code> and remove the next line.</td></tr><tr><td><i class=conum data-value=8></i><b>8</b></td><td>Lets the NGINX setting the <code>Host</code> header, so it is accessible to heimdall.</td></tr></tbody></table></div></div><div class=sect2><h3 id=_second_option>Forward all information in <code>X-Forwarded-*</code> headers</h3><div class=paragraph><p>With this method you set the <code>X-Forwarded-Method</code>, <code>X-Forwarded-Proto</code>, <code>X-Forwarded-Host</code> and <code>X-Forwarded-Uri</code> to let heimdall know the host, respectively domain url and the used HTTP method.</p></div><div class=paragraph><p>Compared to the <a href=#_first_option>previous integration</a> option, the configuration only differs in the definition of the internal <code>/_auth</code> endpoint. So, the example configuration is limited to that part only.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>Proper configuration of <code>trusted_proxies</code> is mandatory if using this option.</td></tr></tbody></table></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=nginx><span class=c1># nginx.conf</span>
<span class=k>...</span>

<span class=s>location</span> <span class=p>=</span> <span class=n>/_auth</span> <span class=p>{</span>
  <span class=kn>internal</span><span class=p>;</span>
  <span class=kn>proxy_pass</span>               <span class=s>https://heimdall:4456</span><span class=p>;</span>  <i class=conum data-value=1></i><b>(1)</b>
  <span class=kn>proxy_pass_request_body</span>  <span class=no>off</span><span class=p>;</span>
  <span class=kn>proxy_set_header</span>         <span class=s>Content-Length</span>         <span class=s>&#34;&#34;</span><span class=p>;</span>
  <span class=kn>proxy_set_header</span>         <span class=s>X-Forwarded-Method</span>     <span class=nv>$request_method</span><span class=p>;</span>  <i class=conum data-value=2></i><b>(2)</b>
  <span class=kn>proxy_set_header</span>         <span class=s>X-Forwarded-Proto</span>      <span class=nv>$scheme</span><span class=p>;</span>  <i class=conum data-value=3></i><b>(3)</b>
  <span class=kn>proxy_set_header</span>         <span class=s>X-Forwarded-Host</span>       <span class=nv>$http_host</span><span class=p>;</span>  <i class=conum data-value=4></i><b>(4)</b>
  <span class=kn>proxy_set_header</span>         <span class=s>X-Forwarded-Uri</span>        <span class=nv>$request_uri</span><span class=p>;</span>  <i class=conum data-value=5></i><b>(5)</b>
  <span class=kn>proxy_set_header</span>         <span class=s>X-Forwarded-For</span>        <span class=nv>$remote_addr</span><span class=p>;</span>
<span class=p>}</span></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>Configures NGINX to pass the request to heimdall.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>Let NGINX forward the used HTTP method to heimdall.</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>Let NGINX forward the used HTTP scheme to heimdall.</td></tr><tr><td><i class=conum data-value=4></i><b>4</b></td><td>Let NGINX forward the used host to heimdall.</td></tr><tr><td><i class=conum data-value=5></i><b>5</b></td><td>Let NGINX forward the used path and query parameter to heimdall.</td></tr></tbody></table></div></div></div></div><div class=sect1><h2 id=_nginx_ingress_controller>NGINX Ingress Controller</h2><div class=sectionbody><div class=sect2><h3 id=_global_configuration>Global Configuration</h3><div class=sect3><h4 id=_using_x_forwarded_headers>Using <code>X-Forwarded-*</code> headers</h4><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>The configuration used in the example below requires proper configuration of <code>trusted_proxies</code> on heimdall side.</td></tr></tbody></table></div><div class=paragraph><p>Global configuration can be achieved by setting the following properties in controller <code>ConfigMap</code>. If you install the NGINX controller via the helm chart, you can add these properties under the <code>controller.config</code> property of your helm <code>values.yaml</code> file.</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>global-auth-url</span><span class=pi>:</span> <span class=s2>&#34;</span><span class=s>https://&lt;heimdall</span><span class=nv> </span><span class=s>service</span><span class=nv> </span><span class=s>name&gt;.&lt;namespace&gt;.svc.cluster.local:&lt;port&gt;&#34;</span> <i class=conum data-value=1></i><b>(1)</b>
<span class=na>global-auth-response-headers</span><span class=pi>:</span> <span class=s>Authorization</span> <i class=conum data-value=2></i><b>(2)</b>
<span class=na>global-auth-snippet</span><span class=pi>:</span> <span class=pi>|</span> <i class=conum data-value=3></i><b>(3)</b>
  <span class=s>proxy_set_header    X-Forwarded-Method   $request_method;</span>
  <span class=s>proxy_set_header    X-Forwarded-Proto    $scheme;</span>
  <span class=s>proxy_set_header    X-Forwarded-Host     $http_host;</span>
  <span class=s>proxy_set_header    X-Forwarded-Uri      $request_uri;</span></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>Configures the controller to use heimdall’s main service endpoint with <code>&lt;heimdall service name></code>, <code>&lt;namespace></code> and <code>&lt;port></code> depending on your configuration.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>Let NGINX forward the <code>Authorization</code> header set by heimdall to the upstream service upon successful response. This configuration depends on
your <a href=../../../docs/mechanisms/contextualizers/>Contextualizers</a> and <a href=../../../docs/mechanisms/finalizers/>Finalizers</a> configuration. If not configured, NGINX will only react on <code>Set-Cookie</code> headers in responses from heimdall by default.</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>Configures the required headers to pass the information about the used HTTP scheme, host and port, request path and used query parameters to be forwarded to heimdall.<div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>Without that, heimdall will not be able extracting relevant information from the NGINX request as it does not support NGINX proprietary <code>X-Original-Method</code> and <code>X-Original-Uri</code> used by it for the same purposes.</td></tr></tbody></table></div></td></tr></tbody></table></div><div class=paragraph><p>With that in place, you can simply use the standard <a href=https://kubernetes.io/docs/concepts/services-networking/ingress/><code>Ingress</code></a> resource, and the NGINX Ingress Controller will ensure, each request will be analyzed by heimdall first.</p></div><div class=paragraph><p>This will result in an NGINX configuration corresponding to the integration option, described in the <a href=#_second_option>Forward all information in <code>X-Forwarded-*</code> headers</a> section.</p></div></div><div class=sect3><h4 id=_alternative_configuration>Alternative Configuration</h4><div class=paragraph><p>Alternatively, if you don’t want configuring <code>trusted_proxies</code> and do not rely on the used HTTP scheme, host and port in your rules, you can also use the <code>location-snippet</code> and the <code>server-snippet</code> to the <code>ConfigMap</code> of the NGINX Ingress Controller with values shown below.</p></div><div class=paragraph><p>This example is an exact copy of the configuration used in the very first <a href=#_first_option>integration option</a> described above.</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>location-snippet</span><span class=pi>:</span> <span class=pi>|</span>
  <span class=s>auth_request               /_auth;</span>
  <span class=s>auth_request_set           $auth_cookie $upstream_http_set_cookie;</span>
  <span class=s>add_header                 Set-Cookie $auth_cookie;</span>
  <span class=s>auth_request_set           $auth_header $upstream_http_authorization;</span>
  <span class=s>proxy_set_header           &#39;Authorization&#39; $auth_header;</span>
  <span class=s>proxy_set_header Proxy     &#34;&#34;;</span>
<span class=na>server-snippet</span><span class=pi>:</span> <span class=pi>|</span>
  <span class=s>location = /_auth {</span>
    <span class=s>internal;</span>
    <span class=s>access_log               off;</span>
    <span class=s>proxy_method             $request_method;</span>
    <span class=s>proxy_pass               https://&lt;heimdall service name&gt;.&lt;namespace&gt;.svc.cluster.local:&lt;port&gt;$request_uri;</span>
    <span class=s>proxy_pass_request_body  off;</span>
    <span class=s>proxy_set_header         Content-Length   &#34;&#34;;</span>
    <span class=s>proxy_set_header         Host $http_host;</span>
  <span class=s>}</span></code></pre></div></div><div class=paragraph><p>As with the previous integration option, you can add these properties under the <code>controller.config</code> property of your helm <code>values.yaml</code> file if you install the NGINX Ingress Controller via helm.</p></div></div></div><div class=sect2><h3 id=_integration_on_ingress_resource_level>Integration on <code>Ingress</code> Resource Level</h3><div class=sect3><h4 id=_using_x_forwarded_headers_2>Using <code>X-Forwarded-*</code> headers</h4><div class=paragraph><p>One option to integrate heimdall with the NGINX Ingress Controller on the <code>Ingress</code> resource level is making use of the <code>nginx.ingress.kubernetes.io/auth-url</code>, <code>nginx.ingress.kubernetes.io/auth-response-headers</code> and the <code>nginx.ingress.kubernetes.io/auth-snippet</code> annotation as shown in the example below. This approach requires proper configuration of <code>trusted_proxies</code> on heimdall side. On NGINX Ingress Controller side you must allow the usage of <code>nginx.ingress.kubernetes.io/auth-snippet</code> (See also <a href=https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#allow-snippet-annotations>here</a>).</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>nginx.ingress.kubernetes.io/auth-url</span><span class=pi>:</span> <span class=s2>&#34;</span><span class=s>https://&lt;heimdall</span><span class=nv> </span><span class=s>service</span><span class=nv> </span><span class=s>name&gt;.&lt;namespace&gt;.svc.cluster.local:&lt;port&gt;&#34;</span>
<span class=na>nginx.ingress.kubernetes.io/auth-response-headers</span><span class=pi>:</span> <span class=s>Authorization</span>
<span class=na>nginx.ingress.kubernetes.io/auth-snippet</span><span class=pi>:</span> <span class=pi>|</span>
  <span class=s>proxy_set_header    X-Forwarded-Method   $request_method;</span>
  <span class=s>proxy_set_header    X-Forwarded-Proto    $scheme;</span>
  <span class=s>proxy_set_header    X-Forwarded-Host     $http_host;</span>
  <span class=s>proxy_set_header    X-Forwarded-Uri      $request_uri;</span>
<span class=c1># other annotations required</span></code></pre></div></div></div><div class=sect3><h4 id=_alternative_configuration_2>Alternative Configuration</h4><div class=paragraph><p>Alternatively, if you don’t want configuring <code>trusted_proxies</code> and do not rely on the used HTTP scheme, host and port in your rules, you can also use the <code>nginx.ingress.kubernetes.io/configuration-snippet</code> and <code>nginx.ingress.kubernetes.io/server-snippet</code> annotations and use the configuration shown below.</p></div><div class=paragraph><p>This example is an exact copy of the configuration used in the very first <a href=#_first_option>integration option</a> described above.</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>nginx.ingress.kubernetes.io/configuration-snippet</span><span class=pi>:</span> <span class=pi>|</span>
  <span class=s>auth_request               /_auth;</span>
  <span class=s>auth_request_set           $auth_cookie $upstream_http_set_cookie;</span>
  <span class=s>add_header                 Set-Cookie $auth_cookie;</span>
  <span class=s>auth_request_set           $auth_header $upstream_http_authorization;</span>
  <span class=s>proxy_set_header           &#39;Authorization&#39; $auth_header;</span>
  <span class=s>proxy_set_header Proxy     &#34;&#34;;</span>
<span class=na>nginx.ingress.kubernetes.io/server-snippet</span><span class=pi>:</span> <span class=pi>|</span>
  <span class=s>location = /_auth {</span>
    <span class=s>internal;</span>
    <span class=s>access_log               off;</span>
    <span class=s>proxy_method             $request_method;</span>
    <span class=s>proxy_pass               https://&lt;heimdall service name&gt;.&lt;namespace&gt;.svc.cluster.local:&lt;port&gt;$request_uri;</span>
    <span class=s>proxy_pass_request_body  off;</span>
    <span class=s>proxy_set_header         Content-Length   &#34;&#34;;</span>
    <span class=s>proxy_set_header         Host $http_host;</span>
  <span class=s>}</span>
<span class=c1># other annotations required</span></code></pre></div></div></div></div></div></div><div class=sect1><h2 id=_additional_resources>Additional Resources</h2><div class=sectionbody><div class=paragraph><p>Checkout the examples on <a href=https://github.com/dadrus/heimdall/tree/main/examples>GitHub</a> for a working demo.</p></div></div></div></linkable-headline-area></div><p class="text-end fst-italic fs-7 pb-3">Last updated on <span class=fw-bold>Apr 8, 2025</span></p><hr><div class="d-flex justify-content-between py-3"><a href=../../../guides/proxies/istio/ class="fs-6 fw-bold text-dark link-secondary link-underline-opacity-0"><svg width="16" height="16" fill="currentcolor" class="bi bi-chevron-left" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5.0 010 .708L5.707 8l5.647 5.646a.5.5.0 01-.708.708l-6-6a.5.5.0 010-.708l6-6a.5.5.0 01.708.0z"/></svg>
Istio Service Mesh Integration
</a><a class="ms-auto fs-6 fw-bold text-dark link-secondary link-underline-opacity-0" href=../../../guides/proxies/traefik/>Traefik Proxy Integration<svg width="16" height="16" fill="currentcolor" class="bi bi-chevron-right" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5.0 01.708.0l6 6a.5.5.0 010 .708l-6 6a.5.5.0 01-.708-.708L10.293 8 4.646 2.354a.5.5.0 010-.708z"/></svg></a></div></div></main></div><footer class="footer py-4 py-md-5 px-4 px-md-3 mt-3"><div class=container><div class=row><div class="col-lg-3 mb-3"><p class=fs-5>Heimdall</p><ul class="list-unstyled small text-muted"><li class=mb-2>2022-2024 © Heimdall Project Authors. All rights reserved.</li><li class=mb-2><a href=https://github.com/dadrus/heimdall/blob/master/LICENSE>Apache 2.0 licensed</a></li></ul></div><div class="col-6 col-lg-2 offset-lg-1 mb-3"><h5>Links</h5><ul class=list-unstyled><li class=mb-2><a href=../../../>Home</a></li><li class=mb-2><a href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=mb-2><a href=../../../guides/>Guides</a></li><li class=mb-2><a href=../../../openapi/>API</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Guides</h5><ul class=list-unstyled><li class=mb-2><a href=../../../guides/proxies/>API Gateways & Proxies</a></li><li class=mb-2><a href=../../../guides/authz/>Authorization Services</a></li><li class=mb-2><a href=../../../guides/authn/>Authentication Protocols & Services</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Community</h5><ul class=list-unstyled><li class=mb-2><a href=https://github.com/dadrus/heimdall>Github</a></li><li class=mb-2><a href=https://discord.gg/qQgg8xKuyb>Discord</a></li></ul></div></div></div></footer><script src=../../../js/main.js defer></script></body></html>