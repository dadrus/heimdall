<!doctype html><html lang=en><head><title>Protect an Application</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="An open source Identity Aware Proxy and an Access Control Decision service for cloud native applications"><meta name=dc.relation content="https://dadrus.github.io/"><meta name=theme-color content="#1A94D2"><link rel=stylesheet href=../../../css/styles.min.css media=screen><link rel='shortcut icon' type=image/x-icon href=../../../favicon.ico></head><body><header class="navbar navbar-expand-md navbar-dark bg-dark sticky-top"><nav class="container-xxl flex-wrap flex-lg-nowrap px-0" aria-label="Main navigation"><button class="btn btn-outline-dark d-lg-none navbar-toggler border-0 shadow-none ps-3" type=button data-bs-toggle=offcanvas data-bs-target=#docsMenuContent aria-controls=docsMenuContent aria-expanded=false aria-label="Open docs menu"><svg width="36" height="36" fill="currentcolor" class="bi bi-list" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.5 12a.5.5.0 01.5-.5h10a.5.5.0 010 1H3a.5.5.0 01-.5-.5m0-4a.5.5.0 01.5-.5h10a.5.5.0 010 1H3A.5.5.0 012.5 8m0-4a.5.5.0 01.5-.5h10a.5.5.0 010 1H3A.5.5.0 012.5 4"/></svg></button><nav class="offcanvas offcanvas-start d-md-none text-bg-light" tabindex=-1 id=docsMenuContent aria-labelledby=docsMenuContentLabel><div class=offcanvas-header><h5 class=offcanvas-title id=docsMenuContentLabel>Browse docs</h5><button type=button class=btn-close data-bs-dismiss=offcanvas aria-label="Close docs menu"></button></div><div class="offcanvas-body docs-sidebar"><div class=docs-search-button><button type=button class="btn btn-outline-secondary mb-3 d-none d-md-block w-100 text-start" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search">
<svg width="20" height="20" fill="currentcolor" class="bi bi-search me-2" viewBox="0 0 20 20"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg>
<span>Quick search...</span></button></div><nav id=SideBarToc><ul><li><span>Getting Started</span><ul><li><a href=../../../docs/getting_started/discover_heimdall/>Discover heimdall</a></li><li><a href=../../../docs/getting_started/installation/>Install heimdall</a></li><li><a class=active href=../../../docs/getting_started/protect_an_app/>Protect an Application</a></li></ul></li><li><span>Concepts</span><ul><li><a href=../../../docs/concepts/pipelines/>Pipelines</a></li><li><a href=../../../docs/concepts/mechanisms/>Mechanisms</a></li><li><a href=../../../docs/concepts/rules/>Rules</a></li><li><a href=../../../docs/concepts/provider/>Rule Provider</a></li><li><a href=../../../docs/concepts/operating_modes/>Operating Modes</a></li></ul></li><li><span>Operations</span><ul><li><a href=../../../docs/operations/configuration/>Configuration</a></li><li><a href=../../../docs/operations/cli/>CLI</a></li><li><a href=../../../docs/operations/observability/>Observability</a></li><li><a href=../../../docs/operations/cache/>Caching</a></li><li><a href=../../../docs/operations/security/>Security</a></li></ul></li><li><span>Services</span><ul><li><a href=../../../docs/services/main/>Main Service</a></li><li><a href=../../../docs/services/management/>Management Service</a></li></ul></li><li><span>Mechanisms</span><ul><li><a href=../../../docs/mechanisms/catalogue/>Catalogue</a></li><li><a href=../../../docs/mechanisms/evaluation_objects/>Objects, Templating & Co</a></li><li><a href=../../../docs/mechanisms/authenticators/>Authenticators</a></li><li><a href=../../../docs/mechanisms/authorizers/>Authorizers</a></li><li><a href=../../../docs/mechanisms/contextualizers/>Contextualizers</a></li><li><a href=../../../docs/mechanisms/finalizers/>Finalizers</a></li><li><a href=../../../docs/mechanisms/error_handlers/>Error Handlers</a></li></ul></li><li><span>Rules</span><ul><li><a href=../../../docs/rules/regular_rule/>Regular Rule</a></li><li><a href=../../../docs/rules/default_rule/>Default Rule</a></li><li><a href=../../../docs/rules/rule_sets/>Rule Sets</a></li><li><a href=../../../docs/rules/providers/>Rule Providers</a></li></ul></li><li><span>Configuration Reference</span><ul><li><a href=../../../docs/configuration/types/>Type Definitions</a></li><li><a href=../../../docs/configuration/reference/>Reference</a></li></ul></li></ul></nav></div></nav><div class="d-flex align-items-center px-4"><a class="navbar-brand navbar-brand-highlight text-white me-0" href=../../../ style=font-weight:500;font-size:1.5rem>Heimdall</a><ul class="navbar-nav d-none d-md-flex ms-3"><li class=nav-item><a class='nav-link text-white' href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=nav-item><a class='nav-link text-white' href=../../../guides/>Guides</a></li><li class=nav-item><a class='nav-link text-white' href=../../../openapi/>API</a></li></ul></div><div class=d-flex><button type=button class="btn btn-outline-dark navbar-toggler border-0 shadow-none" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search">
<span class="bi bi-search"></span>
</button>
<button class="btn btn-outline-dark navbar-toggler border-0 shadow-none pe-3" type=button data-bs-toggle=offcanvas data-bs-target=#mainMenuContent aria-controls=mainMenuContent aria-expanded=false aria-label="Open main menu"><svg width="24" height="24" fill="currentcolor" class="bi bi-three-dots" viewBox="0 0 16 16"><path d="M3 9.5a1.5 1.5.0 110-3 1.5 1.5.0 010 3m5 0a1.5 1.5.0 110-3 1.5 1.5.0 010 3m5 0a1.5 1.5.0 110-3 1.5 1.5.0 010 3"/></svg></button><div class="offcanvas offcanvas-end text-bg-dark" tabindex=-1 id=mainMenuContent aria-labelledby=mainMenuContentLabel><div class=offcanvas-header><h5 class="offcanvas-title text-white" id=mainMenuContentLabel>Heimdall</h5><button type=button class="btn-close btn-close-white" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class=offcanvas-body><ul class="navbar-nav flex-column d-md-none d-lg-none d-xl-none"><li class=nav-item><a class='nav-link text-white' href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=nav-item><a class='nav-link text-white' href=../../../guides/>Guides</a></li><li class=nav-item><a class='nav-link text-white' href=../../../openapi/>API</a></li></ul><hr class="text-white-50 d-md-none"><ul class="navbar-nav flex-column ms-auto"><doc-version-select class="nav-item dropdown" version-file=/heimdall/data.json current-version=v0.16.1 current-page=/docs/getting_started/protect_an_app/><button class="btn btn-dark dropdown-toggle me-4" data-bs-toggle=dropdown aria-expanded=false>
v0.16.1</button></doc-version-select></ul><ul class="navbar-nav flex-column"><li class="nav-item mb-1 pe-4"><a class="nav-link text-white" style=align-self:center href=https://github.com/dadrus/heimdall><svg role="img" width="20" height="20" fill="currentcolor" class="bi bi-github text-white" viewBox="0 0 16 16"><title>GitHub</title><path d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.012 8.012.0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
<small class="ms-2 d-md-none">GitHub</small></a></li></ul></div></div></div></nav></header><div class=modal id=docSearch tabindex=-1 aria-labelledby=docSearchLabel aria-hidden=true><doc-search class="col-auto me-auto mw-75" index-file=/heimdall/v0.16.1/index.json path-prefix=/heimdall/v0.16.1><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class=modal-content><div class="modal-header p-2"><div class=input-group><div class="input-group-text bg-body border-0 fs-4"><svg width="16" height="16" fill="currentcolor" class="bi bi-search text-secondary my-0" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg></div><input id=search-input class="form-control search-bar border-0" type=search placeholder="Search documentation " aria-label="Search docs..." autocomplete=off autofocus><div class="input-group-text bg-body border-0"><a class="btn input-group-text text-muted border p-1 bg-light-subtle fs-7 fw-bold font-monospace" data-bs-dismiss=modal aria-label=Close>ESC</a></div></div></div><div class=modal-body><div class=search-results><p class="text-center mt-5">No recent searches</p></div></div><div class=modal-footer></div></div></div></doc-search></div><div class="container-xxl docs-layout px-4"><aside class="d-none pe-3 docs-sidebar"><div class=docs-search-button><button type=button class="btn btn-outline-secondary mb-3 d-none d-md-block w-100 text-start" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search">
<svg width="20" height="20" fill="currentcolor" class="bi bi-search me-2" viewBox="0 0 20 20"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg>
<span>Quick search...</span></button></div><nav id=SideBarToc><ul><li><span>Getting Started</span><ul><li><a href=../../../docs/getting_started/discover_heimdall/>Discover heimdall</a></li><li><a href=../../../docs/getting_started/installation/>Install heimdall</a></li><li><a class=active href=../../../docs/getting_started/protect_an_app/>Protect an Application</a></li></ul></li><li><span>Concepts</span><ul><li><a href=../../../docs/concepts/pipelines/>Pipelines</a></li><li><a href=../../../docs/concepts/mechanisms/>Mechanisms</a></li><li><a href=../../../docs/concepts/rules/>Rules</a></li><li><a href=../../../docs/concepts/provider/>Rule Provider</a></li><li><a href=../../../docs/concepts/operating_modes/>Operating Modes</a></li></ul></li><li><span>Operations</span><ul><li><a href=../../../docs/operations/configuration/>Configuration</a></li><li><a href=../../../docs/operations/cli/>CLI</a></li><li><a href=../../../docs/operations/observability/>Observability</a></li><li><a href=../../../docs/operations/cache/>Caching</a></li><li><a href=../../../docs/operations/security/>Security</a></li></ul></li><li><span>Services</span><ul><li><a href=../../../docs/services/main/>Main Service</a></li><li><a href=../../../docs/services/management/>Management Service</a></li></ul></li><li><span>Mechanisms</span><ul><li><a href=../../../docs/mechanisms/catalogue/>Catalogue</a></li><li><a href=../../../docs/mechanisms/evaluation_objects/>Objects, Templating & Co</a></li><li><a href=../../../docs/mechanisms/authenticators/>Authenticators</a></li><li><a href=../../../docs/mechanisms/authorizers/>Authorizers</a></li><li><a href=../../../docs/mechanisms/contextualizers/>Contextualizers</a></li><li><a href=../../../docs/mechanisms/finalizers/>Finalizers</a></li><li><a href=../../../docs/mechanisms/error_handlers/>Error Handlers</a></li></ul></li><li><span>Rules</span><ul><li><a href=../../../docs/rules/regular_rule/>Regular Rule</a></li><li><a href=../../../docs/rules/default_rule/>Default Rule</a></li><li><a href=../../../docs/rules/rule_sets/>Rule Sets</a></li><li><a href=../../../docs/rules/providers/>Rule Providers</a></li></ul></li><li><span>Configuration Reference</span><ul><li><a href=../../../docs/configuration/types/>Type Definitions</a></li><li><a href=../../../docs/configuration/reference/>Reference</a></li></ul></li></ul></nav></aside><main class=docs-main><div class="d-md-none docs-location bg-body"><nav style="--bs-breadcrumb-divider:'>'" aria-label=breadcrumb><ol class="breadcrumb mb-0"><li class="breadcrumb-item fw-bold">Getting Started</li><li class="breadcrumb-item active" aria-current=page>Protect an Application</li></ol></nav></div><div class="docs-intro pt-3 pe-3"><h1>Protect an Application</h1><p>This simple quickstart guide will walk you through the steps to protect an application using heimdall. You'll learn how to configure heimdall as an authentication and authorization proxy in front of your application, as well as how to implement an Edge-level Authorization Architecture (EAA) with heimdall's help.</p></div><aside class="text-muted docs-toc"><strong class="d-md-block h6 pb-2 my-2 ms-2 border-bottom d-none d-md-none d-lg-block">On this page</strong><div id=page-content-toc class="mt-1 mb-3 text-muted d-none d-md-none d-lg-block docs-toc-content"><nav id=TableOfContents><ul><li><a href=#_overview>Overview</a></li><li><a href=#_prerequisites>Prerequisites</a></li><li><a href=#_configure>Configure</a></li><li><a href=#_start_environment>Start Environment</a></li><li><a href=#_consume_the_api>Consume the API</a></li><li><a href=#_cleanup>Cleanup</a></li></ul></nav></div><button class="btn btn-outline-secondary text-decoration-none d-lg-none collapsed" type=button data-bs-toggle=collapse data-bs-target=#page-content-toc-collapsible aria-expanded=false aria-controls=page-content-toc-collapsible>
On this page<svg width="16" height="16" fill="currentcolor" class="bi bi-chevron-expand" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M3.646 9.146a.5.5.0 01.708.0L8 12.793l3.646-3.647a.5.5.0 01.708.708l-4 4a.5.5.0 01-.708.0l-4-4a.5.5.0 010-.708m0-2.292a.5.5.0 00.708.0L8 3.207l3.646 3.647a.5.5.0 00.708-.708l-4-4a.5.5.0 00-.708.0l-4 4a.5.5.0 000 .708"/></svg></button><div id=page-content-toc-collapsible class="mt-1 mb-3 text-muted d-lg-none collapse docs-toc-content"><div class="card card-body"><nav id=TableOfContents><ul><li><a href=#_overview>Overview</a></li><li><a href=#_prerequisites>Prerequisites</a></li><li><a href=#_configure>Configure</a></li><li><a href=#_start_environment>Start Environment</a></li><li><a href=#_consume_the_api>Consume the API</a></li><li><a href=#_cleanup>Cleanup</a></li></ul></nav></div></div></aside><div class="docs-content pe-3"><div data-bs-spy=scroll data-bs-target=#page-content-toc class=mt-3><linkable-headline-area><div class=sect1><h2 id=_overview>Overview</h2><div class=sectionbody><div class=paragraph><p>In this guide, we’ll configure two setups to protect a service that exposes a few endpoints:</p></div><div class=ulist><ul><li><p>The <code>/public</code> endpoint is, as the name implies, public. Every request to it should be forwarded as is.</p></li><li><p>The <code>/user</code> endpoint should only be accessible to users with the <code>user</code> role.</p></li><li><p>The <code>/admin</code> endpoint should only be accessible to users with the <code>admin</code> role.</p></li><li><p>The <code>/private</code> endpoint, along with any other potentially exposed endpoints, should not be accessible at all. All requests to it should be rejected.</p></li></ul></div><div class=paragraph><p>For authentication, we’ll use JWTs containing the respective roles. Authorization will be handled with the help of Open Policy Agent (OPA).</p></div><div class=paragraph><p>In both setups, we’ll create minimal but complete environments using Docker Compose with:</p></div><div class=ulist><ul><li><p><a href=https://doc.traefik.io/traefik/>Traefik</a> as the edge proxy,</p></li><li><p><a href=https://hub.docker.com/r/traefik/whoami/>traefik/whoami</a> (a service that echoes back everything it receives), mimicking our service exposing the endpoints described above,</p></li><li><p>an <a href=https://nginx.org/en/>NGINX</a> server serving the public key for verifying the JWTs (mimicking the JWKS endpoint typically exposed by an OIDC provider),</p></li><li><p><a href=https://www.openpolicyagent.org/>OPA</a>, which evaluates the authorization policy,</p></li><li><p>heimdall, orchestrating everything to enforce the above requirements.</p></li></ul></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>This quickstart and others demonstrating different integration options are also available on <a href=https://github.com/dadrus/heimdall/tree/main/examples/docker-compose/quickstarts>GitHub</a>.</td></tr></tbody></table></div></div></div><div class=sect1><h2 id=_prerequisites>Prerequisites</h2><div class=sectionbody><div class=paragraph><p>To follow this guide, you’ll need the following tools installed locally:</p></div><div class=ulist><ul><li><p><a href=https://docs.docker.com/install/>Docker</a>,</p></li><li><p><a href=https://docs.docker.com/compose/install/>docker-compose</a>, and</p></li><li><p>a text editor of your choice.</p></li></ul></div></div></div><div class=sect1><h2 id=_configure>Configure</h2><div class=sectionbody><div class="olist arabic"><ol class=arabic><li><p>Heimdall can be configured via environment variables, as well as using a configuration file. For simplicity, we’ll use a configuration file in this guide. Create a file named <code>heimdall-config.yaml</code> with the following contents:</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>log</span><span class=pi>:</span> <i class=conum data-value=1></i><b>(1)</b>
  <span class=na>level</span><span class=pi>:</span> <span class=s>debug</span>

<span class=na>tracing</span><span class=pi>:</span>
  <span class=na>enabled</span><span class=pi>:</span> <span class=kc>false</span>

<span class=na>metrics</span><span class=pi>:</span>
  <span class=na>enabled</span><span class=pi>:</span> <span class=kc>false</span>

<span class=na>serve</span><span class=pi>:</span> <i class=conum data-value=2></i><b>(2)</b>
  <span class=na>decision</span><span class=pi>:</span>
    <span class=na>trusted_proxies</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s>0.0.0.0/0</span>

<span class=na>mechanisms</span><span class=pi>:</span> <i class=conum data-value=3></i><b>(3)</b>
  <span class=na>authenticators</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>deny_all</span> <i class=conum data-value=4></i><b>(4)</b>
      <span class=na>type</span><span class=pi>:</span> <span class=s>unauthorized</span>
    <span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>anon</span> <i class=conum data-value=5></i><b>(5)</b>
      <span class=na>type</span><span class=pi>:</span> <span class=s>anonymous</span>
    <span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>jwt_auth</span> <i class=conum data-value=6></i><b>(6)</b>
      <span class=na>type</span><span class=pi>:</span> <span class=s>jwt</span>
      <span class=na>config</span><span class=pi>:</span>
        <span class=na>jwks_endpoint</span><span class=pi>:</span> <span class=s>http://idp:8080/.well-known/jwks</span>
        <span class=na>assertions</span><span class=pi>:</span>
          <span class=na>issuers</span><span class=pi>:</span>
            <span class=pi>-</span> <span class=s>demo_issuer</span>
  <span class=na>authorizers</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>opa</span> <i class=conum data-value=7></i><b>(7)</b>
      <span class=na>type</span><span class=pi>:</span> <span class=s>remote</span>
      <span class=na>config</span><span class=pi>:</span>
        <span class=na>endpoint</span><span class=pi>:</span> <span class=s>http://opa:8181/v1/data/{{ .Values.policy }}</span>
        <span class=na>payload</span><span class=pi>:</span> <span class=s2>&#34;</span><span class=s>{}&#34;</span>
        <span class=na>expressions</span><span class=pi>:</span>
          <span class=pi>-</span> <span class=na>expression</span><span class=pi>:</span> <span class=pi>|</span>
              <span class=s>Payload.result == true</span>
  <span class=na>finalizers</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>create_jwt</span> <i class=conum data-value=8></i><b>(8)</b>
      <span class=na>type</span><span class=pi>:</span> <span class=s>jwt</span>
      <span class=na>config</span><span class=pi>:</span>
        <span class=na>signer</span><span class=pi>:</span>
          <span class=na>key_store</span><span class=pi>:</span>
            <span class=na>path</span><span class=pi>:</span> <span class=s>/etc/heimdall/signer.pem</span>
    <span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>noop</span> <i class=conum data-value=9></i><b>(9)</b>
      <span class=na>type</span><span class=pi>:</span> <span class=s>noop</span>

<span class=na>default_rule</span><span class=pi>:</span> <i class=conum data-value=10></i><b>(10)</b>
  <span class=na>execute</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>authenticator</span><span class=pi>:</span> <span class=s>deny_all</span>
    <span class=pi>-</span> <span class=na>finalizer</span><span class=pi>:</span> <span class=s>create_jwt</span>

<span class=na>providers</span><span class=pi>:</span>
  <span class=na>file_system</span><span class=pi>:</span> <i class=conum data-value=11></i><b>(11)</b>
    <span class=na>src</span><span class=pi>:</span> <span class=s>/etc/heimdall/rules.yaml</span>
    <span class=na>watch</span><span class=pi>:</span> <span class=kc>true</span></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>Since heimdall emits logs at the <code>error</code> level by default, and we want to monitor what’s happening, we’ll set the log level to <code>debug</code>. This way, we’ll not only see the results of a particular rule execution (which you would see with the <code>info</code> log level), but also detailed logs of what’s going on inside each rule. Additionally, we disable tracing and metrics collection, which are pulled by default to an OTEL agent, to avoid error messages related to the unavailability of the agent. For more information on available observability options, see the <a href=../../../docs/operations/observability/#_logging>Observability</a> chapter.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>This configuration instructs heimdall to trust <code>X-Forwarded-*</code> headers from any source. We need this for integration with Traefik, which uses these headers while forwarding requests to heimdall. The IP address used depends on your local Docker configuration.<div class="admonitionblock warning"><table><tbody><tr><td class=icon><i class="fa icon-warning" title=Warning></i></td><td class=content>Never use this in production - always restrict trusted IPs instead! Refer to the documentation on the <a href=../../../docs/services/main/#_trusted_proxies>trusted_proxies</a> property and <a href=../../../docs/operations/security/#_http_header_security_considerations>Security Considerations</a> for more details.</td></tr></tbody></table></div></td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>Here, we define our <a href=../../../docs/mechanisms/catalogue/>catalogue of mechanisms</a> to be used in <a href=../../../docs/rules/regular_rule/>upstream service-specific rules</a>. In this case, we define authenticators, an authorizer, and finalizers.</td></tr><tr><td><i class=conum data-value=4></i><b>4</b></td><td>These two lines define the <code><a href=../../../docs/mechanisms/authenticators/#_unauthorized>unauthorized</a></code> authenticator named <code>deny_all</code>, which rejects all requests.</td></tr><tr><td><i class=conum data-value=5></i><b>5</b></td><td>These two lines define the <code><a href=../../../docs/mechanisms/authenticators/#_anonymous>anonymous</a></code> authenticator named <code>anon</code>, which allows any request and creates a subject with the ID set to <code>anonymous</code>. You can find more information about the subject and other objects <a href=../../../docs/mechanisms/evaluation_objects/#_subject>here</a>.</td></tr><tr><td><i class=conum data-value=6></i><b>6</b></td><td>This and the following lines define and configure the <code><a href=../../../docs/mechanisms/authenticators/#_jwt>jwt</a></code> authenticator named <code>jwt_auth</code>. With this configuration, it will check if a request contains an <code>Authorization</code> header with a bearer token in JWT format and validate it using key material fetched from the JWKS endpoint. It will reject requests without a valid JWT or create a subject with the <code>sub</code> claim set to the token’s <code>sub</code> value. All other claims will also be added to the subject’s attributes.</td></tr><tr><td><i class=conum data-value=7></i><b>7</b></td><td>Here, we define and configure a <code><a href=../../../docs/mechanisms/authorizers/#_remote>remote</a></code> authorizer named <code>opa</code>. Note how we allow for the overriding of particular settings, which will be specified below when we define the rules.</td></tr><tr><td><i class=conum data-value=8></i><b>8</b></td><td>The following lines define the <code><a href=../../../docs/mechanisms/finalizers/#_jwt>jwt</a></code> finalizer. This configuration will generate a JWT from the subject object with standard claims, setting the <code>sub</code> claim to the subject’s ID. The key material used for signing is pulled from the referenced key store.</td></tr><tr><td><i class=conum data-value=9></i><b>9</b></td><td>These two lines conclude the definition of our mechanisms catalogue and define the <code><a href=../../../docs/mechanisms/finalizers/#_noop>noop</a></code> finalizer, which, as the name implies, does nothing.</td></tr><tr><td><i class=conum data-value=10></i><b>10</b></td><td>With the mechanisms catalogue in place, we can now define a <a href=../../../docs/rules/default_rule/>default rule</a>. This rule will be triggered if no other rule matches the request. It also acts as a <a href=../../../docs/concepts/rules/#_default_rule_inheritance>base</a> for defining regular (upstream service-specific) rules. This rule defines a secure default <a href=../../../docs/concepts/pipelines/#_authentication_authorization_pipeline>authentication & authorization pipeline</a>, which denies any request using the <code>deny_all</code> authenticator. If overridden by a regular rule, it will create a JWT using the <code>jwt</code> finalizer.</td></tr><tr><td><i class=conum data-value=11></i><b>11</b></td><td>The last few lines configure the <a href=../../../docs/rules/providers/#_filesystem><code>file_system</code></a> provider, which allows loading regular rules from the file system. The provider is also configured to watch for changes, so you can modify the rules in real time.</td></tr></tbody></table></div></li><li><p>Create a file named <code>signer.pem</code> with the following content. This file is our key store with a private key, which you’ll see referenced in the configuration above.</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=s>-----BEGIN EC PRIVATE KEY-----</span>
<span class=s>MIGkAgEBBDALv/dRp6zvm6nmozmB/21viwFCUGBoisHz0v8LSRXGiM5aDywLFmMy</span>
<span class=s>1jPnw29tz36gBwYFK4EEACKhZANiAAQgZkUS7PCh5tEXXvZk0LDQ4Xn4LSK+vKkI</span>
<span class=s>zlCZl+oMgud8gacf4uG5ERgju1xdUyfewsXlwepTnWuwhXM7GdnwY5GOxZTwGn3X</span>
<span class=s>XVwR/5tokqFVrFxt/5c1x7VdccF4nNM=</span>
<span class=s>-----END EC PRIVATE KEY-----</span></code></pre></div></div><div class="admonitionblock warning"><table><tbody><tr><td class=icon><i class="fa icon-warning" title=Warning></i></td><td class=content>Do not use this for purposes beyond this tutorial!</td></tr></tbody></table></div></li><li><p>Now, create a rule file named <code>upstream-rules.yaml</code> to implement the authentication and authorization requirements for your service. Copy the following contents into it:</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>version</span><span class=pi>:</span> <span class=s2>&#34;</span><span class=s>1alpha4&#34;</span>
<span class=na>rules</span><span class=pi>:</span>
<span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>demo:public</span>  <i class=conum data-value=1></i><b>(1)</b>
  <span class=na>match</span><span class=pi>:</span>
    <span class=na>routes</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=na>path</span><span class=pi>:</span> <span class=s>/public</span>
  <span class=na>forward_to</span><span class=pi>:</span>
    <span class=na>host</span><span class=pi>:</span> <span class=s>upstream:8081</span>
  <span class=na>execute</span><span class=pi>:</span>
  <span class=pi>-</span> <span class=na>authenticator</span><span class=pi>:</span> <span class=s>anon</span>
  <span class=pi>-</span> <span class=na>finalizer</span><span class=pi>:</span> <span class=s>noop</span>

<span class=pi>-</span> <span class=na>id</span><span class=pi>:</span> <span class=s>demo:protected</span>  <i class=conum data-value=2></i><b>(2)</b>
  <span class=na>match</span><span class=pi>:</span>
    <span class=na>routes</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=na>path</span><span class=pi>:</span> <span class=s>/:user</span>
        <span class=na>path_params</span><span class=pi>:</span>
          <span class=pi>-</span> <span class=na>name</span><span class=pi>:</span> <span class=s>user</span>
            <span class=na>type</span><span class=pi>:</span> <span class=s>glob</span>
            <span class=na>value</span><span class=pi>:</span> <span class=s2>&#34;</span><span class=s>{user,admin}&#34;</span>
  <span class=na>forward_to</span><span class=pi>:</span>
    <span class=na>host</span><span class=pi>:</span> <span class=s>upstream:8081</span>
  <span class=na>execute</span><span class=pi>:</span>
  <span class=pi>-</span> <span class=na>authenticator</span><span class=pi>:</span> <span class=s>jwt_auth</span>
  <span class=pi>-</span> <span class=na>authorizer</span><span class=pi>:</span> <span class=s>opa</span>
    <span class=na>config</span><span class=pi>:</span>
      <span class=na>values</span><span class=pi>:</span>
        <span class=na>policy</span><span class=pi>:</span> <span class=s>demo/can_access</span>
      <span class=na>payload</span><span class=pi>:</span> <span class=pi>|</span>
        <span class=s>{</span>
          <span class=s>&#34;input&#34;: {</span>
            <span class=s>&#34;role&#34;: {{ quote .Subject.Attributes.role }},</span>
            <span class=s>&#34;path&#34;: {{ quote .Request.URL.Path }}</span>
          <span class=s>}</span>
        <span class=s>}</span></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>This rule matches the <code>/public</code> endpoint and forwards the request to our upstream service without performing any verification or transformation.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>This rule matches the <code>/user</code> and <code>/admin</code> endpoints, handling both authentication and authorization steps.<div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>Since we don’t define a finalizer in the second rule’s pipeline, the default rule’s finalizer is reused. There is no need for additional rules, as the default rule will block requests to any other endpoints.</td></tr></tbody></table></div></td></tr></tbody></table></div></li><li><p>Now that everything related to heimdall configuration is in place, let’s create a policy that OPA will use. Create a file named <code>policy.rego</code> with the following contents:</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=rego><span class=ow>package</span> <span class=n>demo</span>

<span class=ow>default</span> <span class=n>can_access</span> <span class=o>=</span> <span class=kc>false</span> <i class=conum data-value=1></i><b>(1)</b>

<span class=n>can_access</span> <span class=p>{</span> <span class=n>split</span><span class=p>(</span><span class=n>input</span><span class=p>.</span><span class=n>path</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)[</span><span class=m>1</span><span class=p>]</span> <span class=o>==</span> <span class=n>input</span><span class=p>.</span><span class=n>role</span> <span class=p>}</span> <i class=conum data-value=2></i><b>(2)</b></code></pre></div></div><div class=paragraph><p>Here, we define our policy <code>can_access</code> within the <code>demo</code> package. The policy is straightforward, evaluating to either true or false.</p></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>By default, the <code>can_access</code> policy evaluates to false.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>It evaluates to true only when the last path fragment of the request matches the user’s role.</td></tr></tbody></table></div></li><li><p>Now, let’s configure NGINX to expose a static endpoint that serves a JWKS document under the <code>.well-known</code> path. This will allow heimdall to verify the JWTs we will use. Create a file named <code>idp.nginx</code> with the following content:</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=bash>worker_processes  1<span class=p>;</span>
user       nginx<span class=p>;</span>
pid        /var/run/nginx.pid<span class=p>;</span>

events <span class=o>{</span>
  worker_connections  1024<span class=p>;</span>
<span class=o>}</span>

http <span class=o>{</span>
    keepalive_timeout  65<span class=p>;</span>

    server <span class=o>{</span>
        listen 8080<span class=p>;</span>

        location /.well-known/jwks <span class=o>{</span>
            default_type  application/json<span class=p>;</span>
            root /var/www/nginx<span class=p>;</span>
            try_files /jwks.json <span class=o>=</span>404<span class=p>;</span>
        <span class=o>}</span>
    <span class=o>}</span>
<span class=o>}</span></code></pre></div></div><div class=paragraph><p>In addition, create a file named <code>jwks.json</code> containing the public key needed to verify the tokens we will use.</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=json><span class=p>{</span><span class=w>
  </span><span class=nl>&#34;keys&#34;</span><span class=p>:</span><span class=w> </span><span class=p>[{</span><span class=w>
    </span><span class=nl>&#34;use&#34;</span><span class=p>:</span><span class=s2>&#34;sig&#34;</span><span class=p>,</span><span class=w>
    </span><span class=nl>&#34;kty&#34;</span><span class=p>:</span><span class=s2>&#34;EC&#34;</span><span class=p>,</span><span class=w>
    </span><span class=nl>&#34;kid&#34;</span><span class=p>:</span><span class=s2>&#34;key-1&#34;</span><span class=p>,</span><span class=w>
    </span><span class=nl>&#34;crv&#34;</span><span class=p>:</span><span class=s2>&#34;P-256&#34;</span><span class=p>,</span><span class=w>
    </span><span class=nl>&#34;alg&#34;</span><span class=p>:</span><span class=s2>&#34;ES256&#34;</span><span class=p>,</span><span class=w>
    </span><span class=nl>&#34;x&#34;</span><span class=p>:</span><span class=s2>&#34;cv6F6SgBSNWMZKdApZXSuPD6QPtvQyMpk-iRfZxT-vo&#34;</span><span class=p>,</span><span class=w>
    </span><span class=nl>&#34;y&#34;</span><span class=p>:</span><span class=s2>&#34;C1r3OClUvyDgmDQdvxMdB-ucmZ28b8s4uM4Yg-0BZZ4&#34;</span><span class=w>
  </span><span class=p>}]</span><span class=w>
</span><span class=p>}</span></code></pre></div></div><div class=paragraph><p>We will place it in the <code>/var/www/nginx</code> folder, as mentioned earlier, when we set up our environment.</p></div></li><li><p>Now, let’s configure the environment. To run <strong>heimdall as a proxy</strong>, create or modify a <code>docker-compose.yaml</code> file. Be sure to update it with the correct paths to your <code>heimdall-config.yaml</code>, <code>upstream-rules.yaml</code>, <code>policy.rego</code>, <code>idp.nginx</code>, and <code>jwks.json</code> files created earlier.</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>services</span><span class=pi>:</span>
  <span class=na>heimdall</span><span class=pi>:</span> <i class=conum data-value=1></i><b>(1)</b>
    <span class=na>image</span><span class=pi>:</span> <span class=s>dadrus/heimdall:{{ github.ref_name }}</span>
    <span class=na>ports</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s2>&#34;</span><span class=s>9090:4456&#34;</span>
    <span class=na>volumes</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s>./heimdall-config.yaml:/etc/heimdall/config.yaml:ro</span>
    <span class=pi>-</span> <span class=s>./upstream-rules.yaml:/etc/heimdall/rules.yaml:ro</span>
    <span class=pi>-</span> <span class=s>./signer.pem:/etc/heimdall/signer.pem:ro</span>
    <span class=na>command</span><span class=pi>:</span> <span class=s>serve proxy -c /etc/heimdall/config.yaml --insecure</span>

  <span class=na>upstream</span><span class=pi>:</span> <i class=conum data-value=2></i><b>(2)</b>
    <span class=na>image</span><span class=pi>:</span> <span class=s>traefik/whoami:latest</span>
    <span class=na>command</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s>--port=8081</span>

  <span class=na>idp</span><span class=pi>:</span> <i class=conum data-value=3></i><b>(3)</b>
    <span class=na>image</span><span class=pi>:</span> <span class=s>nginx:1.25.4</span>
    <span class=na>volumes</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s>./idp.nginx:/etc/nginx/nginx.conf:ro</span>
    <span class=pi>-</span> <span class=s>./jwks.json:/var/www/nginx/jwks.json:ro</span>

  <span class=na>opa</span><span class=pi>:</span> <i class=conum data-value=4></i><b>(4)</b>
    <span class=na>image</span><span class=pi>:</span> <span class=s>openpolicyagent/opa:0.62.1</span>
    <span class=na>command</span><span class=pi>:</span> <span class=s>run --server /etc/opa/policies</span>
    <span class=na>volumes</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s>./policy.rego:/etc/opa/policies/policy.rego:ro</span></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>These lines configure heimdall to use our configuration, key store, and rule file, and to run in proxy operation mode.<div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>We’re using the <code>--insecure</code> flag here to simplify our setup, which disables enforcement of some security settings you can learn about more <a href=../../../docs/operations/security/#_defaults>here</a>.</td></tr></tbody></table></div></td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>Here, we configure the "upstream" service, which, as mentioned earlier, is a simple service that echoes everything it receives.</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>This section configures our NGINX service, which mimics an IDP system and exposes a JWKS endpoint with our key material.</td></tr><tr><td><i class=conum data-value=4></i><b>4</b></td><td>These lines configure our OPA instance to use the authorization policy.</td></tr></tbody></table></div></li><li><p>Alternatively, if you prefer to implement <strong>EAA with heimdall</strong>, create or modify the following <code>docker-compose-eaa.yaml</code> file. Be sure to update it with the correct paths to the <code>heimdall-config.yaml</code>, <code>upstream-rules.yaml</code>, <code>policy.rego</code>, <code>idp.nginx</code>, and <code>jwks.json</code> files from above.</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=yaml><span class=na>services</span><span class=pi>:</span>
  <span class=na>proxy</span><span class=pi>:</span> <i class=conum data-value=1></i><b>(1)</b>
    <span class=na>image</span><span class=pi>:</span> <span class=s>traefik:2.11.0</span>
    <span class=na>ports</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s2>&#34;</span><span class=s>9090:9090&#34;</span>
    <span class=na>command</span><span class=pi>:</span> <span class=pi>&gt;</span>
      <span class=s>--providers.docker=true</span>
      <span class=s>--providers.docker.exposedbydefault=false</span>
      <span class=s>--entryPoints.http.address=&#34;:9090&#34;</span>
      <span class=s>--accesslog --api=true --api.insecure=true</span>
    <span class=na>volumes</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s2>&#34;</span><span class=s>/var/run/docker.sock:/var/run/docker.sock:ro&#34;</span>
    <span class=na>labels</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s>traefik.enable=true</span>
    <span class=pi>-</span> <span class=s>traefik.http.routers.traefik_http.service=api@internal</span>
    <span class=pi>-</span> <span class=s>traefik.http.routers.traefik_http.entrypoints=http</span>
    <span class=pi>-</span> <span class=s>traefik.http.middlewares.heimdall.forwardauth.address=http://heimdall:4456</span>  <i class=conum data-value=2></i><b>(2)</b>
    <span class=pi>-</span> <span class=s>traefik.http.middlewares.heimdall.forwardauth.authResponseHeaders=Authorization</span>

  <span class=na>heimdall</span><span class=pi>:</span>  <i class=conum data-value=3></i><b>(3)</b>
    <span class=na>image</span><span class=pi>:</span> <span class=s>dadrus/heimdall:{{ github.ref_name }}</span>
    <span class=na>volumes</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s>./heimdall-config.yaml:/etc/heimdall/config.yaml:ro</span>
    <span class=pi>-</span> <span class=s>./upstream-rules.yaml:/etc/heimdall/rules.yaml:ro</span>
    <span class=pi>-</span> <span class=s>./signer.pem:/etc/heimdall/signer.pem:ro</span>
    <span class=na>command</span><span class=pi>:</span> <span class=s>serve decision -c /etc/heimdall/config.yaml --insecure</span>

  <span class=na>upstream</span><span class=pi>:</span>  <i class=conum data-value=4></i><b>(4)</b>
    <span class=na>image</span><span class=pi>:</span> <span class=s>traefik/whoami:latest</span>
    <span class=na>command</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s>--port=8081</span>
    <span class=na>labels</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s>traefik.enable=true</span>
    <span class=pi>-</span> <span class=s>traefik.http.services.whoami.loadbalancer.server.port=8081</span>
    <span class=pi>-</span> <span class=s>traefik.http.routers.whoami.rule=PathPrefix(&#34;/&#34;)</span>
    <span class=pi>-</span> <span class=s>traefik.http.routers.whoami.middlewares=heimdall</span>

  <span class=na>idp</span><span class=pi>:</span> <i class=conum data-value=5></i><b>(5)</b>
    <span class=na>image</span><span class=pi>:</span> <span class=s>nginx:1.25.4</span>
    <span class=na>volumes</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s>./idp.nginx:/etc/nginx/nginx.conf:ro</span>
    <span class=pi>-</span> <span class=s>./jwks.json:/var/www/nginx/jwks.json:ro</span>

  <span class=na>opa</span><span class=pi>:</span> <i class=conum data-value=6></i><b>(6)</b>
    <span class=na>image</span><span class=pi>:</span> <span class=s>openpolicyagent/opa:0.62.1</span>
    <span class=na>command</span><span class=pi>:</span> <span class=s>run --server /etc/opa/policies</span>
    <span class=na>volumes</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s>./policy.rego:/etc/opa/policies/policy.rego:ro</span></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>These lines configure Traefik, which is responsible for dispatching incoming requests and forwarding them to heimdall before routing to the target service. We use the ForwardAuth middleware here, which requires additional configuration at the route level.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>Here we configure Traefik to forward requests to heimdall.</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>These lines configure heimdall to use our configuration, key store, and rule file, and to run in decision operation mode.<div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>We’re using the <code>--insecure</code> flag here to simplify our setup, which disables enforcement of some security settings you can learn about more <a href=../../../docs/operations/security/#_defaults>here</a>.</td></tr></tbody></table></div></td></tr><tr><td><i class=conum data-value=4></i><b>4</b></td><td>Here, we configure the "upstream" service. As previously mentioned, it is a very simple service that just echoes back everything it receives. We also need to provide some route-level configuration here to ensure requests are forwarded to heimdall. While we could have used a global configuration, we decided against it to avoid adding another configuration file.</td></tr><tr><td><i class=conum data-value=5></i><b>5</b></td><td>This is our NGINX service, which mimics an IDP system and exposes a JWKS endpoint with our key material.</td></tr><tr><td><i class=conum data-value=6></i><b>6</b></td><td>These lines configure our OPA instance to use the authorization policy.</td></tr></tbody></table></div></li></ol></div></div></div><div class=sect1><h2 id=_start_environment>Start Environment</h2><div class=sectionbody><div class=paragraph><p>Open your terminal and start the services in the directory where the <code>docker-compose.yaml</code> file is located:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=bash><span class=nv>$ </span>docker compose up</code></pre></div></div></div></div><div class=sect1><h2 id=_consume_the_api>Consume the API</h2><div class=sectionbody><div class=paragraph><p>Roll up your sleeves. We’re going to play with our setup now. Open a new terminal window and put it nearby the terminal, you started the environment in. This way you’ll see what is going on in the environment when you use it.</p></div><div class="olist arabic"><ol class=arabic><li><p>Let’s try the <code>/public</code> endpoint first.</p></li></ol></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=bash><span class=nv>$ </span>curl 127.0.0.1:9090/public</code></pre></div></div><div class=paragraph><p>+
You should see an output similar to the one shown below:</p></div><div class=paragraph><p>+</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=bash>Hostname: 94e60bba8498
IP: 127.0.0.1
IP: 172.19.0.3
RemoteAddr: 172.19.0.4:53980
GET /public HTTP/1.1
Host: upstream:8081
User-Agent: curl/8.2.1
Accept: <span class=k>*</span>/<span class=k>*</span>
Accept-Encoding: <span class=nb>gzip
</span>Forwarded: <span class=k>for</span><span class=o>=</span>172.19.0.1<span class=p>;</span><span class=nv>host</span><span class=o>=</span>127.0.0.1:9090<span class=p>;</span><span class=nv>proto</span><span class=o>=</span>http</code></pre></div></div><div class=paragraph><p>+
That was expected, as we sent a request to our public endpoint.</p></div><div class="olist arabic"><ol class=arabic><li><p>Now, let’s try some other endpoints:</p></li></ol></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=bash><span class=nv>$ </span>curl <span class=nt>-v</span> 127.0.0.1:9090/admin</code></pre></div></div><div class=paragraph><p>+
The <code>-v</code> flag is added to the curl command intentionally. Without it, we won’t see the detailed output. With it, you’ll see the response shown below:</p></div><div class=paragraph><p>+</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=bash><span class=k>*</span> processing: 127.0.0.1:9090/admin
<span class=k>*</span>   Trying 127.0.0.1:9090...
<span class=k>*</span> Connected to 127.0.0.1 <span class=o>(</span>127.0.0.1<span class=o>)</span> port 9090
<span class=o>&gt;</span> GET /admin HTTP/1.1
<span class=o>&gt;</span> Host: 127.0.0.1:9090
<span class=o>&gt;</span> User-Agent: curl/8.2.1
<span class=o>&gt;</span> Accept: <span class=k>*</span>/<span class=k>*</span>
<span class=o>&gt;</span>
&lt; HTTP/1.1 401 Unauthorized
&lt; Date: Wed, 06 Mar 2024 16:14:05 GMT
&lt; Content-Length: 0
&lt;
<span class=k>*</span> Connection <span class=c>#0 to host 127.0.0.1 left intact</span></code></pre></div></div><div class=paragraph><p>+
That is, unauthorized. Requests to any endpoint other than <code>/public</code> will result in the same output.</p></div><div class="olist arabic"><ol class=arabic><li><p>Let’s now use a valid JWT to access either the <code>/admin</code> or <code>/user</code> endpoint. Here’s a new request to our <code>/admin</code> endpoint, which includes a bearer token in the <code>Authorization</code> header. This should grant us access:</p></li></ol></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=bash><span class=nv>$ </span>curl <span class=nt>-H</span> <span class=s2>&#34;Authorization: Bearer eyJhbGciOiJFUzI1NiIsImtpZCI6ImtleS0xIiwidHlwIjoiSldUIn0.eyJleHAiOjIwMjUxMDA3NTEsImlhdCI6MTcwOTc0MDc1MSwiaXNzIjoiZGVtb19pc3N1ZXIiLCJqdGkiOiI0NjExZDM5Yy00MzI1LTRhMWYtYjdkOC1iMmYxMTE3NDEyYzAiLCJuYmYiOjE3MDk3NDA3NTEsInJvbGUiOiJhZG1pbiIsInN1YiI6IjEifQ.mZZ_UqC8RVzEKBPZbPs4eP-MkXLK22Q27ZJ34UwJiioFdaYXqYJ4ZsatP0TbpKeNyF83mkrrCGL_pWLFTho7Gg&#34;</span> 127.0.0.1:9090/admin</code></pre></div></div><div class=paragraph><p>+
Now we can access the endpoint and see the following output:</p></div><div class=paragraph><p>+</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=bash>Hostname: 94e60bba8498
IP: 127.0.0.1
IP: 172.19.0.2
RemoteAddr: 172.19.0.4:43688
GET /admin HTTP/1.1
Host: upstream:8081
User-Agent: curl/8.2.1
Accept: <span class=k>*</span>/<span class=k>*</span>
Accept-Encoding: <span class=nb>gzip
</span>Authorization: Bearer eyJhbGciOiJFUzM4NCIsImtpZCI6ImIzNDA3N2ZlNWI5NDczYzBjMmY3NDNmYWQ0MmY3ZDU0YWM3ZTFkN2EiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MTg2MzYwMDAsImlhdCI6MTcxODYzNTcwMCwiaXNzIjoiaGVpbWRhbGwiLCJqdGkiOiIyZjc0MjRmNy05ZWFkLTQ4MzItYmM2Yy0xM2FiNDY5NTNjOTQiLCJuYmYiOjE3MTg2MzU3MDAsInN1YiI6IjEifQ._xy_TRsQpiBPsdGi6gh1IOlyep62YpgxiqquXhg-guVdhpslS4PfVH139dv50GOX0fj3F31q8__8QWWvzPJCEI0aEaaMazIVZ24qjyFM2LJvX0o0ILePxfeDU3bhzN8i
Forwarded: <span class=k>for</span><span class=o>=</span>172.19.0.1<span class=p>;</span><span class=nv>host</span><span class=o>=</span>127.0.0.1:9090<span class=p>;</span><span class=nv>proto</span><span class=o>=</span>http</code></pre></div></div><div class=paragraph><p>+
Take a closer look at the JWT echoed by our service, e.g. by making use of <a href=https://jwt.io>jwt.io</a>. This token has been issued by heimdall, not the one you sent with curl.</p></div><div class="olist arabic"><ol class=arabic><li><p>Now, try the same request to the <code>/user</code> endpoint. It will be refused due to the wrong role. Let’s use a different JWT that should grant us access.</p></li></ol></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=bash><span class=nv>$ </span>curl <span class=nt>-H</span> <span class=s2>&#34;Authorization: Bearer eyJhbGciOiJFUzI1NiIsImtpZCI6ImtleS0xIiwidHlwIjoiSldUIn0.eyJleHAiOjIwMjUxMDA3NTEsImlhdCI6MTcwOTc0MDc1MSwiaXNzIjoiZGVtb19pc3N1ZXIiLCJqdGkiOiIzZmFmNDkxOS0wZjUwLTQ3NGItOGExMy0yOTYzMjEzNThlOTMiLCJuYmYiOjE3MDk3NDA3NTEsInJvbGUiOiJ1c2VyIiwic3ViIjoiMiJ9.W5xCpwsFShS0RpOtrm9vrV2dN6K8pRr5gQnt0kluzLE6oNWFzf7Oot-0YLCPa64Z3XPd7cfGcBiSjrzKZSAj4g&#34;</span> 127.0.0.1:9090/user</code></pre></div></div><div class=paragraph><p>+
This should work now. We omitted the output for brevity, but you should see a successful response.</p></div><div class="olist arabic"><ol class=arabic><li><p>Try sending requests to the <code>/private</code> endpoint using any of the tokens from above. It will fail, as heimdall will not allow access.</p></li></ol></div></div></div><div class=sect1><h2 id=_cleanup>Cleanup</h2><div class=sectionbody><div class=paragraph><p>Once you’re done, stop the environment with <code>CTRL-C</code> and delete the created files. If you started Docker Compose in the background, tear down the environment with:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=bash><span class=nv>$ </span>docker compose down</code></pre></div></div></div></div></linkable-headline-area></div><p class="text-end fst-italic fs-7 pb-3">Last updated on <span class=fw-bold>Apr 8, 2025</span></p><hr><div class="d-flex justify-content-between py-3"><a href=../../../docs/getting_started/installation/ class="fs-6 fw-bold text-dark link-secondary link-underline-opacity-0"><svg width="16" height="16" fill="currentcolor" class="bi bi-chevron-left" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5.0 010 .708L5.707 8l5.647 5.646a.5.5.0 01-.708.708l-6-6a.5.5.0 010-.708l6-6a.5.5.0 01.708.0z"/></svg>
Install heimdall
</a><a class="ms-auto fs-6 fw-bold text-dark link-secondary link-underline-opacity-0" href=../../../docs/concepts/pipelines/>Pipelines<svg width="16" height="16" fill="currentcolor" class="bi bi-chevron-right" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5.0 01.708.0l6 6a.5.5.0 010 .708l-6 6a.5.5.0 01-.708-.708L10.293 8 4.646 2.354a.5.5.0 010-.708z"/></svg></a></div></div></main></div><footer class="footer py-4 py-md-5 px-4 px-md-3 mt-3"><div class=container><div class=row><div class="col-lg-3 mb-3"><p class=fs-5>Heimdall</p><ul class="list-unstyled small text-muted"><li class=mb-2>2022-2024 © Heimdall Project Authors. All rights reserved.</li><li class=mb-2><a href=https://github.com/dadrus/heimdall/blob/master/LICENSE>Apache 2.0 licensed</a></li></ul></div><div class="col-6 col-lg-2 offset-lg-1 mb-3"><h5>Links</h5><ul class=list-unstyled><li class=mb-2><a href=../../../>Home</a></li><li class=mb-2><a href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=mb-2><a href=../../../guides/>Guides</a></li><li class=mb-2><a href=../../../openapi/>API</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Guides</h5><ul class=list-unstyled><li class=mb-2><a href=../../../guides/proxies/>API Gateways & Proxies</a></li><li class=mb-2><a href=../../../guides/authz/>Authorization Services</a></li><li class=mb-2><a href=../../../guides/authn/>Authentication Protocols & Services</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Community</h5><ul class=list-unstyled><li class=mb-2><a href=https://github.com/dadrus/heimdall>Github</a></li><li class=mb-2><a href=https://discord.gg/qQgg8xKuyb>Discord</a></li></ul></div></div></div></footer><script src=../../../js/main.js defer></script></body></html>