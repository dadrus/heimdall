suite: test suite for service account configuration
templates:
  - serviceaccount.yaml
tests:
  - it: should create service account config and related objects
    asserts:
      - hasDocuments:
          count: 4
      - containsDocument:
          apiVersion: v1
          kind: ServiceAccount
        documentIndex: 0
      - containsDocument:
          apiVersion: v1
          kind: Secret
        documentIndex: 1
      - containsDocument:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
        documentIndex: 2
      - containsDocument:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
        documentIndex: 3

  - it: should set a default name for the service account
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-heimdall
        documentIndex: 0

  - it: name for the service account should be set with overwritten name
    release:
      name: test-release
    set:
      nameOverride: foo
    asserts:
      - equal:
          path: metadata.name
          value: test-release-foo
        documentIndex: 0

  - it: should set a default name for the account toke secret
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-heimdall-account-token
        documentIndex: 1

  - it: name for the account toke secret should be set with overwritten name
    release:
      name: test-release
    set:
      nameOverride: foo
    asserts:
      - equal:
          path: metadata.name
          value: test-release-foo-account-token
        documentIndex: 1

  - it: should set a default name for the cluster role
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-heimdall-ruleset-accessor
        documentIndex: 2

  - it: name for the cluster role should be set with overwritten name
    release:
      name: test-release
    set:
      nameOverride: foo
    asserts:
      - equal:
          path: metadata.name
          value: test-release-foo-ruleset-accessor
        documentIndex: 2

  - it: should set a default name for the cluster role binding
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-heimdall-ruleset-accessor
        documentIndex: 3

  - it: name for the cluster role binding should be set with overwritten name
    release:
      name: test-release
    set:
      nameOverride: foo
    asserts:
      - equal:
          path: metadata.name
          value: test-release-foo-ruleset-accessor
        documentIndex: 3

  - it: should set namespace for all configuration objects
    release:
      namespace: test-namespace
    asserts:
      - equal:
          path: metadata.namespace
          value: test-namespace

  - it: should set default labels with default values for all configuration objects
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: heimdall
            app.kubernetes.io/version: latest
      - matchRegex:
          path: metadata.labels["helm.sh/chart"]
          pattern: heimdall-*

